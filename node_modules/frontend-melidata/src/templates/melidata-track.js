const sanitizer = require('xss');

function getSendTrackCode(track) {
  return `
melidata("add", "event_data", ${sanitizer(JSON.stringify(track.event_data))});
melidata("send", "${track.type}", {
  path: "${track.path}",
  data: {}
}, "${track.stream_name}");`;
}

function template(data) {
  const {
    track, scriptURL, pixelUrl, completeTrackFunction, nonceCSP,
  } = data;

  if (!track.isJavascript) {
    const trackObj = encodeURIComponent(JSON.stringify({ tracks: [track.toMap()] }));
    return `<img src="${pixelUrl}?q=${trackObj}" />`;
  }

  const nonceCSPScriptTag = nonceCSP ? `nonce='${nonceCSP}'` : '';
  let out = '';

  out += `
(function(w, r) {
  w[r] = w[r] || function() {
    (w[r].q = w[r].q || []).push(arguments)
  }
})(window,'melidata');`;
  out += `
(function(d,u) {
  if (!document.getElementById("MelidataIframe")) {
    var i = d.createElement('iframe');
    (i.frameElement || i).style.cssText = "width: 0; height: 0; border: 0; position: absolute";
    i.src = "about:srcdoc";
    i.srcdoc="\\<script\\ ${nonceCSPScriptTag} src='" + u + "'>\\</script\\>";
    i.id = "MelidataIframe";
    var t = d.getElementsByTagName('script')[0];
    t.parentNode.insertBefore(i, t);
    var doc = i.contentWindow.document;
    var script = doc.createElement('script');
    script.type = 'text/javascript';
    script.text ='window.inDapIF = true;';
    doc.documentElement.appendChild(script);
  } else {
    // This page is charged async via AJAX and inserted into another one who has
    // already download melidata js lib => Just clean the track
    melidata("clean");
  }
})(document,'${scriptURL}');

melidata("add", "id", "${track.id}");
melidata("add", "server_id", "${track.id}" );
melidata("add", "application", ${sanitizer(JSON.stringify(track.application))});
melidata("add", "user", ${sanitizer(JSON.stringify(track.user))});
melidata("add", "device", ${sanitizer(JSON.stringify(track.device))});
melidata("add", "platform", ${sanitizer(JSON.stringify(track.platform))});`;

  if (track.hasExperiments()) {
    out += `
melidata("add", "experiments", ${sanitizer(JSON.stringify(track.getPlainExperiments()))});
melidata("add", "experiments_timestamp", "${track.lastExperimentsTimeStamp}");`;
  }

  if (completeTrackFunction) {
    out += `
if (typeof window['${completeTrackFunction}'] === 'function') {
  window['${completeTrackFunction}']();
}`;
  }
  if (!track.isDeferred) {
    out += getSendTrackCode(track);
  }

  return `<script ${nonceCSPScriptTag} >${out}</script>`;
}

module.exports = template;
