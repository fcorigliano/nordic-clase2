# Frontend Melidata

> Melidata SDK for Node.js

## Installation

```bash
npm i -S frontend-melidata
```

## Usage

### Sample App

For a live version of this code you can check our [Nordic sample App](https://github.com/mercadolibre/fury_melidata-nordic-sample-app) or there is a [simple node app](./sample-app) sample at this same repo for playground purposes.

### General usage

The main goal of the module is to render the tracking code for client-side.

```js
const Melidata = require('frontend-melidata');

// Initialize the Melidata for current request
const melidata = new Melidata(req);

// Get the Melidata tracking code for specified path and some useful data
const trackingCode = melidata.track({
  path: '/home',
  event_data: { carousels: 5 }
});
```

The code above will generate a tracking code that can be used with any
 render engine. It will contain a Javascript code including a `<script/>`
 tag for normal devices or a "pixel" image with all the data in query string
 for low-end devices.

Only `path` is required, all other data like an `application`, `user` or
 `device` will be fetched from the request object. `event_data` is a place
 for the custom data that should be stored on Melidata servers.

Please see the [official Melidata Wiki](https://github.com/mercadolibre/melidata-all/wiki)
 for more information about usage on client-side and a functionality that
 is out of range of this module.

### Usage inside the views written in React

Melidata script can be configured inside the React components.
```jsx
const MelidataTrack = require('frontend-melidata/melidata-track');

const DemoView = (props) => (
  <MelidataTrack path="/vip/item" event_data={props.event_data} />
);
```

Since the tracking code can be configured only on the server-side for
 some reasons the `MelidataTrack` component should be rendered on the
 server. In this way the attributes will be used as a config for the tracking
 object. To simplify the rendering of the tracking object from React components
 there is a `bundle` helper.

```jsx
const ReactDOMServer = require('react-dom/server');
const MelidataTrack = require('frontend-melidata/melidata-track');
const bundleMelidata = require('frontend-melidata/bundle');

// Render the app and its components that can contain the config data
const html = ReactDOMServer.renderToStaticMarkup(App);

// Obtain the Melidata config from React components and get the tracking code
const melidataScript = bundleMelidata(req, MelidataTrack);
```

> Be aware that in [Nordic Apps](https://github.com/mercadolibre/frontend-nordic/) **without custom layouts**, the minimal required implementation for this component is already done by [frontend-layout](https://github.com/mercadolibre/frontend-layout) and in most cases you will only need to make use of the component without taking care of how and where to render the final code.

### WebViews - Mobile context

If your application is serving a webview for an app that uses the mobileWebKit and compiles our melidata native sdk (Mercadolibre, mercadopago on both android/ios for sure, and probably others), the sending of due tracks will not take place on the client’s javascript, but inside the native application itself. Your path, event_data and fragment will remain unchanged.
This integration may bring some changes to your track, such as:
* Platform will be: /mobile/(android/ios ) as sent from the app
* It will be marked as sent_from_webview

For more information, feel free to review its [web component](https://github.com/mercadolibre/fury_melidata-js-sdk/blob/master/js/lib/sender.js#L100) and its [mobile component](https://github.com/mercadolibre/fury_ui-components-ios/blob/master/LibraryComponents/MLWebKit/Classes/CommandExecutors/MLUICWebViewMelidataCommand.m#L41)


## Configuration

Melidata module can be configured trough the [frontend-config](https://github.com/mercadolibre/frontend-config).
 Just create a section `melidata` for respective environment and Melidata will take it.

### Melidata automatic updates configuration

- `melidata.reloadClientJS.isEnabled` - Enables the Melidata script reload service. Default: `NODE_ENV === 'production'`
- `melidata.reloadClientJS.configURL` - Remote configuration file distributed by Melidata team. Default: `http://internal.mercadolibre.com/melidata-js-sdk/static/js/3/last/config.properties`
- `melidata.reloadClientJS.reloadInterval` - Script reload interval in millis. Default: `60000`
- `melidata.reloadClientJS.scriptURL` - Location of the Melidata client script.
- `melidata.reloadClientJS.scriptURLSSL` - Secure location of the Melidata client script.
- `melidata.reloadClientJS.pixelURL` - The URL of the pixel that will be used for data registering on low-end devices. Default: `//api.mercadolibre.com/pixel.gif`
- `melidata.server_tracking.post` - Do post server side. Default: `NODE_ENV === 'production'`
- `melidata.metrics.DDEnabled` - Enables sending relevant Melidata custom metrics to DataDog. Default: `false`
- `melidata.endpoint` - Endpoint for Melidata API posting (server side)

### Melidata experiments configuration

- `melidata.client.allPlatforms` - Fetch the experiments for all platforms. Default: `false`
- `melidata.client.platform` - A name of the platform to fetch the experiments for. Default: `"web"`
- `melidata.client.department` - A name of the department to fetch the experiments for. Default: `null`

## Tracks catalog

Every track before it can be used should be registered in Melidata catalog. Please see
 [how to add a new track](https://github.com/mercadolibre/melidata-catalog/wiki/New-Track)
 in the official catalog documentation.

## Tracks validation

In development environment every track is validated by using the Melidata validation API.
 It helps in detecting the possible configuration or typo errors. To disable the tracks
 validation, set the environment variable `MELIDATA_LEVEL` with a value `OFF`. Validation
 depends on the definitions in the catalog.

## Experiments

### Experiments testing

The selection of a variant stays on the complex algorithm, and once a variant is selected
 it is used for all consecutive requests. To choose a specific variant manually there are two
 ways:
 - The easiest way is to pass a variant name and value through a query string. For example, if
  the full name of experiment is `core/experiment` and you want to see a variant with an ID
  `123` the final query will look like `variant_core/experiment=123`
 - An alternative is using a cookie. It can be useful when you want to maintain a chosen variant
  while navigating. A cookie has the same logic as the example from above: just create
  a cookie with name `variant_core/experiment` and put `123` as its value.


### Experiments in development and testing

All experiments related to your app should be manually mocked in environments `development` and `test`.
 The recommended way is by defining raw experiments' data inside the application `config` under the
 `melidata.experiments` key. Just put the data in a config file corresponding to your current environment, it may be 
 `./config/default-development.{js|json}` o just `./config/development.{js|json}` and
 `./config/default-test.{js|json}` o just `./config/test.{js|json}` for `development` and `test`
 respectively.

A typical experiment is an object with the next schema:

```js
{
  id: 1, // ID of experiment, must be unique
  name: 'exp_1', // name of an experiment, must be unique
  path: '/search', // path of an experiment as it defined in catalog for your app
  variants: [ // list of available variants
    {
      id: 10, // ID of a variant, should be unique at least for the current experiment
      exposure: .2, // percentage of the distribution, the sum of all exposures of the current experiment must be 1
      configuration: { // configuration of each variant as it defined in Melidata dashboard
        color: 'blue',
      },
      exposure_configuration: [
          {
              id: 1, // ID of a exposure configuration, should be unique at least for the current experiment
              key: 'MLA', // Override key.[*]
              exposure: .1, // percentage of the distribution, the sum of all exposures of the current experiment must be 1
          },
          {
              id: 2,
              key: 'MLA-/web/desktop',
              exposure: .5,
          }
      ]
    },
  ]
}
```
[*]: Exposure configurations. The key for the exposure configurations can be of 3 different types: site (`MLA`, `MLB`, ...), platform (`/web/mobile`, `/web/desktop`, `/mobile/android` and `/mobile/ios`) or the combination of both concatenated with `-` (Ej: `MLA-/web/desktop`).
One experiment can only have site or platform keys. There cannot be an override for site MLA and platform /web/desktop at the same time. For these cases you can use the combination of both concatenated with `-`.

The simplified format of your config file may look like:

```js
module.exports = {
  melidata: {
    experiments: [
      Experiment1,
      Experiment2,
      ...,
    ],
  },
};

```

In cases where the experiments' data is the same for both environments you can create a common config for experiments, for
 example `./config/melidata.js`, and require it from `./config/development.js` and `./config/test.js`.

Additionally, you can startup your app with the melidata library in production mode ( actually retrieving real experiments created in melidata.ml.com) by just using the ``export MELIDATA_SDK_PRODUCTION='true'`` env variable before starting process.

### Experiments usage

To fetch the experiment data for the current request you should use the `ExperimentService`.
Since this method is async the best place to get the data is a middleware:

```js
const ExperimentService = require('frontend-melidata/src/services/experiment');
const experimentService = new ExperimentService();

router.get('/', (req, res) => {
  const value = experimentService.getConfig(req, 'experiment/name', 'default value');
  // In cases where there is more than one configuration in the same experiment, please indicate the config key explicitly
  //   const value = experimentService.getConfig(req, 'experiment/name', 'default value', 'config_key');

  // Render the page by passing the fetched value as props
  res.render(PageComponent, {
    experiments: {
        'experiment/name': value,
    },
    ...
  });
});
```

For [multilayer experiments](https://docs.google.com/document/d/10_e9EtQoA1K4tzjL85caId1vEQS0i5Ro-99-vhSh_zc/edit#heading=h.766xq4rarvv5):
```js
const ExperimentService = require('frontend-melidata/src/services/experiment');
const experimentService = new ExperimentService();

router.get('/', (req, res) => {
  const experimentConfiguration = experimentService.getExperimentConfiguration('experiment/name', req);
  

  // You can get all the experiment configuration values from the ExperimentConfiguration object
  const configValue = experimentConfiguration.getConfig('config_key', 'default_value');
  
  // You can get the data to track from the ExperimentConfiguratoin object
  const experimentName = experimentConfiguration.getExperimentName();
  const variantId = experimentConfiguration.getVariantId();
  
  //   const value = experimentService.getConfig(req, 'experiment/name', 'default value', 'config_key');


  res.send({
    experiments: {
        'experiment/name': variantId,
    },
    ...
  });
});
```

*Note*: `ExperimentService` has no direct calls to experiments API, all the interactions are
  realized through the caching layer. While the cache is updating, the very first requests can
  contain the default value instead of the real one. But this is OK and expected; default results are not
  affecting the statistics.

Later this value can be used as any other variable to decide what to do.
```jsx
render() {
  const autofocus = this.props.experiments['experiment/name'] === 'on' ? 'autofocus' : null;

  return <input type="search" {autofocus} />;
}
```

Client-side Melidata script will send automatically the experiment related data, including
 the selected variant that is used in a page.


## Tip
If your application has good coverage on [headers propagation](https://docs.google.com/presentation/d/1gMcbXOquvClTrUtpXQ9n6NoaZTZ7JDhyNIV7GpUKMe8/edit?pli=1#slide=id.p) we highly recommend you use the "getExperimentConfigurationByRequest" method.
That way the setting of the site and platform is done automatically! You can get your experiment just using the request. How can I know if my app has good coverage? There are two options:
* Run [this query](http://alation.ml.com/query/812285/), to check your application’s coverage for the selected date and time.
* You can check [this Tableau Dashboard](https://tableau.adminml.com/t/MeliLake/views/melidata_header_propagation/headerpropagationdashboard?:showAppBanner=false&:origin=viz_share_link&:display_count=n&:showVizHome=n), select your app in application_to to check the coverage over time.

Be mindful that any coverage below 100% might result in defaults.
 
### Experiments advanced usage
If you wish to make use of Audiences for determining the applicable variant, set the following environment variable. In addition, since the Audiences API will be used, you must use the async version of the methods: `getConfigAsync`, `getConfigBySeedAsync` and `getVariantAsync`. Otherwise you will get a default variant.

 Be aware that this will imply an increase in CPU usage and response time, since the Audiences API will be called when 'true' and any experiment for your application has an audience set.
 ([See more](https://docs.google.com/document/d/1yngXas8F2_r32QuVIhxf2f1nk5TjYjgN5YrItZLZ3Gs/edit))

     export MELIDATA_USE_AUDIENCES_INTEGRATION=true

> **Caution**: any results/conclusions derived from an experiment with audiences are only valid for the linked audiences. So, when terminating an experiment
with linked audiences, it is necessary to apply any future changes considering only those linked audiences, therefore, having to integrate with audiences to define the participation.

 ## Release Instructions

1. Modify package.json and CHANGELOG.md including changes

```bash
npm version [major | minor | patch | prerelease [--preid=<prerelease-id>] ]
```

2. Create version will upload to registry automatically. Please consider 
```bash
fury create-version
```

3. Email frontendcore@ with new tagged version for making it into nordic release. Please consider including released PRs also in the [releases section](https://github.com/mercadolibre/fury_frontend-melidata/releases) together with changelog.

_Hint:_ If the new release uses a new endpoint, add that information to the mail so the new endpoint can be catalogued on the `nordic` access group of Fury's Traffic Catalog.

_Hint:_ If the version released it's a test-version consider the following nomeclature which helps generating better traceability and favours nordic [beta-releases management](http://nordic.adminml.com/docs/releases#mi%C3%A9rcoles):

```x.y.z-test-${fix}>.N```

i.e: ```4.4.0-test-security-key.0 ```; ``` 4.4.0-test-security-key.1 ```


## License

© Mercado Libre 2017.
