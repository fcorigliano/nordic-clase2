/**
 * Module dependencies
 */
const feConfig = require('frontend-config');
const { CDNS } = require('../../config/head-config');

/**
 * Make preconnect links for a given url.
 */
const makeLink = (url) => `<link rel="preconnect" href="${url}"/>`;
const makeAnalyticsLink = (url) => `<link rel="preconnect" href="https://analytics.${url}"/>`;

/**
 * Return the domain name of a given url.
 */
const getDomainName = (url) => {
  try {
    return url.split('.')[0];
  } catch (e) {
    return 'mercadolibre';
  }
};

/**
 * Preconnects Links
 */
const preconnects = [
  'https://www.google-analytics.com',
  'https://www.google.com',
  'https://data.mercadolibre.com',
  CDNS.default.link,
].map(makeLink).join('');

/**
 * Add preconnect for new users of Google Analytics
 * @see https://github.com/mercadolibre/commons-frontend/blob/f59c4bd8ee35d30f79d6670acaef71b2d8851a38/plugin/grails-app/views/layouts/base.gsp#L15-L17
 * @see https://github.com/mercadolibre/commons-frontend/blob/f59c4bd8ee35d30f79d6670acaef71b2d8851a38/plugin/grails-app/views/layouts/base.gsp#L19
 */
const firstTimeGA = (cookies, platform, feConfigEnvironment) => {
  const preconnectLinks = [];
  const cookieCI = cookies[`_${platform.id.toLowerCase()}_ci`];
  const cookieGA = cookies[`_${platform.id.toLowerCase()}_ga`];

  if (!cookieCI) {
    preconnectLinks.push(makeLink('https://stats.g.doubleclick.net'));
  }

  if (!cookieGA) {
    const currentMainDomain = feConfig.get('url.mainDomain.link', platform.id, platform.siteId, feConfigEnvironment);
    preconnectLinks.push(
      makeAnalyticsLink(currentMainDomain),
      makeAnalyticsLink(`${getDomainName(currentMainDomain)}.com`),
    );
    // We must add a preconnect to mercadoli(b|v)re.com when the platform is not ML.
    if (platform.id !== 'ML') {
      const mainDomainML = feConfig.get('url.mainDomain.link', 'ML', platform.siteId, feConfigEnvironment);
      preconnectLinks.push(makeAnalyticsLink(`${getDomainName(mainDomainML)}.com`));
    }
  }

  return preconnectLinks.join('');
};

/**
 * Detects is the Google Analytics Audience plugin has already been loaded and data has been collected
 * @param cookies {object} A list of parsed request cookies
 * @param countryId {string} A country code in ISO 3166 format
 * @see https://developers.google.com/analytics/devguides/collection/analyticsjs/display-features#changing-the-cookie-name for cookie name information
 * @return {string}
 */
const firstTimeGAAudience = (cookies, countryId) => {
  if (!countryId || cookies._gat) { // eslint-disable-line no-underscore-dangle
    return '';
  }

  const cid = countryId.toLowerCase();
  return makeLink(`https://www.google.${['CL', 'PT'].indexOf(countryId) === -1 ? 'com.' : ''}${cid}`);
};

module.exports = function getPreconnects(cookies, platform, cdns, feConfigEnvironment) {
  const customCDNPreconnect = cdns && Array.isArray(cdns) ? cdns.map((cdn) => (cdn && cdn.link && cdn.link !== CDNS.default.link ? makeLink(cdn.link) : '')) : [];

  return [
    preconnects,
    ...customCDNPreconnect,
    firstTimeGA(cookies, platform, feConfigEnvironment),
    firstTimeGAAudience(cookies, platform.countryId),
  ].join('');
};
