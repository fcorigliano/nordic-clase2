const env = require('frontend-env');

function matchInArray(string, expressions) {
  const len = expressions.length;
  let i = 0;

  for (; i < len; i += 1) {
    if (string.match(expressions[i])) {
      return true;
    }
  }
  return false;
}

function isAvailablePath(serverName, baseUrl, a2hsAvailablePaths) {
  return !env.FURY || (
    serverName.startsWith('www.')
    && a2hsAvailablePaths
    && matchInArray(baseUrl, a2hsAvailablePaths)
  );
}

function offerA2HS(req, config) {
  /* eslint-disable no-underscore-dangle */
  if (req.browser.support.serviceWorkers
    && req.device.mobile
    && !req.device.lowEnd
    && !config.configSchema.cleanServiceWorkers
    && req._parsedOriginalUrl
  ) {
    return isAvailablePath(req.hostname, req._parsedOriginalUrl.pathname, config.configSchema.a2hsAvailablePaths);
  }
  /* eslint-enable no-underscore-dangle */

  return false;
}

exports.offerA2HS = offerA2HS;
