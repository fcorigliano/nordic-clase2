const fs = require('fs');
const { join } = require('path');
const { DEVELOPMENT } = require('frontend-env');
const getInjectedScripts = require('../get-injected-scripts');
const { initiatives } = require('../../constants/perfill');

const cookieMonkeyPatchCode = fs.readFileSync(join(__dirname, '../../../lib/client/client-cookies-manager.js')).toString();

const getClientCookiesManagerCode = ({ perfill }, { isLowEnd, nonceCSP }) => {
  try {
    if (!perfill || !perfill.initiatives || !perfill.initiatives.some((initiative) => initiative.id === initiatives.CLIENT_COOKIES)) {
      return '';
    }

    return getInjectedScripts({
      inline: `(function(){${cookieMonkeyPatchCode}\nclientCookiesManager()})()`,
      lowEnd: isLowEnd,
      nonce: nonceCSP,
    });
  } catch (e) {
    return '';
  }
};

const getCode = DEVELOPMENT
  ? () => ''
  : getClientCookiesManagerCode;

module.exports = {
  getCode,
};
