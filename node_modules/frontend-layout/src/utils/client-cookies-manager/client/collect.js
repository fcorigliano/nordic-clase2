/* eslint-disable no-undef */

const getPerfillAgentObject = () => {
  const perfillAgentKey = '_perfill';
  window[perfillAgentKey] = window[perfillAgentKey] || function (...args) { (window[perfillAgentKey].q = window[perfillAgentKey].q || []).push(args); };

  return window[perfillAgentKey];
};

const maskValue = (cookieValue) => {
  if (typeof cookieValue !== 'string') {
    return null;
  }

  const parts = cookieValue
    .split(';');

  const firstKeyValue = parts[0].split('=');

  const metadataParts = parts.slice(1);

  // Remove cookie value if there is one
  return !firstKeyValue[1]
    ? cookieValue
    : `${firstKeyValue[0]}=${metadataParts.length ? ';' : ''}${metadataParts.join(';')}`;
};

const collectCookieData = (cookieValue) => {
  try {
    const data = maskValue(cookieValue);

    if (!data) {
      return;
    }

    const perfillAgent = getPerfillAgentObject();

    perfillAgent('queue', 'client-cookies', {
      type: 'set-cookie',
      data,
    });
  } catch (e) {} // eslint-disable-line no-empty
};

module.exports = {
  collectCookieData,
};
