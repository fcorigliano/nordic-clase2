const { base } = require('../data');
const { getCode: getClientCookiesManagerCode } = require('../../client-cookies-manager');
const getCSRFMeta = require('../../get-csrf-meta');
const defaultMetaTags = require('../../../constants/default-meta-tags');
const { mapMetaTagsConfig } = require('../../meta-tags');

const layout = ({
  app,
  initialState,
  headsync = '',
  styles,
  countryId,
  scripts,
  lowEnd,
  nonceCSP,
  csrfToken,
  props,
  chunkExtractor,
  metaTagsConfig,
}) => {
  const { lang, initialStateSnippet, injectedScripts } = base({
    initialState,
    countryId,
    scripts,
    lowEnd,
    nonceCSP,
    lang: props.lang,
  });

  const clientCookiesManagerCode = getClientCookiesManagerCode(props, {
    isLowEnd: lowEnd,
    nonceCSP,
  });
  const csrfTokenTag = getCSRFMeta(csrfToken);
  const requireChunksScriptTag = chunkExtractor ? chunkExtractor.getRequiredChunksScriptTag() : '';

  const langAttribute = lang ? ` lang="${lang}"` : '';
  const metaTagsString = mapMetaTagsConfig((metaTagsConfig || {}).none || defaultMetaTags.none);

  return (`
<!DOCTYPE html><html${langAttribute}>
<head>${clientCookiesManagerCode}${requireChunksScriptTag}${metaTagsString}${csrfTokenTag}${headsync}${initialStateSnippet}${styles}</head>
<body><div id="app-content">${app}</div>${injectedScripts}</body></html>`
  );
};

module.exports = layout;
