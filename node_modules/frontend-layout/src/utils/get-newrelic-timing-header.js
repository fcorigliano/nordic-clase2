const config = require('frontend-config');
const env = require('frontend-env');

let newrelic;
if (env.PRODUCTION) {
  try {
    newrelic = require('newrelic'); // eslint-disable-line global-require
  } catch (err) {
    // If for any reason newrelic is not installed as a peer dependency define a stub
    newrelic = {
      getBrowserTimingHeader() {
        return '';
      },
    };
  }
}

/**
 * Get Newrelic code for the browser
 * Returns an empty string in any environment different to `production`
 *
 * @param {object} req Request object with platform defined
 * @return {string}
 */
module.exports = async function getNewrelicTimingHeader(platform, nonceCSP, feConfigEnvironment, meliCookies) {
  const hasUserConsent = meliCookies ? await meliCookies.userConsentCookieCategory('traceability') : false;
  if (hasUserConsent === false || !env.PRODUCTION || !platform) {
    return '';
  }

  const defaultRumPercentage = config.get('rum.percentage', null, null, feConfigEnvironment);

  const rumPercentage = defaultRumPercentage === undefined
    ? config.get('rum.percentage', platform.id, platform.siteId, feConfigEnvironment) : defaultRumPercentage;

  // Use Math.floor to disable the code generation by using `0` value
  return Math.floor(Math.random() * 100) < Number(rumPercentage)
    ? newrelic.getBrowserTimingHeader({ nonce: nonceCSP })
    : '';
};
