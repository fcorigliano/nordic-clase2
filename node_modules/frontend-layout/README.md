# Frontend Layout

> A React component (server side) with common layout for meli web apps.

## Description

This middleware provides a `res.render` method to enable server-side rendering for React applications. The application markup will be wrapped by markup that provides common functionality (eg: `html` and `head` tags, navigation header and footer, metrics tracking, etc).

## Installation
**This package comes with [Nordic](https://github.com/mercadolibre/frontend-nordic/tree/master/packages/nordic) under the namespace `nordic/layout`**, so if you are using Nordic you already installed it!.

If you are **not using Nordic**, you can install `frontend-layout` this way:

```sh
npm install frontend-layout
```

## Usage
```js
const React = require('react');
const router = require('nordic/ragnar').router();
const { layoutMiddleware } = require('nordic/layout');

const Page = props => (
  <div id="Page">
    <h1>My Page Component</h1>
    <p>Query: {props.data}</p>
  </div>
);

router.use(layoutMiddleware());

router.get('/', function(req, res) {
  const appProps = {
    data: req.query.data,
  };
  const renderOptions = {
    layoutOptions: {
      staticMarkup: true,
    },
  };
  res.render(Page, appProps, renderOptions);
});
```

The resulting HTML page for the `?data=Iphone` query string will be:
```html
<!DOCTYPE html>
<html>
  <head>
    ...
  </head>
  <body>
    <main>
      <div id="page">
        <h1>My Page Component</h1>
        <p>Query: Iphone</p>
      </div>
    </main>
  </body>
</html>
```

### Middleware options
| Name | Description | Type | Default | Required |
| --- | --- | --- | --- | --- |
| `layout` | Layout to render. This layout will render the `body` tag wrapping the application component passed to `res.render`  | Function - React.Component | *[Default layout component](https://github.com/mercadolibre/fury_frontend-layout/blob/master/src/layout.js)* |  |
| `navigation` | Navigation to be rendered by the layout component (prop `Navigation`) | Function - React.Component | *Please read [Navigation component](#navigation-component)* |  |

#### Layout component
This component should render a `body` tag, the produced markup will be wrapped in an `html` tag, and will be sibling of a `head` tag rendered before the `body` one.

You can find the default layout component [here](https://github.com/mercadolibre/fury_frontend-layout/blob/master/src/layout.js). If you want to use a custom one please make sure the component renders the following placeholder strings:
- `{{children}}` that will be replaced with the application content
- `{{melidata}}` that will be replaced with the melidata content
- `{{scripts}}` that will be replaced with scripts content

Example:
```js
const React = require('react');
const router = require('nordic/ragnar').router();
const { layoutMiddleware } = require('nordic/layout');
const Head = require('react-declarative-head');

const layout = props => (
  <body>
    <Head>
      <title>My Custom Layout</title>
    </Head>

    {
      props.isMobile && ( // Mobile only menu
        <nav>
          <ul>
            <li>Item 1</li>
            <li>Item 2</li>
          </ul>
        </nav>
      )
    }

    <main id="root-app">
      {'{{children}}'}
    </main>

    {'{{melidata}}'}
    {'{{scripts}}'}
  </body>
);

// Add custom async logic using prepareToRender() method
layout.prepareToRender = (props, req, res) => Promise.resolve({
  isMobile: req.device.mobile
});

router.use(layoutMiddleware({ layout }));

router.get('/', function(req, res) {
  res.render(Page, {
    data: req.query.data,
  });
});
```

#### Navigation component
This component will receive the application component as children and should render the navigation (eg: header, footer, aside, etc) wrapping the application component.

If you do not pass either the `navigation` property to the middleware or the `navigationId` property to the `res.render` method (explained later), the [navigation factory](https://github.com/mercadolibre/fury_frontend-navigations/tree/master/modules/factory) will try to render the best navigation based on request data (eg: platform, site, etc).

### res.render
This method allows to render an application React component. It receives three parameters: application component, application properties, and render options.

```jsx
const App = props => <div>Hello {props.userName}!!!</div>;

const appProps = { userName: 'Clark Kent' };

const renderOptions = {
  layoutOptions: {
    lang: 'zh' // chinese
  },
};

res.render(App, appProps, renderOptions);
```


#### Application component
The application component should render the application-specific content. That is, for example, whatever content in between the marketplace header and footer.

![Screen Shot 2020-06-17 at 15 26 21 (1)](https://user-images.githubusercontent.com/4377470/84936028-000ff580-b0b0-11ea-982e-bd0a7457e49b.png)

#### Application properties
These properties will be passed to the application in its rendering phase, here you should pass any prop that your application needs to render the markup.

#### Render options
Options to be passed to the render method. Here is a full list of options, below the list you can find a detailed explanation of each option with use examples:

| Name | Description | Type | Default | Required |
| --- | --- | --- | --- | --- |
| `done` |  Calls this function with the content instead of returning it as the response payload. | Function | `null` |  |
| `layoutOptions` | Options to configure the middleware rendering. | Object | `null` |  |
| `layoutOptions.lang` | Determines the html document language. | String | *Please read [lang](#lang)*. |  |
| `layoutOptions.favicons` | Array of favicons to render. | Array[FaviconConfiguration] | *Please read [favicons](#favicons)*. |  |
| `layoutOptions.favicons[X].href` | Favicon URL. | String | | ✅ |
| `layoutOptions.favicons[X].type` | Favicon MIME type. | String | `null` | |
| `layoutOptions.favicons[X].rel` | Favicon relationship. | String | `'shortcut icon'` | |
| `layoutOptions.favicons[X].sizes` | Favicon sizes. | String | `null` | |
| `layoutOptions.embedCss` | Embeds navigation styles into the `head` tag. | Boolean | `false` |  |
| `layoutOptions.externalCss` | Array of external CSS to load with a `link` tags. | Array[String] | `[]` |  |
| `layoutOptions.inlineCss` | Array of inline CSS to load with a `style` tags. | Array[String] | `[]` |  |
| `layoutOptions.scripts` | Array of scripts external URLs to load with `script` tags. | Array[String] | `[]` |  |
| `layoutOptions.staticMarkup` | Determines if render to string or to static markup (without React data attributes) | Boolean | `false` |  |
| `layoutOptions.performanceStats` | Collects render performance stats for every render. The stats info is an object that contains the name of the `page` and the `duration` in milliseconds. | Function | `null` |  |
| `layoutOptions.navigationId` | Determines which navigation will be rendered. | String | *Please read [navigationId](#navigationId)*. |  |
| `layoutOptions.criticalPath` | First request inline styles configuration. | Object | `null` |  |
| `layoutOptions.criticalPath.key` | Enables first request inline styles. This key is used to determine the cookie name. | String | `null` |  |
| `layoutOptions.criticalPath.cookiePath` | Determines the cookie path. | String | `/` |  |
| `layoutOptions.criticalPath.cookieDomain` | Determines the cookie domain. | String | `req.hostname` |  |
| `layoutOptions.loadable` | Enables [frontend-lazy](https://github.com/mercadolibre/fury_frontend-lazy) on the given entrypoint | String | `null` |  |
| `navigationOptions` | Navigation options to pass to navigation prepare to render method. | Object | `null` |  |
| `navigationOptions.type` | Navigation type option. | String | `full` |  |

##### done
This function is called when the rendering phase is done. The first parameter will be an error if occurred, and the second one will be the markup string if no error ocurred.

Example:
```js
done: (error, output) => {
  if (!error) {
    res.send(output.replace('some-text', 'replace-text'));
  } else {
    res.status(500).send('Something was wrong!');
  }
}
```

##### layoutOptions
###### lang
Sets the `lang` attribute on `html` tag. If no value is provided the `lang`attribute is determined by current site's country configuration.

###### favicons
Default value:
```js
[{
  href: '/favicon.svg',
  rel: 'icon',
}, {
  href: '180x180.png',
  rel: 'apple-touch-icon',
}]
```

These default favicons configuration results on:
```html
<link rel="icon" href="favicon.svg">
<link rel="apple-touch-icon" href="180x180.png">
```

###### embedCss
Embeds navigations CSS in `style` tags.

Example:
```js
embedCss: true
```
Results on:
```html
<style> /* Navigation CSS */ </style>
```

###### externalCss
Loads external CSS with `link` tags.

Example:
```js
externalCss: [
  'foo.css',
  'bar.css'
]
```
Results on:
```html
<link rel="stylesheet" type="text/css" href="foo.css"/>
<link rel="stylesheet" type="text/css" href="bar.css"/>
```

###### inlineCss
Loads inline CSS with `style` tags.

Example:
```js
inlineCss: ['body { background: red; }']
```
Results on:
```html
<style>body { background: red; }</style>
```

###### scripts
Loads external scripts with `script` tags.

Example:
```js
scripts: ['https://www.mercadolibre.com/some-script.js']
```
Results on:
```html
<script src="https://www.mercadolibre.com/some-script.js"></script>
```

###### staticMarkup
If `false` the middleware uses [`renderToString`](https://reactjs.org/docs/react-dom-server.html#rendertostring) to render, while if `true` it uses [`renderToStaticMarkup`](https://reactjs.org/docs/react-dom-server.html#rendertostaticmarkup) skipping React-specific data attributes.

###### performanceStats
This function is called on each request and receives performance stats about that particular request.

Example:
```js
performanceStats: (stats) => logger.info(stats),
```

###### navigationId
Determines which navigation will be rendered. If no value is provided and there's no `navigation` property on middleware options, the navigation factory will try to determine the best navigation using the request data (eg: platform, site, etc).

| Id | Navigation |
| --- | --- |
| `Classi` | [Classified (TuX)](https://github.com/mercadolibre/fury_frontend-navigations/tree/master/modules/classified) |
| `CB` | [Cross Border Trade](https://github.com/mercadolibre/fury_frontend-navigations/tree/master/modules/cross-border-trade) |
| `First-party` | [First Party](https://github.com/mercadolibre/fury_frontend-navigations/tree/master/modules/first-party) |
| `ML` | [Mercado Libre (marketplace)](https://github.com/mercadolibre/fury_frontend-navigations/tree/master/modules/mercado-libre) |
| `MP` | [Mercado Pago](https://github.com/mercadolibre/fury_frontend-navigations/tree/master/modules/mercado-pago) |
| `MS` | [Mercado Shops](https://github.com/mercadolibre/fury_frontend-navigations/tree/master/modules/mercado-shops) |
| `PI` | [Portal Inmobiliario](https://github.com/mercadolibre/fury_frontend-navigations/tree/master/modules/portal-inmobiliario) |


###### criticalPath
Enables first request inline styles behaviour. This behaviour renders inline styles and `link` tags prefetching external styles to be cached when a device enters a page for the first time or if cached styles are out-of-date, and linked styles on next requests if cached styles are up-to-date. This saves the CSS roundtrips when the user has no cached styles.

To determine cached files on browser a cookie is set. The cookie name is determined by the `criticalPath.key`, and its value corresponds to the application version.

Example:
```js
criticalPath: {
  key: 'tiendas_oficiales',
  cookiePath: '/tiendas-oficiales',
}
```

If the application version is `1.2.3`, the first time the device requests the page the middleware will render application inline styles and prefetchs for external resources, and set the `c_tiendas_oficiales` cookie with the value `1.2.3` on the `/tiendas-oficiales` path. On subsequent requests the cookie will be transferred, so the middleware can identify cached styles and render linked styles.

##### navigationOptions
This object will be passed to the navigation prepare to render method. Each navigation expects different properties so the shape of this object depends on the navigation to be rendered. Please refer to [navigationId](#navigationId) section if you want to know more about default navigations.

Example:
```js
navigationOptions: {
  type: 'full'
}
```

###### type
The property value will be passed to the navigation prepare to render method.

If its value is `hidden` the navigation and its resources will not be rendered at all, leaving the entire viewport to the application. If the application is running on a webview its value is overriden by `hidden` as native apps provides their own navigation.

Its value changes how the navigation will behave and look (eg: `full` renders all the components, `lite` renders core ones). Please refer to [navigationId](#navigationId) section if you want to know more about default navigations and its types.

Example:
```js
navigationOptions: {
  type: 'lite'
}
```

## License

Copyright © 2016.
