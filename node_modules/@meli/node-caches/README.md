## @meli/node-caches

> A library that reunites and expose all of the cache clients provided for Fury and local development

### Install

```
npm install --save @meli/node-caches
```

# Table of Contents

- [Usage](#usage)
- [Clients](#Clients)
- [API](#API)
- [Logs](#Logs)
- [Tests](#tests)

### Usage per client

```javascript
/**
 * Module dependencies
 */
 const LRUCache = require('@meli/node-caches/LRU');

/**
 * Create a new instance of the Cache Client
 * Pass the specific configurations depending on the client
 */
 const cacheClient = new LRUCache();
 
 // Use it to store what you wan't
 cacheClient.set('key', { name: 'Ariel', lastname: 'Rey' });
 
 // Get the value storage
 cacheClient.get('key').then(value => {
   console.log(`Value from cache = ${value}`);
 }).catch(err => {
   console.log(`An error occurred getting value from cache: ${err.message}`);
 });
```

### QuickClient: an automatic cache client

The purpose of this module is to expose a cache client that can be used with one line of code.
This client creates a KVS or LRU client based on the value of your NODE_ENV environment variable. When NODE_ENV is equal to `production`, you will get a KVS client instance. Otherwise, a LRU client will be returned.

```javascript
/**
 * Create a new instance of the Cache Client
 * Pass the specific KVS configs (example: container, timeout, etc)
 */
 const CacheClient = require('@meli/node-caches/QuickClient')({ container: 'beta-container-kvs' });
 
 // Use it to store what you wan't
 cacheClient.set('key', { name: 'Ariel', lastname: 'Rey' });
 
 // Get the value storage
 cacheClient.get('key').then(value => {
   console.log(`Value from cache = ${value}`);
 }).catch(err => {
   console.log(`An error occurred getting value from cache: ${err.message}`);
 });
```

**Important:** Keep in mind that every time you use the QuickClient module, you will get a new instance of the corresponding cache client. When a KVS client is created, this is probably not an issue, because the client will use a distributed service. But when a LRU client is created, its memory is not shared among other LRU clients you may create by using the QuickClient. So you must not expect to store a value in one module and read it from a different one.

### Â¿What if i want to do my own 'QuickClient'?

That's very simple! You can just do your own QuickClient inside your application and use, for example, Memcached instead of KVS Client.
To do this, just do as follows:

```javascript
/*
 * Module dependencies
 */
const env = require('frontend-env');
const Memcached = require('@meli/node-caches/Memcached');
const LRU = require('@meli/node-caches/LRU');

class CacheClient {
  constructor(memcachedConfig) {
    return env.PRODUCTION
      ? new Memcached(memcachedConfig)
      : new LRU();
  }
}

module.exports = memcachedConfig => new CacheClient(memcachedConfig);
```

### Clients

Currently we are exposing 3 cache clients

* [LRU](https://www.npmjs.com/package/stale-lru-cache)

LRU is a resilient and performant in-memory cache for node.js

* [Memcached](https://www.npmjs.com/package/memcached)

Memcached is an in-memory key-value store for small chunks of arbitrary data (strings, objects) from results of database calls, API calls, or page rendering

* [KVS](https://github.com/mercadolibre/fury_node-kvsclient)

KVS is a server that response to the paradig "key value store". It's design to store, retrieve and manage common data structures well known as dictionary or hash.

* QuickClient

It's just a wrapper that decides which Client to use depending on the ENV variable. In case it is PRODUCTION, it will use the KVS Client, and in case it's local, will use the LRU client.

### API

All of the clients receive 2 arguments

* configs

This are the configurations to be sent to the cache client

* options

This are the special configurations for client usage

| Option | Required | Default | Type | Description | 
| --- | --- | --- | --- | --- |
| logs | false | from **configuration** file on `{ cache: logs }` | Boolean |  Enable client logs |

#### Required configs

* Memcached

The required parameters are:

| Config | Required | Default | Type | Description | 
| --- | --- | --- | --- | --- |
| nodesEndpoint | true | - | String | List of servers split by a space Ex.: `localhost:1000 localhost:10001` |

* KVS

The required parameters are:

| Config | Required | Default | Type | Description | 
| --- | --- | --- | --- | --- |
| container | true | - | String | **name** of the container from **Fury** Ex.: `prod-container` |

### Logs

Each clients logs the operations that have been done. This are enabled by default on **local** environments, and disabled on **production** environments.

You can override the configuration on instantiation. Example:

```javascript
/**
 * Module dependencies
 */
 const LRUCache = require('@meli/node-caches/LRU');

/**
 * Create a new instance of the Cache Client
 * Pass the specific configurations depending on the client
 */
 const cacheClient = new LRUCache({}, {
   logs: false, // This will override the configuration on your client file
 });
```

> You can't disable the error log messages

### Tests

```npm
npm test
```

### Author

[mpfrontcore.ba@mercadolibre.com](mailto:mpfrontcore.ba@mercadolibre.com)
