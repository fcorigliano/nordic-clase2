# Changelog

## Next Release

## 5.5.0

- [#111](https://github.com/mercadolibre/fury_frontend-authentication/pull/111) Check for well-formatted SSID in production, allowing test cookies outside prod
- [#110](https://github.com/mercadolibre/fury_frontend-authentication/pull/110) Reduce Session and Users APIs request retries to just 1
- [#109](https://github.com/mercadolibre/fury_frontend-authentication/pull/109) Pass SSID and Access Token via header to their respective APIs

## 5.4.1

- [#108](https://github.com/mercadolibre/fury_frontend-authentication/pull/108) Always use `req.platform.shop` to detect if we are in a shop

## 5.4.0

- [#105](https://github.com/mercadolibre/fury_frontend-authentication/pull/105) Take retries into account for request metrics
- [#104](https://github.com/mercadolibre/fury_frontend-authentication/pull/104) Migrate to Jest v28

## 5.3.3

- [#103](https://github.com/mercadolibre/fury_frontend-authentication/pull/103) Change migration guide links in type definitions
- [#102](https://github.com/mercadolibre/fury_frontend-authentication/pull/102) Change `res.locals.authInfo` to `req.nordic.auth`

## 5.3.2

- [#101](https://github.com/mercadolibre/fury_frontend-authentication/pull/101) Fix `<br>` tag for Nordic Page generator

## 5.3.1

- [#100](https://github.com/mercadolibre/fury_frontend-authentication/pull/100) Changed `req.auth` migration guide link

## 5.3.0

- [#99](https://github.com/mercadolibre/fury_frontend-authentication/pull/99) Lots of changes
  - 🏠 Internal - Major refactor to support multiple authentication methods
  - 🚀 Feature - Support MShops Sessions
  - 🚀 Feature - New `req.auth` property which will eventually replace `req.user` and `req.userSession`
  - 📝 Documentation - Tag `navigateAsOperator` option as deprecated, as well as `req.user` and `req.userSession`
- [#98](https://github.com/mercadolibre/fury_frontend-authentication/pull/98) 🏠 Internal - Lint and refactor tests

## 5.2.1

- [#97](https://github.com/mercadolibre/fury_frontend-authentication/pull/97) 🐛 Fix - Let AT cookie be set when authenticating with an AT via QS

## 5.2.0

- [#96](https://github.com/mercadolibre/fury_frontend-authentication/pull/96) 🚀 Feature - Log to Datadog Access Token source
- [#96](https://github.com/mercadolibre/fury_frontend-authentication/pull/96) 🚀 Feature - Start using new Access Token cookie `nat`
- [#95](https://github.com/mercadolibre/fury_frontend-authentication/pull/95) 🐛 Fix - Allow Admin Session Header to be `false`

## 5.1.4

- [#94](https://github.com/mercadolibre/fury_frontend-authentication/pull/94) 🐛 Fix - Delete PII properties from type declarations

## 5.1.3

- [#92](https://github.com/mercadolibre/fury_frontend-authentication/pull/92) 🐛 Fix - Always set `req.user.admin` as a boolean

## 5.1.2

- [#89](https://github.com/mercadolibre/fury_frontend-authentication/pull/89) 🐛 Fix - Set `req.user.rootId` always as a number
- [#89](https://github.com/mercadolibre/fury_frontend-authentication/pull/89) 🐛 Fix - Log correct full URL on modifying impersonated requests

## 5.1.1

- [#87](https://github.com/mercadolibre/fury_frontend-authentication/pull/87) 🐛 Fix - SSRF vuln

## 5.1.0

- [#85](https://github.com/mercadolibre/fury_frontend-authentication/pull/85) 🚀 Feature - Track applications accessing `req.userSession`

## 5.0.1

- [#83](https://github.com/mercadolibre/fury_frontend-authentication/pull/83) 🚀 Feature - New `authMiddleware` export
- [#81](https://github.com/mercadolibre/fury_frontend-authentication/pull/81) 🏠 Internal - Update Nordic internal deps to next versions
- [#77](https://github.com/mercadolibre/fury_frontend-authentication/pull/77) 🏠 Internal - Return the promise being executed in both middlewares
- [#75](https://github.com/mercadolibre/fury_frontend-authentication/pull/75) 💥 AJAX response no longer has `code` property and exposes other properties outside `data` property, standarizing `url` property for redirection
- [#73](https://github.com/mercadolibre/fury_frontend-authentication/pull/73) 🚀 Feature - Delete peer deps to support NPM v7
- [#72](https://github.com/mercadolibre/fury_frontend-authentication/pull/72) ⏭ Bring latest changes from `master` branch
- [#70](https://github.com/mercadolibre/fury_frontend-authentication/pull/70) 💥 Start using Users API v2
- [#69](https://github.com/mercadolibre/fury_frontend-authentication/pull/69) 💥 `allowAdmins` no longer supports legacy `true` value and will throw an error if present
- [#68](https://github.com/mercadolibre/fury_frontend-authentication/pull/68) 💥 Reauthentication is no longer handled in fe-auth and must be handled with [fe-reauth](https://github.com/mercadolibre/fury_frontend-reauthentication)
- [#66](https://github.com/mercadolibre/fury_frontend-authentication/pull/66) 💥 `allowSetAccessTokenCookie` is completely deprecated and no longer valid

## 4.13.0

- [#79](https://github.com/mercadolibre/fury_frontend-authentication/pull/79) 🚀 Feature - Clean `ssid` cookie on 404 session GET response code
- [#79](https://github.com/mercadolibre/fury_frontend-authentication/pull/79) 🚀 Feature - Add `site_id` param on session request
- [#79](https://github.com/mercadolibre/fury_frontend-authentication/pull/79) 🚀 Feature - Inject custom User Agent on requests

## 4.12.2

- [#78](https://github.com/mercadolibre/fury_frontend-authentication/pull/78) 🐛 Fix - Add `test_scope` tag to Datadog metrics

## 4.12.1

- [#74](https://github.com/mercadolibre/fury_frontend-authentication/pull/74) 🐛 Fix - Add failed request on error metric

## 4.12.0

- [#71](https://github.com/mercadolibre/fury_frontend-authentication/pull/71) 🚀 Feature - Add request and error metrics

## 4.11.0

- [#65](https://github.com/mercadolibre/fury_frontend-authentication/pull/65) 🏠 Internal - Start using `root_id` from session info when present
- [#64](https://github.com/mercadolibre/fury_frontend-authentication/pull/64) 🚀 Feature - Support new header `Authorization` for WebViews

## 4.10.1

- [#63](https://github.com/mercadolibre/fury_frontend-authentication/pull/63) 📝 Documentation - Improve reauth deprecation notice and add link to reauth params in new module.

## 4.10.0

- [#62](https://github.com/mercadolibre/fury_frontend-authentication/pull/62) 🏠 Internal - Migrate reauth to new frontend-reauthentication plugin. Add deprecation notice.

## 4.9.1

- [#61](https://github.com/mercadolibre/fury_frontend-authentication/pull/61) 🐛 Fix - Take into account `authenticate` middleware when failing session resolution.

## 4.9.0

- [#60](https://github.com/mercadolibre/fury_frontend-authentication/pull/60) 🚀 Feature - Redirect to auth error page when session resolution has an error.
- [#59](https://github.com/mercadolibre/fury_frontend-authentication/pull/59) 🚀 Feature - Add payment param and any other custom param for reauthentication.
- [#57](https://github.com/mercadolibre/fury_frontend-authentication/pull/57)[#58](https://github.com/mercadolibre/fury_frontend-authentication/pull/58) 🏠 Internal - Start using reauthentication-api for reauth.

## 4.8.1

- [#55](https://github.com/mercadolibre/fury_frontend-authentication/pull/55) 🏠 Internal - Remove secret `req.__navUser` prop and update README.

## 4.8.0

- [#52](https://github.com/mercadolibre/fury_frontend-authentication/pull/52) 🚀 Feature - Let test users skip reauth with `reauth_dev` cookie.
- [#52](https://github.com/mercadolibre/fury_frontend-authentication/pull/52) 🚀 Feature - New `req.user.test` property to indicate if user is a test user.
- [#51](https://github.com/mercadolibre/fury_frontend-authentication/pull/51) 👓 Spec Compliancy - Send context in each request (request ID).
- [#49](https://github.com/mercadolibre/fury_frontend-authentication/pull/49) 🏠 Internal - Use `@auth/urls` to get login URL and delete custom code.

## 4.7.2

- [#53](https://github.com/mercadolibre/fury_frontend-authentication/pull/53) 🐛 Fix - Clear and set access_token

## 4.7.0

- [#48](https://github.com/mercadolibre/fury_frontend-authentication/pull/48) 🚀 Feature - Add MLC_OPERADOR & MLC_EMISOR regulated reauths. Also start passing Array of regulations to BE instead of simple regulation string.
- [#47](https://github.com/mercadolibre/fury_frontend-authentication/pull/47) 🚀 Feature - Verify reauth even if we are not asking reauth.
- [#47](https://github.com/mercadolibre/fury_frontend-authentication/pull/47) 🏠 Internal - Do not ask reauth if reauth verified correctly (avoid many unneeded requests)
- [#46](https://github.com/mercadolibre/fury_frontend-authentication/pull/46) 🏠 Internal - Added functional tests. Finally!

## 4.6.1

- [#45](https://github.com/mercadolibre/fury_frontend-authentication/pull/45) 🐛 Fix - Check if user has a regulation that needs reauth.

## 4.6.0

- [#44](https://github.com/mercadolibre/fury_frontend-authentication/pull/44) 🚀 Feature - Read regulation property from `req.user.regulation` if set.
- [#43](https://github.com/mercadolibre/fury_frontend-authentication/pull/43) 🏠 Internal - Move reauthentication logic outside of helpers and into its own module.

## 4.5.1

- [#41](https://github.com/mercadolibre/fury_frontend-authentication/pull/41) 🐛 Fix - Refactor types declaration, specially how Express Request is augmented.

## 4.5.0

- [#39](https://github.com/mercadolibre/fury_frontend-authentication/pull/39) 🐛 Fix - Access Token client ID verified against a list of valid client IDs. Cookie is always set if AT is valid.
- [#39](https://github.com/mercadolibre/fury_frontend-authentication/pull/39) 🚀 Feature - Add AT verification when session resolved in middleware.
- [#37](https://github.com/mercadolibre/fury_frontend-authentication/pull/37) & [#38](https://github.com/mercadolibre/fury_frontend-authentication/pull/38) 🚀 Feature - Redirect to error page when reauth fails. Let app handle error in case it's needed.

## 4.4.0

- [#36](https://github.com/mercadolibre/fury_frontend-authentication/pull/36) 🐛 Fix - Don't call next function with error. Let request go through for the time being.
- [#36](https://github.com/mercadolibre/fury_frontend-authentication/pull/36) 🚀 Feature - Add redirect to reauth restrictions FE when there's a conflict with reauth transaction.

## 4.3.0

- [#35](https://github.com/mercadolibre/fury_frontend-authentication/pull/35) 🚀 Feature - Added `allowWebviewAuthentication` parameter to allow authentication via AT. Defaults to `false`. Deprecate `allowSetAccessTokenCookie`
- [#35](https://github.com/mercadolibre/fury_frontend-authentication/pull/35) 🚀 Feature - Allow authentication via Access Token only when that Access Token is deemed safe
- [#32](https://github.com/mercadolibre/fury_frontend-authentication/pull/32) 🐛 Fix - Fixed comparison between ClientId from Access Token and Header ClientId.
- [#33](https://github.com/mercadolibre/fury_frontend-authentication/pull/33) 🏠 Internal - Migrated and re-wrote tests in Jest.

## 4.2.0

- [#31](https://github.com/mercadolibre/fury_frontend-authentication/pull/31) ⏪ Revert [#24](https://github.com/mercadolibre/fury_frontend-authentication/pull/24) since PII Vault API won't be ready in time 😞. Also added logs to pinpoint apps that access PII info.

## 4.1.0

- [#29](https://github.com/mercadolibre/fury_frontend-authentication/pull/29) 🚀 Feature - Added reauth validation, exposed with `req.userSession.reauthChecked` property.
- [#30](https://github.com/mercadolibre/fury_frontend-authentication/pull/30) 🐛 Fix - Fixed types in declaration file and added TSC to check declaration file.

## 4.0.0

### Non-breaking changes in 4.0.0

- [#28](https://github.com/mercadolibre/fury_frontend-authentication/pull/28) 🚀 Feature - Added `regulation` and `flowType` parameters for reauthentication.

### 💥 Breaking changes in 4.0.0

- [#28](https://github.com/mercadolibre/fury_frontend-authentication/pull/28) 💥 If a reauthentication request fails, then the middleware fails and user can't go through, calling `next()` with an error.

## 3.0.0

### Non-breaking changes in 3.0.0

- [#25](https://github.com/mercadolibre/fury_frontend-authentication/pull/25) 🐛 Fix - logging from modifying requests made by admins. Now response status code gets logged.

### 💥 Breaking changes in 3.0.0

- `allowAdmins: ['GET', 'HEAD', 'OPTIONS']`
  - [#04](https://github.com/mercadolibre/fury_frontend-authentication/pull/4) Restrict admins to use specific request methods (default as only `GET`, `HEAD` and `OPTIONS`).
- Deprecate orghash cookie support for authentication
  - [#17](https://github.com/mercadolibre/fury_frontend-authentication/pull/17) Deprecate orghash
- PII user info is no longer available in `req.user`
  - [#24](https://github.com/mercadolibre/fury_frontend-authentication/pull/24) Remove PII info from `req.user`

#### Changes between versions

##### Changes in `allowAdmins` parameter

The way to allow admins is now by declaring which request methods they can use instead of a simple `true` / `false`:

```js
// v2
const authorization = auth({
  allowAdmins: true,  // Old default value
});
```

```js
// v3
const authorization = auth({
  allowAdmins: ['GET', 'HEAD', 'OPTIONS'], // New default value
});
```

If no admins should be allowed at all:

```js
// v2
const authorization = auth({
  allowAdmins: false,
});
```

```js
// v3
const authorization = auth({
  allowAdmins: [],  // No request methods allowed
});
```

If you have to allow admins to execute other request methods _**for a very good reason**_, then you can use the following:

```js
// v2
const authorization = auth({
  allowAdmins: true,
});
```

```js
// v3
const authorization = auth({
  allowAdmins = ['GET', 'POST', 'PUT'], // Also allow modifying requests. Use with caution.
});
```

##### Orghash deprecation

The orghash cookie was used for resolving user authentication, but a new alternative, the SSID cookie, has been used for many years. It's time to say goodbye to the old orghash and drop support for it.

#### 📝 Migration steps

##### Allow Admin cases

1. If you were using the default config, now admins will **ONLY** be able to make GET requests, so you should check if there's a very good reason to allow admins to make any other type of request.
2. If no admins were allowed in you app, then you have to set `allowAdmins: []` to block all request methods. If no change is made then the value will be converted accordingly and a warning will be issued. ⚠️
3. If you were explicitly allowing admins, then you can just erase the value to use the default config, or overwrite it by yourself by setting `allowAdmins: ['GET']`. If no change is made then the value will be converted accordingly and a warning will be issued. ⚠️

##### Orghash deprecation cases

Most projects shouldn't have to do a migration, since user authentication is usually resolved transparentely. If you are manually using the orghash cookie, then we **strongly** ask you to please start using this middleware as the authentication method. If you have special cases where this is not enough, please [send us a mail](mailto:sessions_security@mercadolibre.com).

## 2.15.0

- [#20](https://github.com/mercadolibre/fury_frontend-authentication/pull/20) 👓 Spec Compliancy - Add SameSite attribute for `access_token` cookie

## 2.14.0

- [#18](https://github.com/mercadolibre/fury_frontend-authentication/pull/18) 👓 Spec Compliancy - Record any modifying request made by an admin

## 2.13.0

- [#16](https://github.com/mercadolibre/fury_frontend-authentication/pull/16) 🏠 Internal - Pass platform_id to sessions API in GET request

## 2.12.2

- [#15](https://github.com/mercadolibre/fury_frontend-authentication/pull/15) 🐛 Fix - Fixed req.user validation (null cases) in authorization

## 2.12.1

- [#14](https://github.com/mercadolibre/fury_frontend-authentication/pull/14) 🐛 Fix - Update version
- [#13](https://github.com/mercadolibre/fury_frontend-authentication/pull/13) 🏠 Internal - Update dependencies
- [#12](https://github.com/mercadolibre/fury_frontend-authentication/pull/12) 💅 Polish - Fix linting errors
- [#11](https://github.com/mercadolibre/fury_frontend-authentication/pull/11) 🏠 Internal - Detached ID no longer resolved from user grant. Now access token API response is used

## 2.12.0

- [#10](https://github.com/mercadolibre/fury_frontend-authentication/pull/10) 🐛 Fix - Corrected types for `req.userSession` (Web session vs Access Token)
- [#09](https://github.com/mercadolibre/fury_frontend-authentication/pull/9) 🚀📝 Feature - Types for Express (as a plugin)
- [#08](https://github.com/mercadolibre/fury_frontend-authentication/pull/8) 🚀 Feature - Added `navigateAsOperator` parameter
- [#06](https://github.com/mercadolibre/fury_frontend-authentication/pull/6) 🚀 Feature - Set token cookie when access token header exist
- [#05](https://github.com/mercadolibre/fury_frontend-authentication/pull/5) 🚀 Feature - Access token via header

## 2.11.1

- [#03](https://github.com/mercadolibre/fury_frontend-authentication/pull/3) 🚀📝 Feature - Added types (declaration file)
- [#02](https://github.com/mercadolibre/fury_frontend-authentication/pull/2) 🚀 Feature - Added `redirectUrl` as optional parameter for reauthentication
- [#01](https://github.com/mercadolibre/fury_frontend-authentication/pull/1) 🏠 Internal - Migration to Fury

## 2.11.0

> Version was unpublished due to accidental early publication

## 2.10.0

- [#75](https://github.com/mercadolibre/frontend-authentication/pull/75) Update dependencies
- [#74](https://github.com/mercadolibre/frontend-authentication/pull/74) Add data object in response of 403 status

## 2.9.1

- [#76](https://github.com/mercadolibre/frontend-authentication/pull/76) Add skipped tests

## 2.9.0

- [#72](https://github.com/mercadolibre/frontend-authentication/pull/72) Added AJAX support for reauthentication

## Check for previous history in the [old repo release tags](https://github.com/mercadolibre/frontend-authentication/releases)
