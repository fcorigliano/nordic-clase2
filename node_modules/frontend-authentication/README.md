# Authentication

## Table of Contents

- [Authentication](#authentication)
  - [Table of Contents](#table-of-contents)
  - [Description](#description)
  - [Installation](#installation)
    - [Requirements](#requirements)
  - [Authentication Methods](#authentication-methods)
    - [Meli Web Session](#meli-web-session)
    - [Meli Access Tokens (Webviews)](#meli-access-tokens-webviews)
    - [Mshops Session](#mshops-session)
  - [Usage](#usage)
    - [authenticate](#authenticate)
      - [Webviews case](#webviews-case)
    - [authMiddleware(options)](#authmiddlewareoptions)
      - [Options](#options)
      - [Customize authentication URLs parameters](#customize-authentication-urls-parameters)
    - [Reauthentication](#reauthentication)
  - [Errors](#errors)
    - [Errors - Session or User not found](#errors---session-or-user-not-found)
    - [Errors - Server Error or Timeout](#errors---server-error-or-timeout)
  - [API](#api)
    - [`req.auth.user`](#reqauthuser)
    - [`req.auth.session`](#reqauthsession)
      - [Meli Web Session Properties](#meli-web-session-properties)
      - [Meli Access Tokens (Webviews) Properties](#meli-access-tokens-webviews-properties)
      - [Meli Mshops Session Properties](#meli-mshops-session-properties)
  - [License](#license)

## Description

> A middleware function to resolve Mercado Libre platforms authentication & authorization.

It should resolve the logged `user` or redirect to the login page with requested URL as callback in case of authorization.
  In cases when request is Ajax that means that it has header `'X-Requested-With': 'XMLHttpRequest'` instead of redirection
  to the login page it should return a JSON object with `401` HTTP status code. Format of the object is always the same and
  looks like:

```js
{
  message: 'Unauthorized',
  url: 'platform-dependent-login-url',
}
```

## Installation

```sh
npm install frontend-authentication
```

### Requirements

This plugin assumes `req.platform` is defined, so it needs [frontend-platform_detection](https://github.com/mercadolibre/fury_frontend-platform-detection) to run beforehand.

This requirement only applies when using this plugin as standalone, and it is already taken care of inside the Nordic stack.

## Authentication Methods

More that one authentication method is supported, and each of these methods is represented in the `req.auth.method` property.

### Meli Web Session

`req.auth.method` value is `'MELI_WEB'`.

This method is the most commonly used authentication method in FEs, and the session is stored in the cookie `ssid`.

Meli web sessions can be used in any FE application **OUTSIDE** webviews, which use a different authentication method.

### Meli Access Tokens (Webviews)

`req.auth.method` value is `'MELI_WEBVIEW'`.

This authentication method is the one used in webviews and can only be used inside webviews. Since webviews are used inside our native apps, these native apps send the Access Token which is used to authenticate the user in them to the webview.

The resolved user is the same as in Meli Web Sessions, so `req.auth.user` will be the same in both cases. On the other hand, `req.auth.session` will be different, since the "session" used to authenticate the user is different, so some properties will change.

### Mshops Session

`req.auth.method` value is `'MSHOPS'`.

This is the authentication method used for Mercado Shops Lite Users, otherwise known as MShops Users, or even Guest Users.

MShops Users can **ONLY** authenticate inside an MShops site, either on MS subdomains (norauto.mercadoshops.com.ar) or on delegated domains (shop.norauto.com.ar). Also, it is needed to have the `mshopsDetection` middleware enabled in Nordic. More info on the [Nordic Documentation Site](https://nordic.adminml.com/docs/api/Nordic%20Modules/ragnar#middlewares-1).

The session is stored in the cookie `mssid`.

⚠️ If the user is navigating in a MS subdomain, and has BOTH a Meli Web Session and a MShops Session, then the Meli Web session will be prioritized.

## Usage

### authenticate

This middleware should resolve the logged user.

If you are using [Ragnar](https://nordic.adminml.com/docs/api/Nordic%20Modules/ragnar) this middleware is configured by default and you do not need to add it in your router.

```js
/**
 * Module dependencies
 */
const router = require('ragnar').router();

/**
 * Use req.auth
 */
router.get('/somewhere', (req, res, next) => {
  // If the user is authenticated the req.auth object is populated
  // with user data, if not req.auth will be undefined.
  console.log(req.auth);
  next();
});

/**
 * Expose router
 */
module.exports = router;
```

#### Webviews case

When the request comes from a webview of the `WebkitLandig` type, the user's access token is sent via header. In order to keep it in all requests, this middleware creates the `nat` cookie with its value.

This `nat` cookie is set in all webviews as long as the user is logged-in, regardless if the user is required to be logged-in. An example of this may be the home page, where it is not necessary to log in to navigate, but if the user did, you can add items to favorites, an action that requires authentication.

For the cookie to be created it is necessary to comply with some basic security rules:

- The request must contain an Access Token sent through the `Authorization` or `x-access-token` headers
- The client_id contained in the access_token must correspond to one of Meli's native apps

### authMiddleware(options)

Create an authorization strategy middleware with the given options to authorize a request.

The authMiddleware middleware can:

- Redirect to login page if no authenticated user is presented.
- Redirect to validateUser page if the logged user is not authorized.
- Show a 403 page when admins are using an unallowed request method.
- Return a JSON object for XHR requests with a corresponding HTTP status code.
- Execute the next middleware.

#### Options

`authMiddleware()` accepts these properties in the options object:

| Name                         | Type       | Description | Default |
|------------------------------|------------|-------------|---------|
| `allowOperators`             | `boolean`  | Indicates if the authorization strategy should allow operators. | `false` |
| `ignoreUserSiteStatus`       | `boolean`  | Indicates if the authorization strategy should ignore the status of the user. | `false` |
| `allowAdmins`                | `string[]` or `false` | Indicates the [request methods](https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods) allowed for an admin user to use (impersonalized user). The allowed methods are represented as an array of strings. If at least 1 method is specified, then `HEAD` and `OPTIONS` methods will **ALWAYS** be supported. `false` value will allow no request methods whatsoever. | `['GET', 'HEAD', 'OPTIONS']` |
| `allowWebviewAuthentication` | `boolean`  | Allows for users to authenticate with an Access Token ONLY inside webviews. | `false` |
| `ignoreLoginRedirect`        | `boolean`  | Prevent being redirected to login in case user is not logged in or user resolution failed. | `false` |
| ~~`navigateAsOperator`~~     | `boolean`  | Indicates if the operator should be navigating as himself instead of as his owner. All `req.auth.user` properties become the operator's properties (userId, nickname, email, etc). Root user ID is available in property `rootId`.<br/>This property has become obsolete for all applications that have already fixed the Collaboratos Session's Vuln. More info [here](https://meli.workplace.com/notes/271968245036883). | `false` |

```js
/**
 * Module dependencies
 */
const router = require('ragnar').router();
const { authMiddleware } = require('frontend-authentication');

/**
 * Default authorization strategy
 */
const defaultAuthorize = authMiddleware();

/**
 * Configure a custom authorization strategy
 */
const customAuthorize = authMiddleware({
  allowOperators: true,
  navigateAsOperator: true,
  ignoreUserSiteStatus: true,
  allowAdmins: [],  // Empty array to specify no methods are allowed
});

/**
 * Use default authorization
 */
router.get('/default', defaultAuthorize, function (req, res) {
  // If the logged user is authorized this code will be executed.
  res.send(req.auth);
});

/**
 * Use a custom authorization
 */
router.get('/custom', customAuthorize, function (req, res) {
  // If the logged user is authorized this code will be executed.
  res.send(req.auth);
});

/**
 * Expose router
 */
module.exports = router;
```

#### Customize authentication URLs parameters

There are cases when you need to customize some parameters in the authentication URLs (login). The following objects are available to configure the URLs parameters:

- `req.loginParams`: Object to customize the login url parameters.
  - `req.loginParams.platform_id`
  - `req.loginParams.go`
  - `req.loginParams.loginType`

Please read the [docs for the `@auth/urls`](https://github.com/mercadolibre/fury_auth-frontend-library/tree/master/modules/urls#customize-urls-parameters) module for more information.

### Reauthentication

⚠️ **IMPORTANT** ⚠️: Reauthentication has been migrated and is now handled by the new plugin [frontend-reauthentication](https://github.com/mercadolibre/fury_frontend-reauthentication). Please read [this migration guide](https://github.com/mercadolibre/fury_frontend-reauthentication/blob/master/docs/MIGRATION-v1.md) to start using it.

## Errors

An error could occur when requesting session information to the corresponding APIs (Server error / Session Not Found / Timeouts / etc).

If `ignoreLoginRedirect` param is set to `true`, nothing will be done and `req.auth` will be undefined, continuing with the execution of the next middleware.

### Errors - Session or User not found

If the APIs in charge of getting session or the users' information return a 4xx status code, like a 404 (not found), the user is treated as unauthenticated and will be redirected to the login page.

If it's an AJAX request, the middleware will respond the request with a JSON with the following data and status code 401 (Unauthorized):

```js
resclient.get('mercadolibre.com.ar/foo/bar')
  .then((console.log) // Do something with the returned data
  .catch((error) => {
    // Asuming we get a response and not a timeout

    console.error(error.response.status);
    // 401
    console.error(error.response.data);
    // { message: 'Unauthorized', url: 'https://www.mercadolibre.com/login' }

    window.location.assign(error.response.data.url);
  });
```

### Errors - Server Error or Timeout

If there's a server error or request times out, then the user will be redirected to an error page to inform him that's something has gone wrong, and avoid overloading our login flow.

The error page is [this one](https://www.mercadolibre.com.ar/auth/error) and will be provided with a query param to let the user go back to the page he was trying to access.

If it's an AJAX request, the middleware will respond the request with a JSON with the following data and status code 401 (Unauthorized):

```js
resclient.get('mercadolibre.com.ar/foo/bar')
  .then((console.log) // Do something with the returned data
  .catch((error) => {
    // Asuming we get a response and not a timeout
    console.error(error.response.status);
    // 401
    console.error(error.response.data);
    // { code: 'EAUTHENTICATION', message: 'Unauthorized', url: 'https://www.mercadolibre.com.ar/auth/error' }

    window.location.assign(error.response.data.url);
  });
```

## API

> `req.user` and `req.userSession` have been deprecated in favor of `req.auth`. Please read [this migration guide](https://nordic.adminml.com/docs/migration-guides/modules/auth/migration-req-auth) if you need to migrate.

`req.auth` has the following properties:

| Property  | Type | Description |
|-----------|------|-------------|
| `method`  | `string` | A string representing the authentication method by which the user was authenticated. It's possible values are: <ul><li>`MELI_WEB`</li><li>`MELI_WEBVIEW`</li><li>`MSHOPS`</li></ul> |
| `user`    | `Object` | User information. The same information that was available in `req.user`. |
| `session` | `Object` | Session information. The same information that was available in `req.userSession`. |

⚠️ `req.auth` will **ONLY** be defined if the user has successfully authenticated with one of the supported authentication methods, and all of its properties will be defined and initialized, so if `req.auth` is defined, `req.auth.user` will also be defined and populated with the user's information.

### `req.auth.user`

If `req.auth` is defined, then `req.auth.user` will always be defined and populated with the user's information.

| Property     | Type               | User Type   | Description |
|--------------|:------------------:|:-----------:|-------------|
| `id`         | `number`           | All         | User ID |
| `nickname`   | `string`           | All         | User's nickname / username |
| `active`     | `boolean`          | All         | Flag indicating if user is active or not (site_status) |
| `test`       | `boolean`          | All         | Flag indicating if the current user is a test user |
| `raw`        | `Object`           | All         | Users API raw response. See [Users API doc](https://sites.google.com/mercadolibre.com/apicore/user/users) for more info |
| `operator`   | `boolean`          | Meli User   | Flag indicating if the current user is a collaborator (operator) |
| `operatorId` | `number` or `null` | Meli User   | If current user is a collaborator, then this will be set with his user ID. Otherwise it will be `null` |
| `rootId`     | `number`           | Meli User   | User ID of root user, the collaborator's owner / root |
| `scopes`     | `string[]`         | Meli User   | User's scopes / permissons |
| `admin`      | `boolean`          | Meli User   | Flag indicating if current user is and admin user (impersonated) |
| `owner`      | `boolean`          | Meli User   | Flag indicating if the current user is the account owner (Not collaborator and not admin) |
| `shopId`     | `number`           | Mshops User | MS Shop ID. An Mshops User is fixed to a specific Shop ID |
| `shopName`   | `string`           | Mshops User | MS Shop name |

"Meli User" is a user which got authenticated with a Meli Web Session or a Meli Access Token, while an "Mshops User" is a user which got authenticated with an Mshops Session.

### `req.auth.session`

In this object we will find info about the "session" used to authenticate the current user.

#### Meli Web Session Properties

| Property        | Type               | Description |
|-----------------|:------------------:|-------------|
| `user_id`       | `number`           | User ID |
| `operator_id`   | `number` or `null` | User ID if user is a collaborator. Otherise `null` |
| `root_id`       | `number`           | Root user ID. Root users are collaborator's owners |
| `site_id`       | `string`           | Site ID of the current session, in lowercase |
| `scopes`        | `string[]`         | Session's scopes / permissions |
| `detached_id`   | `string`           | Safe and unique ID to identify this session without exposing it. Ideal for logs |
| `creation_date` | `string`           | Date this session was created. Date is in ISO format |
| `expire_date`   | `string`           | Date this session will expire. Date is in ISO format |
| `admin_otp`     | `boolean`          | Flag indicating if this is an admin (impersonated) session |

#### Meli Access Tokens (Webviews) Properties

| Property          | Type               | Description |
|-------------------|:------------------:|-------------|
| `user_id`         | `string`           | User ID |
| `operator_id`     | `number` or `null` | User ID if user is a collaborator. Otherise `null` |
| `site_id`         | `string`           | Site ID of the current session, in uppercase |
| `scopes`          | `string[]`         | Session's scopes / permissions |
| `detached_id`     | `string`           | Safe and unique ID to identify this session without exposing it. Ideal for logs |
| `creation_date`   | `string`           | Date this AT was created. Date is in ISO format |
| `access_token`    | `string`           | Access Token used to authenticate user |
| `status`          | `string`           | Access Token status |
| `client_id`       | `number`           | Application ID which created this Access Token |
| `client_owner_id` | `number`           | User ID of the user who created the client ID corresponding to this Access Token |
| `expires_in`      | `number`           | Seconds until this Access Token expires |
| `is_test`         | `boolean`          | Flag indicating if this is a test Access Token |

#### Meli Mshops Session Properties

| Property        | Type               | Description |
|-----------------|:------------------:|-------------|
| `user_id`       | `number`           | User ID |
| `detached_id`   | `string`           | Safe and unique ID to identify this session without exposing it. Ideal for logs |
| `shop_id`       | `number`           | Shop ID to which this session belongs to |
| `creation_date` | `string`           | Date this session was created. Date is in ISO format |
| `expire_date`   | `string`           | Date this session will expire. Date is in ISO format |

## License

© 2022 Mercado Libre - Account Security - [Sessions Security](mailto:sessions_security@mercadolibre.com)
