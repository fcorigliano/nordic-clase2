'use strict';

var statsdInternal = require('frontend-statsd/internal');
var createError = require('../core/createError');
var logger = require('frontend-logger');
var log = logger('frontend-axios');

/**
 * Sends a metric to nordic dashboard and throws an error if content-type header is application/json
 * Related to https://github.com/axios/axios/pull/2849 and https://github.com/axios/axios/pull/2856
 * @param {Error} error json error
 * @param {Object} headers response headers
 * @param {Object} config configuration object
 * @param {Object} data response payload
 * @throws Throws if header content-type starts with 'application/json'
 */
function throwIfExpectJson(error, headers, config, data) {
  var contentType = (headers || {})['content-type'] || '';
  if (data && contentType.startsWith && contentType.startsWith('application/json')) {
    var message = 'frontend-axios response content-type is "' + contentType + '" for url "' + config.url + '" but there was an error parsing JSON: "' + error.name + ' ' + error.message + '"';
    statsdInternal.histogram('nordic.frontend_axios.error_parsing_json', 1, {
      instance_id: process.env.INSTANCE_ID
    });
    log.warn('nordic.frontend_axios.error_parsing_json', {
      instance_id: process.env.INSTANCE_ID,
      url: config.url
    });
    throw createError(message, config);
  }
}

module.exports = throwIfExpectJson;
