# Frontend Style component

> React component to load project styles

## Installation

```sh
npm install -S frontend-style
```

## Features

- Allows to load styles from any component at any point of your React app.
- Can be defined in many places throughout the application.
- Does not allows the duplicated styles.
- Can embed the CSS from files directly into the HTML
- [First request inline styles](#first-request-inline-styles)
- CSS files preloading

## Props

| Property | Description | Type | Default | Required |
| --- | --- | --- | --- | --- |
| `href` | URI of the resource | string | `null` |  |
| `inline` | Indicates if file content should be embedded on a style tag | boolean | `false` |  |
| `media` | Renders a media attribute on `link` or `style` tag | string | `null` |  |
| `preload` | Sends a Link HTTP header with rel=preload | boolean | `false` |  |
| `children` | CSS string to render inline | string | `null` |  |
| `renderChildrenInPlace` | Indicates if the children content should be rendered in place or the position is delegated to bundler | boolean | `true` |  |
| `critical` | If the file was not cached on the client yet renders its content inline and preloads the file to be cached for the next time | boolean | `false` |  |
| `firstRequestInlineStyles` | Options object for first request inline styles | object | `null` |  |
| `firstRequestInlineStyles.key` | Key used to create the cookie name | string |  | ✅ |
| `firstRequestInlineStyles.value` | Value that is compared to cookie one to determine if the content will be rendered inline | string |  | ✅ |

## Usage

### Linked application file
```jsx
const Style = require('frontend-style');

// Load the "main" styles bundle
module.exports = () => (
  <div>
    <Style href="main.css" />
  </div>
);
```

Renders:
```html
<head>
  ...
  <link href="/main.[checksum].css" rel="stylesheet" type="text/css" />
  ...
</head>
<body>
  ...
  <div><div>
  ...
</body>
```

### Embedded application file
```jsx
const Style = require('frontend-style');

// Embed the content of "main" styles bundle
module.exports = () => (
  <div>
    <Style
      href="main.css"
      inline={true}
    />
  </div>
);
```

Renders:
```html
<head>
  ...
  <style>
    /* main.css file content */
  </style>
  ...
</head>
<body>
  ...
  <div><div>
  ...
</body>
```

### Embedded string
```jsx
const Style = require('frontend-style');

module.exports = () => (
  <div>
    <Style renderChildrenInPlace={false}>
      {'.white-color { color: white; }'}
    </Style>
  </div>
);
```

Renders:
```html
<head>
  ...
  <style>
    .white-color { color: white; }
  </style>
  ...
</head>
<body>
  ...
  <div><div>
  ...
</body>
```

### Embedded string in-place
This approach renders the style tag where do you use the `Style` component.

:warning: If you want to render the style content at the head see the [Embedded string](#embedded-string) example.

```jsx
const Style = require('frontend-style');

module.exports = () => (
  <div>
    <Style>
      {'.white-color { color: white; }'}
    </Style>
  </div>
);
```

Renders:
```html
<head>
  ...
</head>
<body>
  ...
  <div>
    <style>
      .white-color { color: white; }
    </style>
  <div>
  ...
</body>
```


### Application file with [first request inline styles for application resources](#application-resources)
```jsx
const Style = require('frontend-style');

// Embed the content of "main" styles bundle if the file is not cached
module.exports = () => (
  <div>
    <Style href="main.css" critical={true} />
  </div>
);
```

Assuming `'homes'` is the value for [layoutOptions.criticalPath.key](https://github.com/mercadolibre/frontend-layout#criticalpath), if the request `c_homes` cookie value matches the application version number it renders:
```html
<head>
  ...
  <link href="/main.[checksum].css" rel="stylesheet" type="text/css" />
  ...
</head>
<body>
  ...
  <div><div>
  ...
</body>
```

While if not, it renders:
```html
<head>
  ...
  <style>
    /* main.css file content */
  </style>
  ...
</head>
<body>
  ...
  <div><div>
  ...
</body>
```

### External file with [first request inline styles for external resources](#external-resources)
```jsx
const Style = require('frontend-style');

module.exports = () => (
  <div>
    <Style
      href="https://http2.mlstatic.com/ui/navigation/5.6.0/mercadolibre/navigation-desktop.css"
      firstRequestInlineStyles={{
        key: 'ui-navigation',
        value: '5.6.0',
      }}
    >
      {'.header { background-color: yellow; }'}
    </Style>
  </div>
);
```
If the request `c_ui-navigation` cookie value matches `'5.6.0'` it renders:
```html
<head>
  ...
  <link href="https://http2.mlstatic.com/ui/navigation/5.6.0/mercadolibre/navigation-desktop.css" rel="stylesheet">
  ...
</head>
<body>
  ...
  <div><div>
  ...
</body>
```

While if not, it renders:
```html
<head>
  ...
  <style>
    .header { background-color: yellow; }
  </style>
  ...
</head>
<body>
  ...
  <div><div>
  ...
</body>
```

### Preload a specific CSS file as part of the Link HTTP header
```jsx
const Style = require('frontend-style');

// Preload the "main" styles bundle
module.exports = () => (
  <div>
    <Style href="main.css" preload />
  </div>
);
```

Renders:
```html
<head>
  ...
  <link href="/main.[checksum].css" rel="stylesheet" type="text/css" />
  ...
</head>
<body>
  ...
  <div><div>
  ...
</body>
```

With the response header `Link: /main.[checksum].css; rel=preload; as=style`, loading the file in parellel with the document

### Add an specific [media attribute](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/link#Conditionally_loading_resources_with_media_queries)
```jsx
const Style = require('frontend-style');

// Apply CSS only when viewport is greater than 600px
module.exports = () => (
  <div>
    <Style
      href="main.css"
      media="(min-width: 600px)"
    />
  </div>
);
```

Renders:
```html
<head>
  ...
  <link href="/main.[checksum].css" rel="stylesheet" type="text/css" media="(min-width: 600px)"/>
  ...
</head>
<body>
  ...
  <div><div>
  ...
</body>
```

## Bundler
The bundler generates the necessary markup to load the request styles. It is included into [Nordic](https://github.com/mercadolibre/frontend-nordic/tree/master/packages/nordic), so if you are using Nordic you don't have to worry about this bundler at all.

```js
const Style = require('frontend-style');
const StylesBundler = require('frontend-style/bundler');

const bundler = new StylesBundler({
  basePath: 'build',
  criticalKey: 'vip',
  criticalCookiePath: '/',
  criticalCookieDomain: 'article.mercadolibre.com.ar',
});

const result = bundler.bundle(req, res, Style);
/* result
{
  styles: String,
  preload: String,
}
*/
```

### Constructor parameters
| Name | Description | Type | Default | Required |
| --- | --- | --- | --- | --- |
| `options` | Options object | Object | - | ✅ |
| `options.basePath` | Path used as a suffix for application resources | String | - | ✅ |
| `options.criticalKey` | Determines [first request inline styles](#first-request-inline-styles) cookie name | (String-Boolean) | `null` | |
| `options.criticalCookiePath` | Determines [first request inline styles](#first-request-inline-styles) cookie path | String | `null` |  |
| `options.criticalCookieDomain` | Determines [first request inline styles](#first-request-inline-styles) cookie domain | String | `null` |  |

#### basePath
When `Style` component `href` prop refers to a local file (eg: `'main.css'`) this base path is prepended to the local file name.

#### criticalKey
To enable the first request inline styles for application resources feature you should pass the `criticalKey`.

If the value is equal to `true` the first request inline styles feature will be enabled with no cookie handling. If you plan to manage cookie handing by yourself, set `criticalKey` to `true`.

Otherwise you should pass a key that will be used to determine first request inline styles cookie name.

#### criticalCookiePath
This parameter is optional but it is highly recommended, be as much precise as possible. Eg: If your app lives under the `/vehiculos` base path by setting this parameter to `'/vehiculos'` the first request inline styles cookie will be avaiable only under this path and
will not pollute other applications.

#### criticalCookieDomain
This parameter is optional too, but `criticalCookiePath` advices applies to `criticalCookieDomain`. Please avoid usage of generic values like a `mercadolibre.com.ar` when possible.

## First request inline styles
This approach renders inline styles when a resource is not cached by the browser.

In order to accomplish that, each time a CSS resource is cached by the browser a cookie is set with the resource version number as a value. So the cookie is evaluated on each request to see if its value matches with the expected one (resource version number).

If there's no cookie or the cookie value does not match with the expected version number:
  - The style is rendered inline (`<style>...</style>`), avoiding resource round trip.
  - The response prefetchs the external resource, caching its content in the browser.
  - A cookie is set with the external resource version number.

If there's a cookie and its value matches the expected version number:
  - Linked style are rendered (`<link href="..." rel="stylesheet/css">`). As a previous request prefetched this resource, its content will avaiable on the browser cache.

### How to use it?
#### Application resources
To enable first request inline styles with application CSS content use the `critical` prop with the `true` value and the `href` prop with the application resource file name. This loads the file content from your local built file, and uses the [`criticalPath.key` `frontend-layout`](https://github.com/mercadolibre/frontend-layout#criticalpath) configuration as part of the cookie name and the application version number as part of the cookie value.
Eg:
```jsx
<Style href="main.css" critical={true} />
```

#### External resources
To enable first request inline styles with external resources use the `firstRequestInlineStyles` prop, it should be an object containing the `key` property (usually your external resource id) that determines the cookie name, and the `value` property (usually your external resource version) that is compared against the request cookie value to determine if the resource was cached or not by the browser.

You can use the `href` property with the external resource URL, and the `children` property with the file content.
Eg:
```jsx
<Style
  href="https://http2.mlstatic.com/ui/navigation/5.6.0/mercadolibre/navigation-desktop.css"
  firstRequestInlineStyles={{
    key: 'ui-navigation',
    value: '5.6.0',
  }}
>
  {'.header { background-color: yellow; }'}
</Style>
```
