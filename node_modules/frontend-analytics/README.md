# Frontend Analytics

> Mercado Libre Node.js adapter for Google Analytics

The main goal of this module is to build a platform dependent tracking
 code for client according to predefined dimensions and variables inside
 the Mercado Libre and transform it to Google Analytics compatible one.

*Note*: For any additional information about Meli Analytics please see
 [the official website](https://sites.google.com/mercadolibre.com/baanalytics/home).

## Installation

```bash
npm install frontend-analytics
```

## Usage

### Tracking code

The general functionality consists in framework independent module that
 builds the tracking code:

```js
const analytics = require('frontend-analytics');

const trackingCode = analytics.track(req, {
  siteId: 'MLA',
  platform: 'ML',
  business: 'MARKETPLACE',
  pageVertical: 'CORE',
  section: 'VIP',
  page: '/ITEM/MAIN',
  pageCategoryL1: 'MLA1051',
  search: 'iphone',
});

res.send(`<html><head><script>${trackingCode}</script></head></html>`);
```

### Usage inside the views written in React

Tracking script can be configured inside the React components.
```jsx
const MeliGA = require('frontend-analytics/meli-ga');

const DemoView = (props) => (
  <div>
    <MeliGA section="vip" page="item/main" />
  </div>
);
```

The code above will collect the configuration object but will not render
 the final tracking code. This is occurs since the tracking code
 should be rendered in a some specific place in the document's head and
 cannot be rendered just in any place, or better saying in place where
 it was called.

To obtain the tracking code from React components there is the `bundle`
 helper that should be called on server-side.

```jsx
const ReactDOMServer = require('react-dom/server');
const MeliGA = require('frontend-analytics/meli-ga');
const bundleMeliGA = require('frontend-analytics/bundle');

// Render the app
const html = ReactDOMServer.renderToStaticMarkup(App);

// Obtain the Meli Analytics config from React components and get the tracking code
analyticsScript = bundleMeliGA(req, MeliGA);
```

> Be aware that in [Nordic Apps](https://github.com/mercadolibre/frontend-nordic/) **without custom layouts**, the minimal required implementation for this component is already done by [frontend-layout](https://github.com/mercadolibre/frontend-layout) and in most cases you will only need to make use of the component without taking care of how and where to render the final code.

### Usage inside the webviews

When the page is accessed from a webview, we want all Google Analytics (GA) tracks to be sent by the native application. To achieve this, we serve an internally developed GA library, which maintains the same API as the original one but instead of connecting with GA, it connects to the native application through a bridge. Each time the webview generates a track, this library collects the data from it and sends it to the native app to impact it on GA.

To decide which library to load we evaluate the value of the variable `req.device.isWebview`. If it exists, the reduced version for native apps is loaded and the original version is loaded.

## Configuration properties

- `section`: `required` - Describes the MELI's ecosystem section. Examples: `'vip'`, `'checkout'`, `'home'`, `'registration'`.
- `siteId`: `required` - The current site ID, i.e: `'MLA'`, `'MLB'`, etc. Is `optional` when rendering with `frontend-analytics/bundle` helper.
- `platform`: `required` - Current platform ID. Marketplace = `'ML'`, MercadoPago = `'MP'`, TuCarro = `'TC'`, MercadoShops = `'MS'`. Is `optional` when rendering with `frontend-analytics/bundle` helper.
- `page`: `optional` - The page name to use for tracking. If not provided `location.pathname` will be used.
- `business`: `optional` - Specify if it is a `MARKETPLACE` or `CLASSIFIED` page. If not specified or provided an another value `'NONE'` will be used.
- `vertical`: `optional` - This is the Vertical of the item or category for the current page. The allowed values are: [`'MOTORS'`, `'REAL_ESTATE'`, `'SERVICES'`, `'CORE'`, `'APPAREL'`]. Defaults to `'NONE'`
- `pageCategoryL1`: `optional` - Specify the Level 1 category if available for the current page.
- `pathFromRoot`: `optional` - This is the pathFromRoot object from the API as it is, no modifications needed. The plugin will extract all the categories inside this object if available. This is optional but recommended at least for MARKETPLACE.
- `pageLayout`: `optional` - Specify the layout of the current page. Examples: `listing`, `map`, `gallery` for different layouts of the search page.
- `search`: `optional` - The last search term from the user's search.
- `isDeferred`: `optional` - Specify if should track immediately or wait for any manual track. 
- `optimizeId`: `optional` - Google Optimize identificator, see more info on https://marketingplatform.google.com/about/optimize/
- `enableOptimize`: `optional` - When it is `true` will load the Google Optimize plugin by using the preconfigured `ID` but only if it exists in config. Preconfigured identifier may be overridden with `optimizeId`
- `preventOptimizeFlickering`: `optional` - When `true` installs the anti-flicker snippet for Google Optimize which will hide the page until Optimize is loaded. As fallback in case Optimize fails, the page will remain hidden 4s
- `dimensions`: `optional` - A prop to specify MeLi custom dimensions for sending to Google Analytics. It has format of `key-value map`.

## Important notes

- Using the plugin in an environment different to production will use a tracker different than in production.
- For development or testing environment you should use a valid Meli domain, e.g. add `desa.mercadolibre.com.ar` to you `/etc/hosts` and use it.
- If the platform is not defined inside the config object on `./config/analytics.js`, the configuration will fallback to the default platform, which currently is 'ml' (e.g. Mercado Shops or 'ms' is not defined, so 'ml' is being used).
