# Platform Detection

> A middleware to resolve Mercado Libre platforms for a given domain.

## Installation

```sh
npm install frontend-platform_detection
```

## Usage

```js
const express = require('express');
const app = express();
const { platformDetectionMiddleware } = require('frontend-platform_detection');
// Or the legacy way
const platform = require('frontend-platform_detection');

app.use(platformDetectionMiddleware);

// Navigate to www.mercadolibre.com.ar/
app.use('/', (req, res, next) => {
  console.log(req.platform.id); // ML
  console.log(req.platform.countryId); // AR
  console.log(req.platform.siteId); // MLA
  next();
});
```

### Override the domain

In cases when valid Mercado Libre domain cannot be used the domain name
can be overriden by using the `domain_override` querystring parameter.

For example, `http://test.demo-app.melifrontends.com/?domain_override=mercadopago.com.br`
will be interpreted as a valid Mercado Pago domain:

```js
console.log(req.platform);
/*
{  
  id: 'MP',
  countryId: 'BR',
  siteId: 'MLB',
  domain: 'mercadopago.com.br'
}
*/
```

**Note**: Override is possible only when the app is accessing from an unknown
domain, so `http://www.mercadolibre.com.ar/?domain_override=mercadopago.com.br`
will not work.

### Alternative domains

In *development* and *testing* environments it is possible to use an alternative domains. It may be useful in cases when
the usage of original domains is complicated due to special environment conditions such as [HSTS with preload](https://tools.ietf.org/html/rfc6797#section-12.3).
In most cases the domain name consists of a `local` word, a word that identifies the brand and a TLD that identifies
a country. But historically there is no a unique pattern, so please consider checking the complete list below:

| Platform | Site | Domain                              | Alt domain                       |
| -------- | ---- | ----------------------------------- | -------------------------------- |
| ML       | MSV  | `mercadolibre.com.sv`               | `localhost.com.sv`               |
| ML       | MNI  | `mercadolibre.com.ni`               | `localhost.com.ni`               |
| ML       | MGT  | `mercadolibre.com.gt`               | `localhost.com.gt`               |
| ML       | MLC  | `mercadolibre.cl`                   | `localhost.cl`                   |
| ML       | MEC  | `mercadolibre.com.ec`               | `localhost.com.ec`               |
| ML       | MHN  | `mercadolibre.com.hn`               | `localhost.com.hn`               |
| ML       | MPE  | `mercadolibre.com.pe`               | `localhost.com.pe`               |
| ML       | MLU  | `mercadolibre.com.uy`               | `localhost.com.uy`               |
| ML       | MRD  | `mercadolibre.com.do`               | `localhost.com.do`               |
| ML       | MCR  | `mercadolibre.co.cr`                | `localhost.co.cr`                |
| ML       | MLA  | `mercadolibre.com.ar`               | `localhost.com.ar`               |
| ML       | MBO  | `mercadolibre.com.bo`               | `localhost.com.bo`               |
| ML       | MCO  | `mercadolibre.com.co`               | `localhost.com.co`               |
| ML       | MLV  | `mercadolibre.com.ve`               | `localhost.com.ve`               |
| ML       | MPA  | `mercadolibre.com.pa`               | `localhost.com.pa`               |
| ML       | MLM  | `mercadolibre.com.mx`               | `localhost.com.mx`               |
| ML       | MPY  | `mercadolibre.com.py`               | `localhost.com.py`               |
| ML       | MLB  | `mercadolivre.com.br`               | `localhost.com.br`               |
| ML       | MPT  | `mercadolivre.pt`                   | `localhost.pt`                   |
| ML       | MCU  | `mercadolibre.com.cu`               | `localhost.com.cu`               |
| ML       | CBT  | `global-selling.mercadolibre.com`   | `global-selling.localhost.com`   |
| ML       | CBT  | `title-translator.mercadolibre.com` | `title-translator.localhost.com` |
| MP       | MCO  | `mercadopago.com.co`                | `localpago.com.co`               |
| MP       | MLA  | `mercadopago.com.ar`                | `localpago.com.ar`               |
| MP       | MLB  | `mercadopago.com.br`                | `localpago.com.br`               |
| MP       | MLC  | `mercadopago.cl`                    | `localpago.cl`                   |
| MP       | MLM  | `mercadopago.com.mx`                | `localpago.com.mx`               |
| MP       | MLU  | `mercadopago.com.uy`                | `localpago.com.uy`               |
| MP       | MLV  | `mercadopago.com.ve`                | `localpago.com.ve`               |
| MP       | MPE  | `mercadopago.com.pe`                | `localpago.com.pe`               |
| MS       | MLA  | `mercadoshops.com.ar`               | `localshops.com.ar`              |
| MS       | MLB  | `mercadoshops.com.br`               | `localshops.com.br`              |
| MS       | MLC  | `mercadoshops.cl`                   | `localshops.cl`                  |
| MS       | MCO  | `mercadoshops.com.co`               | `localshops.com.co`              |
| MS       | MLV  | `mercadoshops.com.ve`               | `localshops.com.ve`              |
| MS       | MLM  | `mercadoshops.com.mx`               | `localshops.com.mx`              |
| MT       | MLM  | `metroscubicos.com`                 | `localmetros.com`                |
| GI       | MLM  | `guiadinmuebles.com`                | ---                              |
| PI       | MLC  | `portalinmobiliario.com`            | `localportal.com`                |
| TI       | MCO  | `tuinmueble.com.co`                 | `tuinhost.com.co`                |
| TI       | MLV  | `tuinmueble.com.ve`                 | `tuinhost.com.ve`                |
| TC       | MCO  | `tucarro.com.co`                    | `tucahost.com.co`                |
| TC       | MLV  | `tucarro.com.ve`                    | `tucahost.com.ve`                |
| TM       | MCO  | `tumoto.com.co`                     | `tumohost.com.co`                |
| TM       | MLV  | `tumoto.com.ve`                     | `tumohost.com.ve`                |
| TL       | MCO  | `tulancha.com.co`                   | `tulahost.com.co`                |
| TL       | MLV  | `tulancha.com.ve`                   | `tulahost.com.ve`                |
| AP       | MLM  | `autoplaza.com.mx`                  | `autohost.com.mx`                |
| BC       | MLB  | `becommerce.com.br`                 | `localbecom.com.br`              |
| BO       | ALL  | `adminml.com`                       | ---                              |

## API

### platformDetectionMiddleware

A middleware function to resolve Mercado Libre platforms. It should resolve the `countryId`, `siteId`, `domain` and `id` for a given domain.

#### req.platform

#### req.platform.countryId

#### req.platform.siteId

#### req.platform.id

#### req.platform.domain

### platform.domains

A collection of all available Mercado Libre platforms. Each platform, should have the following structure:

```json
{
  "countryId": "AR",
  "siteId": "MLA",
  "id": "ML",
  "domain": "mercadolibre.com.ar"
}
```

### getPlatform

Function to get the platform information from a hostname. Also used to know if a certain hostname corresponds to one of Meli platforms.

```js
const { getPlatform } = require('frontend-platform_detection');

const platform = getPlatform(req.hostname); // Example hostname: www.mercadopago.com.ar

if (platform) {
  console.log(platform);
  /*
  {  
    id: 'MP',
    countryId: 'AR',
    siteId: 'MLA',
    domain: 'mercadopago.com.ar'
  }
  */
} else {
  console.log(platform);
  // undefined
}
```

## License

Copyright Â© 2022.
