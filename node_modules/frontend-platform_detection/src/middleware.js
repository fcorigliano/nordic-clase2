/**
 * Module dependencies
 */
const log = require('frontend-logger')('frontend-platform_detection');
const platform = require('./platform');

/**
 * Expose middlware
 * Adds platgorm siteId, countryId, id, locale and domain properties to req.platform object.
 */
module.exports = function platformDetection(req, res, next) {
  // If platform is already defined by other middleware, we will skip the detection
  if (req.platform) {
    return next();
  }
  req.platform = platform(req.hostname);

  // Allow to override the domain name by using the "domain_override" querystring parameter
  if (!req.platform && req.query.domain_override) {
    req.platform = platform(req.query.domain_override);
  }

  if (!req.platform) {
    log.error('Could not detect request platform', {
      hostname: req.hostname,
      domain_override: req.query.domain_override,
    });
  }
  return next();
};
