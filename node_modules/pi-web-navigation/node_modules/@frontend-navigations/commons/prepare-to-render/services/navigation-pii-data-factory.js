const { VaultClient } = require('node-vault-client');
const { PRODUCTION } = require('frontend-env');
const { token } = require('../../constants/pii');

const { getPIIUserData } = new VaultClient(token, {
  timeout: PRODUCTION ? 100 : 3000,
  retry: {
    strategy: 'linear',
    maxRetries: 0,
    delay: 20,
  },
});

const defaultData = {};

const serviceFactory = options => (req) => {
  if (!req.user) {
    return Promise.resolve(defaultData);
  }

  return getPIIUserData({
    req,
    userProperties: options.userProperties,
  })
  .then(options.mapper)
  .catch((err) => {
    options.logger.error({
        req,
        err,
        errorType: 'pii-data',
        message: (err || {}).stack,
      });

    return defaultData;
  });
};

module.exports = serviceFactory;

