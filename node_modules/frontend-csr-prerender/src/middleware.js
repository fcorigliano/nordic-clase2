/* eslint-disable consistent-return */

const makeLink = (url, rel, as) => `<${url}>; rel=${rel}; as=${as}`;

const csrPrerenderMiddleware = (config = () => {}) =>
  function middleware(req, res, next) {
    if (req.device.webView) {
      const etag = req.app.get('etag fn')(req.keyForEtag);
      res.set('ETag', etag);

      const data = config(req, res);

      if (!data) {
        return next();
      }

      const prefetches = data.prefetches
        ? data.prefetches.map(prefetch => makeLink(prefetch, 'prefetch', 'document'))
        : [];
      const preloads = data.preloads
        ? data.preloads.map(preload => makeLink(preload, 'preload', 'fetch'))
        : [];

      const links = prefetches.concat(preloads).join(',');

      const prevLinks = res.getHeader('Link') ? `${res.getHeader('Link')},` : '';

      if (prevLinks || links) {
        res.header('Link', `${prevLinks}${links}`);
      }
    }

    next();
  };

module.exports = csrPrerenderMiddleware;
exports = module.exports;
exports.csrPrerenderMiddleware = csrPrerenderMiddleware;
