# Device Detection

> A middleware to resolve user device.

## Installation

```
npm install frontend-device_detection
```

## Usage

```js
const express = require('express');
const detect = require('frontend-device_detection');
const app = express();

app.use(detect);

app.use('/', (req, res, next) => {
  console.log(req.device);
  console.log(req.browser);
  next();
});
```

## API

### `req.device`

- `type`: String. Example: `"desktop"`.
- `mobile`: Boolean. Example: `false`.
- `tablet`: Boolean. Example: `false`.
- `desktop`: Boolean. Example: `true`.
- `originalType`: String. Example: `false`.
- `forced`: Boolean. Example: `"desktop"`.
- `lowEnd`: Boolean. Example: `false`.
- `webView`: Boolean. Example: `false`.
- `nativeWebview`: Boolean. Example: `false`.
- `webviewUserAgent` Object. Like `req.browser` with original user-agent from webviews
- `osName`: String. Example: `"mac os"`.
- `osVersion`: String. Example: `"10.11.6"`.
- `pciCompliant`: Boolean. Example: `true`.
- `appCapable`: Boolean. Example: `true`.


The following properties are not defined [for all devices](https://caniuse.com/#search=client-hints). These properties are a set of opt-in HTTP request headers that give us insight into these aspects of the user’s device and the network they’re connected to.
[See more informaction about client hints](https://developers.google.com/web/fundamentals/performance/optimizing-content-efficiency/client-hints/).
- `memory`: String. Indicates device capability for memory i.e. device RAM, in order to enable web apps to customize content depending on device memory constraints. Example: `"8"`
- `dpr`: String. Indicates the client's current Device Pixel Ratio (DPR). Example: `"2"`
- `viewportWidth`: String. Indicates the layout viewport width in CSS px. Example: `"1440"`
- `rtt`: String. Indicates the effective round-trip time estimate in milliseconds, rounded to nearest multiple of 25 milliseconds, and is based on recently observed application-layer RTT measurements across recently active connections. Example: `"300"`
- `downlink`: String. Indicates the effective bandwidth estimate in megabits per second, rounded to nearest multiple of 25 kilobits per second, and is based on recently observed application layer throughput across recently active connections. Example: `"8.55"`
- `ect`: String. Represents the effective connection type of the current connection. Example: `"4g"`
- `saveData`: String. Indicates user agent's preference for reduced data usage. Example: `"off"`

##### `req.device.nativeApp` _only when webView is true_
- `name`: String. Example: `"MercadoLibre"`.
- `os`: String. Example: `"iOS"`.
- `version`: String. Example: `"2.70.1"`. 

##### `req.device.nativeWebview` _is true only when webView and header x-webkit-landing is true_
For develop force header `x-webkit-landing=true` in the request
- `nativeWebview`: Boolean.


### `req.device.appCapable` _is true only when the native app (identified by the platform) can be installed_ 
- `appCapable`: Boolean.

### `req.browser`

- `support`: Object. See below.
- `name`: String. Example: `"chrome"`.
- `version`: String. Example: `"54.0.2840"`.
- `major`: Number. The major browser's version number. Example: `54`.
- `minor`: Number. The minor browser's version number. Example: `0`.
- `patch`: Number. The patch browser's version number. Example: `2840`.
- `userAgent`: String. Example: `"Chrome 54.0.2840 / Mac OS X 10.11.6"`.
- `outdated`: Boolean. Indicates if a browser is outdated for MELI. Example: `false`.

#### `req.browser.support`

- `webp`: Boolean. Example: `true`.
- `prefetch`: Boolean. Example: `true`.
- `preconnect`: Boolean. Example: `true`.
- `pushNotifications`: Boolean. Example: `true`.
- `serviceWorkers`: Boolean. Example: `true`.
- `brotli`: Boolean. Example: `true`.
- `sameSite`: Boolean. Example: `true`. _The `true` value is only when browser has complete SameSite support without [any known issues](https://www.chromium.org/updates/same-site/incompatible-clients)_

#### `req.browser.device`
- `vendor`: String. Example: `HTC`.
- `model`: String. Example: `Evo Shift 4G`.
- `type`: String. Example: `mobile`.


#### PCI compliance notes
`req.device` defines the property `pciCompliant` that indicates is the device is compliant with
 [PCI Security Standards Council](https://www.pcisecuritystandards.org/). PCI is an international open group formed to
 develop and assist with the understanding of security standards for payment account security. The founding and principal
 members are American Express, Discover, JCB, MasterCard, and Visa. The latest requirement of the working group is described
 in [its blog post](https://blog.pcisecuritystandards.org/are-you-ready-for-30-june-2018-sayin-goodbye-to-ssl-early-tls).
 In a few words both SSL and early TLS (mean TLS 1.0) should be disabled on any points where user interacts with its payment
 data, but disabling of insecure protocols is not requiered on the entire web site. Some older devices has no support of
 more recent TLS 1.1+ and fails with connection error. So on most parts of the ecosystem of Mercado Libre user still can
 navigate with outdated browsers but that browsers will be marked as non PCI compliant.

#### PCI non compliant definitions:

Browser | Versions | Notes
-- | -- | --
Google Chrome | 1 - 21 |  
Firefox | 1 - 23 |  
Internet Explorer | 1 - 10 | IE10 TLS 1.1 disabled by default
Internet Explorer Mobile | 7 - 10 |  
Safari | 1 - 6 |  
Mobile Safari | 3 - 4 |  
Opera | 1 - 12 | OK in 12.16
Opera Mini | 1 - 4 | OK with Opera 12.16 engine
Android browser | 1 - 4.4.4 |  

#### Low-end definitions

<table>
  <tr>
    <td><b>Target</b>
   </td>
    <td><b>Versions and details</b>
   </td>
  </tr>
  <tr>
   <td>Spice
   </td>
   <td>All versions
   </td>
  </tr>
  <tr>
   <td>Blackberry
   </td>
   <td>All Blackberry, including BlackBerry 10
   </td>
  </tr>
  <tr>
   <td>Samsung
   </td>
   <td>SAMSUNG-GT-C3322, SAMSUNG-GT-E2200, SAMSUNG-GT-S5222,
    <p>
    SAMSUNG-GT-S3570/S3570XILH1,
    </p>
    <p>
    SAMSUNG-GT-S3570
    </p>
   </td>
  </tr>
  <tr>
   <td>Weblight
   </td>
   <td>It's a google process that runs on websites. It applies only to redirects from google search on slow android devices using chrome or android web v2.3 and upper versions. More info <a href="https://support.google.com/webmasters/answer/6211428?hl=es">here</a>.
   </td>
  </tr>
  <tr>
   <td>Symbian
   </td>
   <td>All versions
   </td>
  </tr>
  <tr>
   <td>Opera Mini
   </td>
   <td>All versions
   </td>
  </tr>
  <tr>
   <td>Windows Phone
   </td>
   <td>All versions
   </td>
  </tr>
  <tr>
   <td>IE
   </td>
   <td>Version 10 and prior versions
   </td>
  </tr>
  <tr>
   <td>Nokia
   </td>
   <td>All versions
   </td>
  </tr>
  <tr>
   <td>LG-C y LG-T
   </td>
   <td>All versions
   </td>
  </tr>
  <tr>
   <td>AppleWebKit 
   </td>
   <td>Versions prior to v536. This imposes a restriction on Chrome, Safari and Android Browser. See each definition on this table.
   </td>
  </tr>
  <tr>
   <td>Firefox
   </td>
   <td>Version 23 and prior versions
   </td>
  </tr>
  <tr>
   <td>Chrome
   </td>
   <td>Version 20 and prior versions since they used AppleWebKit &lt;= v536
   </td>
  </tr>
  <tr>
   <td>Safari
   </td>
   <td>Version 6 and prior versions since they used AppleWebKit &lt;= v536
   </td>
  </tr>
  <tr>
   <td>Android Browser
   </td>
   <td>All versions. Since they used AppleWebKit &lt;= v536
   </td>
  </tr>
</table>

#### Outdated browser definitions

- Any browser set as low-end is considered outdated.
- Browsers are considered outdated about 18 months after their release.
- For now we are checking these browsers as outdated.

| Browser | Versions | Notes |
| -- | -- | -- |
| IE | * | All versions |
| IEMobile | * | All versions |
| Edge | &lt;= Engine v16 - Release v41 | [changelog](https://en.wikipedia.org/wiki/Microsoft_Edge) |
| Google Chrome | &lt;= v66 | [changelog](https://en.wikipedia.org/wiki/Google_Chrome_version_history) |
| Firefox | &lt;= v62 | [changelog](https://www.mozilla.org/en-US/firefox/releases/) |
| Safari | &lt;= v10 | [changelog](https://en.wikipedia.org/wiki/Safari_version_history#Mac) |
| Mobile Safari | &lt;= v10 | [changelog](https://en.wikipedia.org/wiki/Safari_version_history#iOS) |

## License

Copyright © 2020.
