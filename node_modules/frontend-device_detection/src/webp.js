/**
 * Utility method that checks the WebP support by user-agent sniffing
 * @param agent
 * @returns {boolean}
 */
function isAgentSupportsWebp(agent) {
  if (!agent || !agent.browser || !agent.browser.name) {
    return false;
  }

  const browser = agent.browser.name.toLowerCase();
  const isIOsMobile = agent.device?.type === 'mobile' && agent.os.name === 'iOS';

  return (browser === 'firefox' && agent.major >= 65)
    || (browser.startsWith('chrome') && !isIOsMobile && agent.major >= 32)
    || (browser === 'edge' && agent.major >= 18)
    || (browser === 'opera' && agent.major >= 19);
}

/**
 * Exports module to analize the header "accept" to determine if the device supports WebP
 * @returns Boolean
 */
module.exports = (acceptHeader, agent) => /\bimage\/webp\b/.test(acceptHeader) || isAgentSupportsWebp(agent);
