const { getD2Id } = require('@frontend-cookies-manager/common/src/services/d2id');
const { getConfig, applicationName } = require('./config');

const calculatePercent = function calculatePercent(req) {
  const d2Id = getD2Id({ req });

  if (!d2Id) {
    return null;
  }

  // eslint-disable-next-line no-return-assign,no-param-reassign
  return d2Id.split('').reduce((acc, ch) => (acc += parseInt(ch.charCodeAt(0).toString(10), 10)), 71) % 100;
};

// eslint-disable-next-line no-unused-vars
const trafficControl = function trafficControl(req, frontendConfigEnvironment) {
  try {
    if (!req.platform || !req.device) return null;

    const trafficConfig = getConfig(req);

    if (!trafficConfig) return null;

    const { blacklist, percent } = trafficConfig;

    if (blacklist.includes(applicationName)) return null;

    const exposition = calculatePercent(req);

    if (exposition === null) {
      return null;
    }

    if (percent === 0) {
      return null;
    }

    return exposition <= percent;
  } catch (e) {
    return null;
  }
};

module.exports = {
  trafficControl,
  calculatePercent,
};
