const { baseKey } = require('../constants/statsd');

const getService = () => require('./statsd');

const applicationId = 'some-application-id';
const scopeId = 'some-scope-id';
const key = 'some-key';

const mockStatsd = () => {
  const histogram = jest.fn();
  jest.doMock('frontend-statsd/internal', () => ({ histogram }));

  const assertStatsdCalled = ({ extraTags } = {}) => {
    expect(histogram).toHaveBeenCalledWith(`${baseKey}.${key}`, 1, {
      applicationId,
      scopeId,
      ...extraTags,
    });
  };

  const assertStatsdNotCalled = () => {
    expect(histogram).not.toHaveBeenCalled();
  };

  return {
    assertStatsdCalled,
    assertStatsdNotCalled,
  };
};

const mockEnv = ({
  FURY,
  PRODUCTION,
} = {}) => {
  jest.doMock('frontend-env', () => ({
    FURY: FURY !== false,
    PRODUCTION: PRODUCTION !== false,
    APPLICATION: applicationId,
    SCOPE: scopeId,
  }));
};

describe('Statsd service', () => {
  beforeEach(() => jest.resetModules());

  describe('send', () => {
    it('should skip send if FURY env variable is not truthy', () => {
      mockEnv({ FURY: false });
      const { assertStatsdNotCalled } = mockStatsd();

      const { send } = getService();

      send(key);

      assertStatsdNotCalled();
    });

    it('should skip send if PRODUCTION env variable is not truthy', () => {
      mockEnv({ PRODUCTION: false });
      const { assertStatsdNotCalled } = mockStatsd();

      const { send } = getService();

      send(key);

      assertStatsdNotCalled();
    });

    it('should send with extra tags', () => {
      mockEnv();
      const { assertStatsdCalled } = mockStatsd();

      const { send } = getService();

      const extraTags = {
        someKey: 'some-value',
        someOtherKey: 'some-other-value',
      };
      send(key, extraTags);

      assertStatsdCalled({ extraTags });
    });
  });
});
