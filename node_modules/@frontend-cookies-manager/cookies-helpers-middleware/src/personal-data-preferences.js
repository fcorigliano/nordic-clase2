const {
  PERSONAL_DATA_PREFERENCES_ENVIRONMENT_HEADER_KEY: HEADER_KEY,
} = require('./constants/headers');
const {
  PERSONAL_DATA_PREFERENCES_DEFAULT_ENVIRONMENT_NAME: DEFAULT_ENVIRONMENT_NAME,
  PERSONAL_DATA_PREFERENCES_VALID_ENVIRONMENT_NAMES: VALID_ENVIRONMENT_NAMES,
} = require('./constants/environment');
const { labCookie } = require('./constants/cookies');

const hasMeliLabCookie = (req) => req && req.cookies && req.cookies[labCookie];
const getHeaderEnvironment = (req) => req && req.get && req.get(HEADER_KEY);
const isValidEnvironmentName = (environmentName) => environmentName
  && typeof environmentName === 'string'
  && VALID_ENVIRONMENT_NAMES.indexOf(environmentName) !== -1;

const getPersonalDataPreferencesUrls = (environmentName) => {
  const urlEnvironmentName = isValidEnvironmentName(environmentName) ? environmentName : DEFAULT_ENVIRONMENT_NAME;

  return {
    userPreferences: `/${urlEnvironmentName}/personal-data-preferences/preferences/users`,
    categories: `/${urlEnvironmentName}/personal-data-preferences/preferences/categories`,
  };
};

const getPersonalDataPreferencesEnvironmentName = (req) => {
  if (!hasMeliLabCookie(req)) {
    return DEFAULT_ENVIRONMENT_NAME;
  }

  const environmentName = getHeaderEnvironment(req);

  return isValidEnvironmentName(environmentName)
    ? environmentName
    : DEFAULT_ENVIRONMENT_NAME;
};

module.exports = {
  getPersonalDataPreferencesUrls,
  getPersonalDataPreferencesEnvironmentName,
};
