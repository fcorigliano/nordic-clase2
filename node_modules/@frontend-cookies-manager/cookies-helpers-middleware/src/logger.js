const NewRelic = require('newrelic');
const logger = require('frontend-logger')('@frontend-cookies-manager/cookies-helpers-middleware');
const env = require('frontend-env');

const { COOKIES_HELPERS_MIDDLEWARE_ERROR_NAMESPACE } = require('./constants/newrelic');

const error = (message, { req, error: errorParam } = {}) => {
  const logMessage = `${message}: ${(errorParam && errorParam.message) || 'No error message'}`;
  const platformWithDefault = (req || {}).platform || {};
  const statusCode = errorParam && errorParam.response && errorParam.response.status;
  const tags = {
    applicationId: env.APPLICATION || null,
    scopeId: env.SCOPE || null,
    platformId: platformWithDefault.id || null,
    siteId: platformWithDefault.siteId || null,
    domain: platformWithDefault.domain || null,
    statusCode,
  };

  if (env.PRODUCTION) {
    NewRelic.recordCustomEvent(COOKIES_HELPERS_MIDDLEWARE_ERROR_NAMESPACE, { error: logMessage, ...tags });
  } else {
    logger.error(logMessage, tags);
  }
};

module.exports = {
  error,
};
