const { renderType } = require('@frontend-cookies-manager/common/src/constants/experiments');
const {
  getRenderTypeExperimentConfig,
} = require('@frontend-cookies-manager/common/src/services/cookies-consent-experiment');

const {
  CookieConsentBannerOptOut,
  CookieDisclaimer,
} = require('../../lib/components'); // eslint-disable-line
const mapConsentProps = require('../components/commons/props');
const mapDisclaimerProps = require('../components/cookie-disclaimer/props');
const { componentVariantDefault } = require('../constants/experiments');
const { send } = require('./statsd');
const { componentVariantNotFound } = require('../constants/statsd');

const componentVariantsMap = {
  [renderType.variants.disclaimer]: {
    component: CookieDisclaimer,
    mapProps: mapDisclaimerProps,
  },
  [renderType.variants.optOutBottom]: {
    component: CookieConsentBannerOptOut,
    mapProps: mapConsentProps('cookie-consent-banner-opt-out'),
  },
  [renderType.variants.none]: {
    component: () => null,
    mapProps: () => null,
  },
};
componentVariantsMap[componentVariantDefault] = componentVariantsMap[renderType.variants.none];

const getComponentByExperimentVariant = ({
  platform,
  headers,
  cookies,
  req,
}) => {
  const renderTypeExperimentConfig = getRenderTypeExperimentConfig({
    platform,
    headers,
    cookies,
    req,
  });
  const variantKey = (renderTypeExperimentConfig || {})[renderType.variantKey] || componentVariantDefault;
  const component = componentVariantsMap[variantKey];

  if (!component) {
    send(componentVariantNotFound);
    return componentVariantsMap[componentVariantDefault];
  }

  return component;
};

module.exports = {
  getComponentByExperimentVariant,
};
