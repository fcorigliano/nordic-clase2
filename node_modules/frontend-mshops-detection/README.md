# Mercado Shops Detection

> A middleware to detect a request from Mercado Shops and to resolve its platform.
> It works both in subdomains of `mercadoshops.site` and delegated domains, due to its connection with the [Frontend-Wrapper API](https://github.com/mercadolibre/fury_mshops-frontend-wrapper).

> Modifies the request to add an attribute `req.platform` similar to the set by [platform-detection](https://github.com/mercadolibre/frontend-platform_detection). Also adds a `locals.mercadoShops` attribute to the response, with the data given by the Frontend-Wrapper API.

> In order to work over a meli domain (`mercadolibre.site`), `ms_store` query param must be present with the shop domain value in it, along with the header `X-Mshops` with it's value in `1`. If any of this conditions is not satisfied, the middleware will skip fetching shop data and setting the platform.

## Installation

```sh
npm install frontend-mshops-detection
```

## Usage

```js
const express = require('express');
const mshops = require('frontend-mshops-detection');
const app = express();

app.use(mshops);

// Navigate to test-mlb.mercadoshops.com.br
app.use('/', (req, res, next) => {
  console.log(req.platform.id); // MS
  console.log(req.platform.countryId); // AR
  console.log(req.platform.siteId); // MLA
  console.log(req.platform.shop);
  // { id: 181748368, name: 'Norauto', ... }
  console.log(res.locals.mercadoShops) // { shop: { … }, … }
  next();
});
```

## Config middleware in a nordic app
Set these properties in `config/default.js`:
```js

{
  ragnar: {
    middlewares: {
      mshopsDetection: true,  // Adds mshops-detection to ragnar middlewares
    },
  },
  mshopsDetection: {
    robots: false,            // add robots header when requesting to frontend-wrapper
    fetchShopData: {          // fetch the shop data from frontend-wrapper
      enabled: true,          // Turn on/off this feature
    },
    guestDetection: {         // guest-detection user
      enabled: false,         // Turn on/off this feature
      paths: [                // app routes to use (regex)
        /^\//,
      ],
    },
  },
}
```
The feature `fetchShopData`, if active, will make a request to frontend-wrapper, and fetch the shop data, and put it into `res.locals.mercadoShops.data`.

The feature `guestDetection`, if active, will redirect the browser to mercadolibre domain, to this endpoint: `/mercadoshops/check-session`, that will tell if the user has an active session at marketplace domain or not. Then will redirect the browser back to the shop domain, sending the guest data needed as query params. After that, the guest data query-params will be catch from the shop domain side, and will be stored as temporary cookies. As long as these cookies exist, there will no need to make more redirects to marketplace.

The `robots` property is used to determine if the request made to frontend-wrapper should add "X-Robot" header. This is useful to redirect the traffic to a specific scope of frontend-wrapper optimized for robots. By default, the property is set to `false`, and the `User-Agent` header will be checked to determine if the request should go to robots scope.

### Override the domain

For development enviroments, we have the possibility to override the domain used, adding in the url the query param `domain_override`

### Extra params

Also we can add `editable` and `preview` query params in the url to be included when requesting to Frontend Wrapper Api.

## API

### platform

A middleware function to resolve the platform for Mercado Shops' domains. It should resolve the `countryId`, `siteId`, `domain` and `id` for a given domain, and store in `res.locals.mercadoShops` the response of Frontend-Wrapper API.

#### req.platform

#### req.platform.countryId

#### req.platform.siteId

#### req.platform.id

#### req.platform.domain

#### req.platform.shop

Shop information for the current shop. If shop couldn't be detected or there was a problem requesting the shop info, this property will **NOT** be set.

Some of the most important properties inside the shop data are the following:

| Property |   Type   | Example | Description |
| -------- | -------- | ------- | ----------- |
| `id`     | `number` | `181748368` | Shop ID. This ID is the same as the User ID who is the owner of the shop, the one that created it. |
| `name`   | `string` | `'Norauto'` | Shop name |
| `site_id` | `string` | `'MLA'` | Site ID linked to the shop. |
| `country_id` | `string` | `'AR'` | Country ID |
| `domain` | `string` | `'www.shop.norauto.com.ar'` | Main domain for the current shop. This domain can be a delegated domain, which Meli is not the owner of, or a subdomain of Mercado Shops.<br />All shops with delegated domains can also be accessed with a MShops subdomain. In this example it would be `'norauto.mercadoshops.com.ar'`. |
| `subdomain` | `string` | `'norauto'` | Subdomain within MShops for this shop. |
| `home_url` | `string` | `'https://www.shop.norauto.com.ar'` | Home URL |
| `status` | `string` | `'active'` | Shop status |
| `date_created` | `string` | `'2018-12-20T17:20:53.000+0000'` | Date in ISO format the shop was created. |
| `last_updated` | `string` | `'2019-01-18T14:20:17.000+0000'` | Date in ISO format the shop was last updated. |

#### res.locals.mercadoShops

## License

© 2022 Mercado Libre
