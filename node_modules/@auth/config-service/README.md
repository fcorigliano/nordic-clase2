# Configuration Service

## Table of Contents

- [Configuration Service](#configuration-service)
  - [Table of Contents](#table-of-contents)
  - [Description](#description)
  - [How it works](#how-it-works)
  - [Usage](#usage)
    - [Installation](#installation)
    - [Examples](#examples)
    - [Force to fetch or not from Config API](#force-to-fetch-or-not-from-config-api)
    - [Use Config API test scope](#use-config-api-test-scope)
  - [Utils](#utils)
    - [`getPropFromObject`](#getpropfromobject)
    - [`mapObjectProps`](#mapobjectprops)
    - [`mapHeaders`](#mapheaders)
    - [`cookiesObjectToHeader`](#cookiesobjecttoheader)
  - [Utils complete example](#utils-complete-example)
  - [Tests](#tests)
  - [Contributing](#contributing)
  - [Changelog](#changelog)
  - [License](#license)

## Description

> Configuration Service to fetch and update the configs for a certain app or plugin.

## How it works

⚠️ This service will work as a Singleton as long as only one copy (version) of it is installed in your project. Multiple versions will create multiple instances of the service, multiplying the total requests made by the app using this service.

The service could be said to have 2 lifecycle periods:

- Setup and initial config fetch
- Subsequent config update every hour via polling to the config API

In its first period, the service can be setup by instantiating the `AppConfigService` with the app / plugin ID, and will wait for 5 seconds for any other instantiations for different config IDs, which could be setup in other plugins within your app. After this 5 seconds, this multiple setups will be merged and the initial request to fetch for all the configurations will be dispatched.

Afterwards, the service will enter its second period where it will update the configurations every hour. Have in mind that you could still setup new configurations, but those won't be fetched until the next update within the stipulated hour.

⚠️ Beware that if you instantiate the service many times with the same ID, the `extraParams` passed as arguments will be merged, and all will be sent when fetching the configuration for your app / plugin.

## Usage

### Installation

```sh
npm install --save @auth/config-service
```

### Examples

Using `AppConfigService` class.

```js
const { AppConfigService } = require('@auth/config-service');

const defaultConfig = {
  timeouts: { rotok: 100 },
  forward_headers: {
    'user-agent': 'x-client-user-agent',
    'x-forwarded-for': 'x-forwarded-for',
  },
  forward_cookies: ['nsa_rotok'],
};

// Setup service
const myPluginConfigService = AppConfigService({
  app: 'my-plugin-id', // ID which will be used by the API to fetch your config
  extraParams: { // Any other extra params needed by your specific configurations
    extraParam: 'foo-bar',
  }
  defaultConfig, // Very important to have a default, as it will be used if the request fails
});

// Get most recent config
myPluginConfigService.getLatestConfig();
```

Using `addConfigKey` and `getConfig` functions.

```js
const { addConfigKey, getConfig } = require('@auth/config-service');

const reauthConfig = {
  timeouts: { verification: 100 },
  forward_headers: {
    'user-agent': 'x-client-user-agent',
    'x-forwarded-for': 'x-forwarded-for',
  },
  forward_cookies: ['nsa_rotok'],
};
const defaultConfig: {
  'change-password': reauthConfig;
  'change-password--ajax': reauthConfig;
}

addConfigKey('reauth', { operation_ids: ['change-password'] });
// Can be called many times and configs will me merged into one
addConfigKey('reauth', { operation_ids: ['change-password--ajax'] });

// Get latest config from Config Module
getConfig('reauth', defaultConfig);
```

### Force to fetch or not from Config API

You can set the env variable `AUTH_CONFIG_UPDATE` to `true` to force fetching the latest config from the API, even in dev environment, while you can set it to `false` to avoid calling the API event in production environment.

By default, the request to the API will only be made in production.

### Use Config API test scope

To use Config API test scope, you can set `AUTH_CONFIG_UPDATE` env variable to `scope_test`. You can determine any other scope to be used just with the prefix `scope_` and appending the name of the scope.

## Utils

### `getPropFromObject`

Util to get a property from an object given a string expression.

This utility function is very similar to how frontend-config (nordic/config) works when searching for a configuration.

```js
const { getPropFromObject } = require('@auth/config-service');

const exampleObject = {
  obj1: { food: 'から揚げ' },
  arr1: [
    ['arr2_0', 'arr2_1'],
    [
      ['arr3_0'],
      [1234],
      { deepArr: [['deep_arr']] },
    ],
  ],
};

console.log(getPropFromObject(obj, 'obj1.food'));
// から揚げ
console.log(getPropFromObject(obj, 'arr1[1][2].deepArr[0][0]'));
// deep_arr
console.log(getPropFromObject(obj, 'arr1[0]'));
// ['arr2_0', 'arr2_1']
```

The returned property / object is a **clone** of the original, so modifying the resulting object will not modify the original one.

How can this be useful? If you use the configuration service with this util, your config could tell you to pass on certain properties of certain objects, like the incoming `request`, to your API request.

### `mapObjectProps`

This utility function will extract properties from a given object according to a map of expressions which will be parsed by the [`getPropFromObject`](#getpropfromobject) util.

```js
const { mapObjectProps } = require('@auth/config-service');

const map = {
  user_id: 'user.id',
  operator_id: 'user.operatorId',
  platform_id: 'platform.id',
  site_id: 'platform.siteId',
};

const mappedObject = mapObjectProps(req, map); // req is ExpressJS request object
console.log(mappedObject);
// { user_id: 227476272, operator_id: null, platform_id: 'ML', site_id: 'MLA' }
```

### `mapHeaders`

This utility function will extract the specified headers from the request object and return their value in a new object with a custom new key specified in the map passed as an argument.

```js
const { mapHeaders } = require('@auth/config-service');

const map = {
  host: 'x-custom-host',
  'user-agent': 'x-client-user-agent',
};

const mappedObject = mapHeaders(req, map); // req is ExpressJS request object
console.log(mappedObject);
// { 'x-client-user-agent': ''Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/92.0.4515.131 Safari/537.36', host: 'www.mercadolibre.com.ar' }
```

### `cookiesObjectToHeader`

This utility function will extract the specified cookies from an object (usually the `req.cookies` object) and return them filtered and transformed into a [Cookie header](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cookie) value.

```js
const { cookiesObjectToHeader } = require('@auth/config-service');

const cookies = {
  ssid: 'ghy-test',
  nsa_rotok: 'rotok-token',
  food: 'rame',
};

const cookieHeader = cookiesObjectToHeader(cookies, ['nsa_rotok', 'food']);
console.log(cookieHeader);
// 'nsa_rotok=rotok-token; food=ramen'
```

You can also specify cookies which are not allowed to be "copied", in case you desired cookies are set dynamically by another service.

```js
const cookies = {
  ssid: 'ghy-test',
  nsa_rotok: 'rotok-token',
  food: 'rame',
};
const desiredCookies = ['ssid', 'food']; // This array should come from another service / API / Dynamic config
const bannedCookies = ['ssid'];

const cookieHeader = cookiesObjectToHeader(cookies, desiredCookies, bannedCookies);
console.log(cookieHeader);
// 'food=ramen'
```

Example with a more real use

⚠️ We strongly suggest to always ban the following cookies from being forwarded to any other app:

- `ssid`: Web session cookie
- `nat`: Access Token cookie (New)
- `access_token` Access Token cookie (Legacy)

## Utils complete example

```js
import { mapObjectProps, mapHeaders, cookiesObjectToHeader } from '@auth/config-service/lib/utils';
import { RestClient, buildContext } from 'frontend-restclient';

const restClient = RestClient();

const BANNED_COOKIES = ['ssid', 'nat', 'access_token'];
const {
  forward_cookies, forward_headers, forward_req_as_body,
} = configService.getLatestConfig(); // Get these values from config service

const data = mapObjectProps(req, forward_req_as_body);
const forwardHeaders = mapHeaders(req, forward_headers);
const cookiesHeader = cookiesObjectToHeader(req.cookies, forward_cookies, BANNED_COOKIES);

return restClient.post(`/internal/reinforcement/session/${detachedId}`, {
  data,
  timeout: 100,
  context: buildContext(req),
  headers: {
    ...forwardHeaders, // Include mapped headers
    ...cookiesHeader && { cookie: cookiesHeader }, // If there are cookies to forward, include them with the 'cookie' header
    'user-agent': 'custom-user-agent/1.0.3',
  },
})
```

## Tests

This project has both unit and functional tests. Coverage will be calculated only with unit tests.

When making changes, please consider testing both types of tests.

To run all tests, execute the following command:

```sh
npm test
```

## Contributing

In order to contribute to this library, you must read [this guide](CONTRIBUTING.md) first.

## Changelog

We keep changes to our codebase [here](CHANGELOG.md).

## License

© 2021 Mercado Libre - User Account - [Reauthentication Security](mailto:reauth.security@mercadolibre.com)
