# Session Anomalies Middleware

## Table of Contents

- [Session Anomalies Middleware](#session-anomalies-middleware)
  - [Table of Contents](#table-of-contents)
  - [Description](#description)
    - [How it works](#how-it-works)
  - [Usage](#usage)
    - [Installation](#installation)
    - [Example](#example)
    - [Enable middleware in dev environment](#enable-middleware-in-dev-environment)
  - [Tests](#tests)
  - [Contributing](#contributing)
  - [Changelog](#changelog)
  - [License](#license)

## Description

> Nordic module in charge of communicating with [Session Reinforcement API](https://web.furycloud.io/auth-session-reinforcement-api/summary)

### How it works

This middleware will only execute if the user is authenticated with a Web Session (`req.auth.method === 'MELI_WEB'`) and the middleware is enabled through Nordic Config.

When the middleware executes, it will make a request to Session Reinforcement API to check if the current session presents any anomaly, by forwarding the `nsa_rotok` cookie, if present, which contains a JWT used to detect these anomalies.

If the API returns a new token, then a new `nsa_rotok` cookie is set with the updated token.

The API response must be awaited before responding to the user who made the initial request. This is achieved with the `req.pendingPromises` array where we can store promises that will be awaited before ending the response.

## Usage

### Installation

```sh
npm install --save @auth/session-anomalies
```

### Example

```ts
import { sessionAnomalies } from '@auth/session-anomalies';

router.use(sessionAnomalies);
```

### Enable middleware in dev environment

By default this middleware will only run in production.  
If you wish to execute this middleware in dev, you can set the env variable `AUTH_SESSION_ANOMALIES=true` when running your app.

## Tests

This project has both unit and functional tests. When making changes, please consider testing with both types of tests, and adding or modifying both accordingly.

To run all tests, execute the following command:

```sh
npm test
```

## Contributing

In order to contribute to this library, you must read [this guide](CONTRIBUTING.md) first.

## Changelog

We keep changes to our codebase [here](CHANGELOG.md).

## License

Â© 2022 Mercado Libre - User Account - [Reauthentication Security](mailto:reauth.security@mercadolibre.com)
