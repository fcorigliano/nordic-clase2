const routeDiscovery = require('frontend-page/routeDiscovery');

const { CLIENT_PATH } = require('../../../utils/nordic-pages/helpers/constants');

const { generateNavigablePagesClientsAndEntries } = require('./navigable-pages-clients-and-entries');
const { generateHttpErrorsClientsAndEntries } = require('./http-errors-clients-and-entries');
const { generatePolyfillsEntry } = require('./polyfills-entry');
const { createClientDirectory } = require('./utils/clients');

const generateClientsAndEntriesByRouteDiscoveryResult = (routeDiscoveryResult) => {
  const discoveredRoutes = routeDiscoveryResult?.discoveredRoutes || [];
  const discoveredHttpErrors = routeDiscoveryResult?.discoveredHttpErrors || {};

  createClientDirectory(CLIENT_PATH);

  const navigablePagesEntries = generateNavigablePagesClientsAndEntries(discoveredRoutes);
  const httpErrorsEntries = generateHttpErrorsClientsAndEntries(discoveredHttpErrors);

  const pagesEntries = { ...navigablePagesEntries, ...httpErrorsEntries };

  return pagesEntries;
};

const generateClientsAndEntries = () => {
  let entries = {};
  const routeDiscoveryResult = routeDiscovery.getDiscoveredRoutes();

  const pagesEntries = generateClientsAndEntriesByRouteDiscoveryResult(routeDiscoveryResult);
  const polyfillsEntry = generatePolyfillsEntry();

  entries = { ...pagesEntries, ...polyfillsEntry };

  return entries;
};

module.exports = { generateClientsAndEntries };

if (process.env.NODE_ENV === 'test') {
  exports = module.exports;
  exports.generateClientsAndEntriesByRouteDiscoveryResult = generateClientsAndEntriesByRouteDiscoveryResult;
}
