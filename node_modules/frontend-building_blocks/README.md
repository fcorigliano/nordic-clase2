# frontend-building_blocks

Functional building blocks for the webpack config. Compose it using feature middlewares like *Babel*, *PostCSS* â€¦

## Installation

```sh
npm install --save-dev frontend-building_blocks
```


## Usage

Create a webpack 5 config with Babel support, dev server and PostCSS autoprefixer:

```js
const { createConfig, defineConstants, env, entryPoint, setOutput, sourceMaps } = require('frontend-building_blocks')
const babel = require('frontend-building_blocks/babel')
const postcss = require('frontend-building_blocks/postcss')
const autoprefixer = require('autoprefixer')

module.exports = createConfig([
  entryPoint('./src/main.js'),
  setOutput('./build/bundle.js'),
  babel(/* options */),
  postcss([
    autoprefixer({ browsers: ['last 2 versions'] })
  ]),
  defineConstants({
    'process.env.NODE_ENV': process.env.NODE_ENV
  }),
  env('development', [
    sourceMaps()
  ])
])
```

Wanna use CSS modules? No problem!

```js
const cssModules = require('frontend-building_blocks/css-modules')

...

module.exports = createConfig([
  ...
  cssModules()
])
```

If you need to customize the configuration, use the `customConfig({})` block or read [how to create your own blocks](https://github.com/mercadolibre/fury_frontend-building-blocks/blob/master/docs/BLOCK-CREATION.md).



## Available webpack blocks

- [babel](https://github.com/mercadolibre/fury_frontend-building-blocks/blob/master/babel.js)
- [css-modules](https://github.com/mercadolibre/fury_frontend-building-blocks/blob/master/css-modules.js)
- [dev-server](https://github.com/mercadolibre/fury_frontend-building-blocks/blob/master/dev-server.js)
- [extract-text](https://github.com/mercadolibre/fury_frontend-building-blocks/blob/master/extract-text.js)
- [postcss](https://github.com/mercadolibre/fury_frontend-building-blocks/blob/master/postcss.js)
- [sass](https://github.com/mercadolibre/fury_frontend-building-blocks/blob/master/sass.js)
- [lazy](https://github.com/mercadolibre/fury_frontend-building-blocks/blob/master/lazy.js)
- [webpack](https://github.com/mercadolibre/fury_frontend-building-blocks/blob/master/common/webpack.js) *(Webpack 5 base config)*

Missing something? Write and publish your own webpack blocks!


## Design principles

- Extensibility first
- Uniformity for easy composition
- Keep everything configurable
- But provide sane defaults


## group() (*presets*)

You have got some projects with a similar, yet not identical webpack configuration? Seems like you are looking for something preset-ish!

Fortunately, this is also very simple:

```js
const { env, group } = require('frontend-building_blocks')
const babel = require('frontend-building_blocks/babel')

function myPreset (proxyConfig) {
  return group([
    babel(/* options */),
    env('development', [
      /* development webpack config */
    ])
  ])
}
```

The key feature is the `group()` method which takes a set of blocks and returns a new block that combines all their functionality.

Then use your preset like this:

```js
const { createConfig } = require('frontend-building_blocks')

module.exports = createConfig([
  myPreset({
    '/api': { target: 'http://localhost:3000' }
  }),
  ...   // add more blocks here
])
```


## Available building presets

The following are the available presets ready-to-use in your projects:

- `classic`: to build applications.
- `ui`: to build UI Components & Libraries.
- `widget`: to build UI widgets.
- `spa`: to build SPA applications.
- `preact`: to build applications (but using Preact instead of React).


### classicPreset(config)

#### Options:
- `config.buildPath` {string} - A path to use as "build" folder. Default: `./build`.
- `config.publicPath` {string} - Specify the base path for all the assets within your application to use in `production`.
- `config.babelrc` {object|string} - Babel configuration (like babelrc config) or a path to custom .babelrc file.
- `config.lodash` {object} - [LodashModuleReplacementPlugin](https://www.npmjs.com/package/lodash-webpack-plugin) configuration.
- `config.imagesPath` {array|string} - A path that indicate the location of images that should be copied with CopyWebpackPlugin. Configuration options available at [CopyWebpackPlugin](https://webpack.js.org/plugins/copy-webpack-plugin/).
- `config.tsLoader` {object} - Additional settings for Typescript in [TS Loader](https://www.npmjs.com/package/ts-loader#loader-options).
- `config.newrelic` {object} - Upload source maps to Newrelic. Configuration options available at [NewRelicSourceMapPlugin](https://github.com/mercadolibre/fury_newrelic-sourcemaps-webpack#setup)
- `config.target` {array|string} - Default: `browserslist:last 2 versions, > 1%, Chrome >= 22, Firefox >= 24, Android >= 2.1, Safari >= 7, iOS >= 7, IE 11, not dead` Webpack offers multiple deployment targets that you can set in your webpack configuration. To understand what a target is in detail, read through the [webpack targets concept](https://webpack.js.org/configuration/target/#root).
- `config.lazy` {object} - This block by default provide the [webpack loadable plugin](https://github.com/gregberge/loadable-components/tree/main/packages/webpack-plugin), besides that, if you want to get code splitting working on your application, you will need to add it on your babel config, set the splitting strategy and follow some simple steps described on the [frontend-lazy documentation](https://nordic.adminml.com/docs/api/Nordic%20Modules/frontend-lazy#setup). 

Current splitting strategy settings options are:

`{name: 'description'}` - default: `undefined`

| Name | Description | Type | Default |
| -------- | ----------- | ---- | ------- |
| `splitChunks`| Split chunks name predefined strategy, current allowed value `granular` | string | `undefined` (it will use your project optimization.splitChunks config) |

##### Params
> Params to run webpack with. Commonly you'd use this with `npm run dist --nameOfParam` or `npm run build --nameOfParam`:
- `--analyze`: Will run [WebpackBundleAnalyzer](https://www.npmjs.com/package/webpack-bundle-analyzer) in analyzerMode=static

#### Default configuration:
* Babel:
  - presets:
    - `@babel/preset-react`
    - `@babel/preset-env`: sin polyfills con transforms para:
    'last 2 versions', '> 1%', 'android >= 2.1', 'chrome >= 18', 'firefox >= 4', 'safari >= 9', 'ios >= 7'
  - plugins:
    - `@babel/plugin-proposal-object-rest-spread`
    - `@babel/plugin-transform-react-constant-elements`
    - `@babel/plugin-transform-react-inline-elements`,
    - `@loadable/babel-plugin`
* PostCSS:
  - Soporte para browsers: 'last 5 versions', 'android >= 2.1', '> 1%',
  - extractText: [name].css
  - cssnano: solo para env=production
* Sass: Misma config que postCSS
* Imagenes y svg:
  - imagemin-mozjpeg
  - imagemin-pngquant
  - imagemin-svgo
* Build plugins:
  - TerserWebpackPlugin
  - ImageMinimizerPlugin
  - LodashModuleReplacementPlugin
  - LoadablePlugin


#### Use case:
```js
const {
  createConfig,
  entryPoint,
} = require('frontend-building_blocks');
const classicPreset = require('frontend-building_blocks/presets/classic');

module.exports = createConfig([
  entryPoint({
    'demo': './app/client/demo.js',
  }),
  classicPreset({
    ...
  })
  ...   // add more blocks here
  
])
```

### uiPreset(config)
- `config.buildPath` {string} - A path to use as "build" folder. Default: `./build`.
- `config.babelrc` {object|string} - Babel configuration (like babelrc config) or a path to custom .babelrc file.

```js
const {
  createConfig,
  entryPoint,
} = require('frontend-building_blocks');
const uiPreset = require('frontend-building_blocks/presets/ui');

module.exports = createConfig([
  entryPoint({
    'demo': './app/client/demo.js',
  }),
  uiPreset({
    ...
  }),
  ...   // add more blocks here
])
```

##### Params
> Params to run webpack with. Commonly you'd use this with `npm run dist --nameOfParam` or `npm run build --nameOfParam`:
- `--analyze`: Will run [WebpackBundleAnalyzer](https://www.npmjs.com/package/webpack-bundle-analyzer) in analyzerMode=static

### widgetPreset(config)
- `config.name` {string} - The name of the widget.
- `config.version` {string} - The version of the widget.
- `config.buildPath` {string} - A path to use as "build" folder. Default: `./lib`.
- `config.babelrc` {object|string} - Babel configuration (like babelrc config) or a path to custom .babelrc file.

```js
const {
  createConfig,
  entryPoint,
} = require('frontend-building_blocks');
const widgetPreset = require('frontend-building_blocks/presets/widget');

module.exports = createConfig([
  entryPoint({
    'demo': './app/client/demo.js',
  }),
  widgetPreset({
    ...
  }),
  ...   // add more blocks here
])
```

### spaPreset(options)
- `config.buildPath` {string} - A path to use as "build" folder. Default: `./build`.
- `config.publicPath` {string} - Specify the base path for all the assets within your application to use in `production`.
- `config.babelrc` {object|string} - Babel configuration (like babelrc config) or a path to custom .babelrc file.

```js
const {
  createConfig,
  entryPoint,
} = require('frontend-building_blocks');
const spaPreset = require('frontend-building_blocks/presets/spa');

module.exports = createConfig([
  entryPoint({
    'demo': './app/client/demo.js',
  }),
  spaPreset({
    ...
  }),
  ...   // add more blocks here
])
```

### preactPreset(config)
- `config.buildPath` {string} - A path to use as "build" folder. Default: `./build`.
- `config.publicPath` {string} - Specify the base path for all the assets within your application to use in `production`.
- `config.babelrc` {object|string} - Babel configuration (like babelrc config) or a path to custom .babelrc file.

```js
const {
  createConfig,
  entryPoint,
} = require('frontend-building_blocks');
const preactPreset = require('frontend-building_blocks/presets/preact');

module.exports = createConfig([
  entryPoint({
    'demo': './app/client/demo.js',
  }),
  preactPreset({
    ...
  }),
  ...   // add more blocks here
])
```

:warning: Currently preact-compat [is not compatible with transform-react-inline-elements](https://github.com/developit/preact-compat/issues/328), if you try to use this preset with any library with **transform-react-inline-elements** plugin applied you will get an `<undefined></undefined>` tag, have in mind we have this plugin in most of our projects, as a workaround you could transpile the library yourself following the next steps:

- set webpack alias for the library
- set babel `babelrc` option to false
- remove **transform-react-inline-elements** from babel `plugins` option
- add the library to babel `exclude` option

#### Example using Carousel component from ui-library_ml
```js
const {
  ...
  resolveAliases } = require('nordic-dev/building_blocks');
  ...
  const config = createConfig([
    resolveAliases({
      ...
      'create-react-class': 'preact-compat/lib/create-react-class',// preactPreset does not provide alias for create-react-class, so if you are using some old library you may need to add this line
      'ui-library_ml/ui/carousel': path.resolve(__dirname, 'node_modules/ui-library_ml/src/components/carousel'),
      ...
    }),
    preactPreset({
      ...,
      babelrc: {
        babelrc: false, // avoid using nested babelrc file
        plugins: [ // remove transform-react-inline-elements plugin from our plugin list
          "transform-class-properties",
          "transform-react-constant-elements",
          "transform-object-rest-spread"
        ],
        exclude: /\/node_modules\/(?!ui-library)\//, // exclude node_modules but the target library
      }
  }),
```

Missing something? Write and publish your own presets!

## Fast refresh

Fast Refresh is a development feature provided since **frontend-building_blocks@3.12.0** that allows you to get near-instant feedback for changes in React components. Fast Refresh is enabled by default in all Nordic and Odin applications on **nordic && nordic-dev v6.12.0 or newer**. With Fast Refresh enabled, most edits should be visible without losing component state.

**How to use this feature on my project**

**1.** Set up your config in order to use this feature only for the development environment.

`config/default-development.js`
```js
module.exports = {
  ...,
  hotReload: {
    enabled: true,
  },
};
```

**2.** Running the project.

<details>
<summary>Project using Ragnar (nordic/ragnar)</summary>

Modify the dev script in order to use `node` instead of `nodemon`.

`package.json`
```js
  {
    "scripts": {
      "dev": "NODE_ENV=development NODE_HTTPS=true node ./index.js"
    }
  }
```

Running `npm run dev` you will be able to build your project (in memory) and start the application. You no longer have to run npm run watch or npm run build commands.

**Important:** if you execute npm run dev along with npm run watch or npm run build, the application build will fail.

Debug process
**The debug process will remain the same**. If you need to debug your application, you will have to run npm run watch/build and npm run debug as before.
</details>

<details>
<summary>Project without Ragnar</summary>

Start your application normally. Keep in mind that **you donâ€™t have to run npm run watch** command because webpack will be watching for changes using the [Hot Module Replacement](https://webpack.js.org/concepts/hot-module-replacement/) (HMR) alongside with React fast refresh.
</details>

For more information about configuration options and limitations / considerations, please, [follow this link](https://nordic.adminml.com/docs/fast-refresh).

:warning: If you are using `dev-server` ([webpack-dev-server](https://webpack.js.org/configuration/dev-server/)) on your project, you need to choose between this feature and dev-server because this feature uses [webpack-hot-middleware](https://github.com/webpack-contrib/webpack-hot-middleware) that is an alternative to dev-server.


## You might want to know

<details>
<summary>Can I get rid of the default loaders?</summary>

The `createConfig()` function sets some generic default loaders. This should not be a problem. If does happen to be a problem you can also create a "vanilla" configuration (without the defaults) by using `createConfig.vanilla()` instead.
</details>

<details>
<summary>How does env() work?</summary>

You might wonder how `env('development', [ ... ])` works? It just checks the NODE_ENV environment variable and only applies its contained webpack blocks if it matches.

So make sure you set the NODE_ENV accordingly:

```js
// your package.json
"scripts": {
  "build": "NODE_ENV=production webpack -p --config webpack.config.js",
  "start": "NODE_ENV=development webpack-dev-server --config webpack.config.js"
}
```

If there is no NODE_ENV set then it will just treat NODE_ENV as if it was `development`.
</details>

<details>
<summary>What does defineConstants() do?</summary>

`defineConstants()` is just a small convenience wrapper around webpack's [DefinePlugin](https://webpack.github.io/docs/list-of-plugins.html#defineplugin). It is composable and automatically encodes the values. Use it to replace constants in your code by their values at build time.

So having a `defineConstants({ 'process.env.FOO': 'foo' })` and a `defineConstants({ 'process.env.BAR': 'bar' })` in your config means the resulting webpack config will finally contain a single `new webpack.DefinePlugin({ 'process.env.FOO': '"FOO"', 'process.env.BAR': '"BAR"' })`, thus replacing any occurence of `process.env.FOO` and `process.env.BAR` with the given values.
</details>

<details>
<summary>What does a block look like from the inside?</summary>

A webpack block is *just a function and requires no dependencies at all* (ðŸŽ‰ðŸŽ‰), thus making it easy to write your own blocks and share them with the community.

Take the `babel` webpack block for instance:

```js
/**
 * @param {object} [options]
 * @param {RegExp|Function|string}  [options.exclude]   Directories to exclude.
 * @return {Function}
 */
function babel (options) {
  const { exclude = /\/node_modules\// } = options || {}

  return (context) => ({
    module: {
      loaders: [
        {
          // we use a `MIME type => RegExp` abstraction here in order to have consistent regexs
          test: context.fileType('application/javascript'),
          exclude: Array.isArray(exclude) ? exclude : [ exclude ],
          loaders: { loader: 'babel-loader', cacheDirectory: true },
        }
      ]
    }
  })
}
```

Add a README and a package.json and you are ready to ship.

For more details see [How to write a block](./docs/BLOCK-CREATION.md).
</details>

<details>
<summary>I need some custom webpack config snippet!</summary>

No problem. If you don't want to write your own webpack block you can just use `customConfig()`:

```js
const path = require('path')
const HtmlWebpackPlugin = require('html-webpack-plugin')
const { addPlugins, customConfig } = require('frontend-building_blocks')

...

module.exports = createConfig([
  ...
  addPlugins([
    // Add a custom webpack plugin
    new HtmlWebpackPlugin({
      inject: true,
      template: './index.html'
    })
  ]),
  customConfig({
    // Add some custom webpack config snippet
    resolve: {
      extensions: [ '.js', '.es6' ]
    }
  })
])
```

The object you pass to `customConfig()` will be merged into the webpack config using
[webpack-merge](https://github.com/survivejs/webpack-merge) like any other webpack
block's partial config.
</details>
