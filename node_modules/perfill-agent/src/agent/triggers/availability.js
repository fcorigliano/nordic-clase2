const { AVAILABILITY } = require('../../constants/initiatives');
const { AVAILABILITY_FAILURE, AVAILABILITY_TRANSFER_SIZE } = require('../../constants/metrics');
const { appendMetric, sendMetrics, getMetricsCollected } = require('../collector');
const { subscribe } = require('../subscriptions');

const getRequestIdleCallback = window.requestIdleCallback || (callback => setTimeout(callback, 200));

const eventName = 'availabilityEvent';
let subscribedToPageUnload = false;
const subscribeToPageUnload = (settings) => {
  const availabilityEventHandler = () => {
    if (window.document.visibilityState === 'hidden') {
      sendMetrics({ id: AVAILABILITY }, settings, getMetricsCollected());

      window.document.removeEventListener(eventName, availabilityEventHandler);
      subscribedToPageUnload = false;
    }
  };

  if (!subscribedToPageUnload) {
    // TODO - listen to pagehide on safari? https://developer.mozilla.org/en-US/docs/Web/API/Document/visibilitychange_event
    window.document.addEventListener(eventName, availabilityEventHandler);
    subscribedToPageUnload = true;
  }

  const visibilityChangeHandler = () => {
    const event = new window.Event(eventName);
    window.document.dispatchEvent(event);
  };
  window.document.addEventListener('visibilitychange', visibilityChangeHandler);
};

const setAvailabilityHandler = (settings) => {
  subscribeToPageUnload(settings);
};

const monitor = (settings) => {
  subscribe(AVAILABILITY_FAILURE, (commandData) => {
    if (commandData) {
      appendMetric(AVAILABILITY_FAILURE, commandData);
    }
  });

  subscribe(AVAILABILITY_TRANSFER_SIZE, (commandData) => {
    if (commandData) {
      appendMetric(AVAILABILITY_TRANSFER_SIZE, commandData);
    }
  });

  getRequestIdleCallback(() => setAvailabilityHandler(settings));
};

module.exports = monitor;
