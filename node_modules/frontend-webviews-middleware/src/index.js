/* eslint-disable consistent-return */
const csrPrerender = require('./csr-prerender');
const deeplink = require('./deeplink');

const configDefault = require('../config/defaults');

const activeMiddlewares = {
  deeplink,
  csrPrerender,
};

function addMiddlewaresOn(config) {
  const middlewaresOn = [];
  Object
    .keys(config.middlewares)
    .forEach((key) => {
      if (key && config[key]) {
        middlewaresOn.push(activeMiddlewares[key](config[key]));
      }
    });

  return middlewaresOn;
}


function webview(config) {
  const configWebview = { ...configDefault, ...config };

  const middlewares = addMiddlewaresOn(configWebview);

  return function webviewsMiddleware(req, res, next) {
    if (req.device.nativeWebview && middlewares.length > 0) {
      middlewares.forEach(middleware => (
        middleware(req, res, next)
      ));
    } else {
      next();
    }
  };
}

module.exports = webview;
exports = module.exports;
exports.webviewsMiddleware = webview;
