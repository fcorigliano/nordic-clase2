# i18n Node Plugin

> Internationalize your Express app & React components.

This repository contains a group of modules that provides Express middleware, React components and an I18n module.

- [i18nMiddleware](#i18nmiddleware)
- [injectI18n](#injecti18n)
- [useI18n](#useI18n)
- [I18nProvider](#i18nprovider-)
- [I18n](#i18noptions)
- [I18nBase](#i18nbase) - Node.js specific package without jsx.

Also, there is a command-line interface to manage translations keys and values.
- [CLI](#cli)


Please refer to [Babel wiki](https://github.com/mercadolibre/fury_m10e-service/wiki) for core information about i18n (faq, troubleshooting, support contact, etc)

## Installation

```
npm install frontend-i18n
```

## Usage

### Configuration

Add the `i18n` key into the file `/config/default.js` in your project, and specify these inputs:

- `app`: Name of the repository on GitHub. Example: `fury_fbm-panel-frontend`
- `project`: Tag name to recognize the project inside Crowdin. **Avoid to use rare characters**. Example: `fbmfulfillment`
- `translationProject`: Name of translation project in Crowdin. Actual apps that already using the Babel service have a `translationProject:` [`'meli'`](https://crowdin.com/project/meli) by default, so they don't need to specify this property. For new apps ask a CM team for the name. Example: `fbm`
- `srcPath`: Folder route where the keys will be extracted. **Include the `__dirname` of your app**. Example: `${__dirname}/../app`
- `extNames`: File extensions that will be used to scan the terms. **Comma separation (js is default)**. Example: ['js', 'jsx']

#### Example for `/config/default.js`

```js
i18n: {
  app: 'fury_fbm-panel-frontend',
  project: 'fbmfulfillment',
  translationProject: 'fbm',
  srcPath: `${__dirname}/../app`,
  extNames: ['js'],
}
```

See another [example](https://github.com/mercadolibre/frontend-nordic_generator/blob/master/templates/nordic-app/config/default.js) inside the nordic generator.


### i18nMiddleware

An i18n middleware that create an I18n module instance per request.

This middleware defines:

- `req.translations`: A translations object (already located) to use over the request life. It will use `req.locale` or `req.platform.countryId` to set the translations.
- `req.i18n`: An instance of I18n module with `req.translations` loaded and ready to use.

#### Example for `app/server/index.js` using `req.platform.countryId` (default)

```js
const router = require('ragnar').router();

// import i18nMiddleware
const { i18nMiddleware } = require('frontend-i18n');

// Or the legacy way
const i18nMiddleware = require('frontend-i18n/middleware');

const config = require('frontend-config');

/**
 * Set up i18n middleware
 */
router.use(i18nMiddleware(config.i18n));

router.get('/something', (req, res) => {
  // Use translations...
  console.log(req.translations);
  console.log(req.i18n.gettext('Hello!'));
  // Pass translations to PageView as props...
  res.render(PageView, {
    translations: req.translations,
  });
});
```

#### Example for `app/server/index.js` using `req.locale`

```js
const router = require('ragnar').router();

// import i18nMiddleware
const { i18nMiddleware } = require('frontend-i18n');

// Or the legacy way
const i18nMiddleware = require('frontend-i18n/middleware');

const config = require('frontend-config');

/**
 * Set up req.locale before i18nMiddleware
 */
router.use((req, res, next) => {
  req.locale = 'pt-BR';
  next();
});

/**
 * Set up i18n middleware
 */
router.use(i18nMiddleware(config.i18n));

router.get('/something', (req, res) => {
  // Use translations...
  console.log(req.translations);
  console.log(req.i18n.gettext('Hello!'));
  // Pass translations to PageView as props...
  res.render(PageView, {
    translations: req.translations,
  });
});
```

### Client & Server side using React

To use i18n into a React page view or component you should use `I18nProvider` in conjunction with `injectI18n` or `useI18n`.

### injectI18n

This function is a High-Order Component (HOC) factory. It will wrap the passed-in React component with another React component which provides an i18n instance into the wrapped component via its props. (This is similar to the connect-to-stores pattern found in many Flux implementations).

#### Example for any component

```js
const React = require('react');

// import injectI18n
const { injectI18n } = require('frontend-i18n');

// Or the legacy way
const injectI18n = require('frontend-i18n/lib/injectI18n');

const Something = ({ i18n, foo }) => (
  <div>
    <p>{i18n.gettext('Some text')}</p>
    <p>{foo}</p>
  </div>
);

/**
 * Expose Something with i18n injection
 */
module.exports = injectI18n(Something);
```

### useI18n

This hook provides access to the i18n context and is an alternative to `injectI18n`. 

#### Example for any component

```js
const React = require('react');

// import useI18n
const { useI18n } = require('frontend-i18n');

const Something = () => (
  // use it
  const { i18n } = useI18n();
  
  <div>
    <p>{i18n.gettext('Some text')}</p>
    <p>{foo}</p>
  </div>
);

module.exports = Something;
```

### `<I18nProvider />`

This component is used to create an i18n context for a tree of components. Usually, this component will wrap a page's component so that the entire page will be within the configured i18n context.

`<I18nProvider />` accepts these props:

- `i18n`: An instance of I18n module with translations.

#### Example in a controller

```js
const React = require('react');

// import I18nProvider
const { I18nProvider } = require('frontend-i18n');

// Or the legacy way
const I18nProvider = require('frontend-i18n/lib/I18nProvider');

const PageView = require('./PageView');

function renderMiddleware(req, res) {
  const View = props => (
    <I18nProvider i18n={req.i18n}>
      <PageView {...props} />
    </I18nProvider>
  );
  res.render(View, {
    translations: req.translations, // req.translations from i18nMiddleware
  });
};
```

## Full example

1 - In the controller PageView (server-side):

```js
const React = require('react');

// import I18nProvider
const { I18nProvider } = require('frontend-i18n');

// Or the legacy way
const I18nProvider = require('frontend-i18n/lib/I18nProvider');

const PageView = require('./PageView');

function renderMiddleware(req, res) {
  const View = props => (
    <I18nProvider i18n={req.i18n}>
      <PageView {...props} />
    </I18nProvider>
  );
  res.render(View, {
    translations: req.translations, // req.translations from i18nMiddleware
  });
};
```

2 - On any React page view:

 a. With `useI18n`:

```js
const React = require('react');

// import useI18n
const { useI18n } = require('frontend-i18n');

const Something = () => (
  // use
  const { i18n } = useI18n();
  
  <div>
    <p>{i18n.gettext('Some text')}</p>
    <p>{foo}</p>
  </div>
);

module.exports = Something;
```

 b. With `injectI18n`:

```js
const React = require('react');

// import injectI18n
const { injectI18n } = require('frontend-i18n');

// Or the legacy way
const injectI18n = require('frontend-i18n/lib/injectI18n');

class PageView extends React.Component {
  render() {
    const { preloadedState, i18n } = this.props;
    return (
      <div>
        <h1>{i18n.gettext('Hello!')}</h1>
        <Something foo={'bar'}/>
      </div>
    );
  }
}

/**
 * Expose PageView with I18nProvider
 */
module.exports = injectI18n(PageView);
```

Then on any React component, should be able to use `i18n` from its props:

```js
const React = require('react');

// import injectI18n
const { injectI18n } = require('frontend-i18n');

// Or the legacy way
const injectI18n = require('frontend-i18n/lib/injectI18n');

const Something = ({ i18n }) => (
  <p>{i18n.gettext('Some text')}</p>
);

/**
 * Expose Something with i18n injection
 */
module.exports = injectI18n(Something);
```

3 - In your client-side entry point:

```js
const React = require('react');
const ReactDOM = require('react-dom');
const PageView = require('./PageView');

// import I18n and I18nProvider
const { I18n, I18nProvider } = require('frontend-i18n');

// Or the legacy way
const I18n = require('frontend-i18n');
const I18nProvider = require('frontend-i18n/lib/I18nProvider');

const preloadedState = window.__PRELOADED_STATE__;

const i18n = new I18n({
  translations: preloadedState.translations,
});

/**
 * Mount DemoView on client
 */
ReactDOM.render(
  <I18nProvider i18n={i18n}>
    <DemoView preloadedState={preloadedState} />
  </I18nProvider>,
  document.getElementById('root-app'),
);
```

### I18n(options)

Create a new instance of I18n with the given options.

Options:
- `translations`: A translations object to use for a specific locale.

Example:
```js
// import I18n
const { I18n } = require('frontend-i18n');

// Or the legacy way
const I18n = require('frontend-i18n');

const translations = require('./src/translations-AR');
const i18n = new I18n({
  translations,
});
```

#### `i18n.gettext()`

Given a text, return the translation with its arguments replaced.

Params:
- `text`: A `String` with the given key as text.
- `replacement0`, `replacement1`, ...`replacementN`: List of replacements for `{n}` variables.

Example:
```js
i18n.gettext('This is {0}, right {0}?', 'John');
// => This is John, right John?
```

#### `i18n.ngettext()`

Given a text in singular, a text in plural and a quantity, return the translation with its arguments replaced.

Params:
- `singularText`: A `String` with the given key as text for singular state.
- `pluralText`: A `String` with the given key as text for plural state.
- `quantity`: A `Number` to determine which state to use (singular/plural)
- `replacement0`, `replacement1`, ...`replacementN`: List of replacements for `{n}` variables.

Example:
```js
i18n.ngettext('{0}, You have {1} message', '{0}, You have {1} messages', 6, ['John', 6])
// => John, You have 6 messages
```

#### `i18n.pgettext()`

Given a context and a text, return the translation with its arguments replaced.

Params:
- `ctx`: A `String` with the given key as context.
- `text`: A `String` with the given key as text.
- `replacement0`, `replacement1`, ...`replacementN`: List of replacements for `{n}` variables.

Example:
```js
i18n.pgettext('info', 'This is {0}, right {0}?', 'John');
// => This is John, right John?
```

#### `i18n.npgettext()`

Given a context, a text in singular, a text in plural and a quantity, return the translation with its arguments replaced.

Params:
- `ctx`: A `String` with the given key as context.
- `singularText`: A `String` with the given key as text for singular state.
- `pluralText`: A `String` with the given key as text for plural state.
- `quantity`: A `Number` to determine which state to use (singular/plural)
- `replacement0`, `replacement1`, ...`replacementN`: List of replacements for `{n}` variables.

Example:
```js
i18n.npgettext('info', '{0}, You have {1} message', '{0}, You have {1} messages', 6, ['John', 6])
// => John, You have 6 messages
```


### `i18n.jsx Component`
For the exclusive case that the key contains html markup, and it needs to be drawn in the view as a component, the i18n.jsx object will expose some functions that will return a React component to be render directly in the view, based on a string template and a settings object.
The string template should contain elements into curly brackets to identify the tags to be interpolated, and the settings object should contain different properties depending on the function being invoked.

There are different settings formats for each different function as shown below:

#### `i18n.jsx.gettext`

Given a text and a settings object, return a React component with the arguments replaced by the html tags, defined in the "tags" property of the settings object.

Example:

```js
function MyComponent() {
  const settings = {
    tags: {
      0: '<strong>',
      1: '</strong>'
    }
  };
  return (
    <>
      ...
      { i18n.jsx.gettext('Welcome to {0}Mercado Libre{1}', settings) }
      ...
    </>
  )
}
// => Welcome to Mercado Libre ('Mercado Libre' highlighted as strong)
```

In order not to lose the default functionality of gettext(), it will also support replacing string arguments as well as the html tags. The string arguments need to be specified in the "replacements" propery of the settings object. In this cases is important to be aware of the number mapping for each argument. This "replacements" property is optional for all the methods exposed by the i18.jsx object.

```js
function MyComponent() {
  const settings = {
    tags: {
      1: '<strong>',
      2: '</strong>'
    }, 
    replacements: {
      0: 'John'
    }
  };
  return (
    <>
      ...
      { i18n.jsx.gettext('{0}, Welcome to {1}Mercado Libre{2}', settings) }
      ...
    </>
  )
}
// => John, Welcome to Mercado Libre (Last two words highlighted as strong)
```

#### `i18n.jsx.ngettext`

Given a text in singular, a text in plural and a quantity, return a React component with the arguments replaced by the html tags, defined in the "tags" property of the settings object.
The "replacements" property is optional, only for the cases there are string arguments to replace.

Example:

```js
function MyComponent() {
  const settings = {
      wrapper: 'div',
      tags: {
        2: '<strong>',
        3: '</strong>',
      },
      replacements: {
        0: 'John',
        1: '6',
      },
      quantity: 6,
    };
  return (
    <>
      ...
      { i18n.jsx.ngettext('{0}, You have {1} {2}message{3}', '{0}, You have {1} {2}messages{3}', settings) }
      ...
    </>
  )
}
//
// => John, You have 6 messages (the word 'messages' highlighted as strong)
```

#### `i18n.jsx.pgettext`

Given a context and a text, return a React component with the arguments replaced by the html tags, defined in the "tags" property of the settings object.
The "replacements" property is optional, only for the cases there are string arguments to replace.

```js
function MyComponent() {
  const settings = {
      wrapper: 'div',
      tags: {
        2: '<strong>',
        3: '</strong>',
      },
      replacements: {
        0: 'John',
      },
    };
  return (
    <>
      ...
      { i18n.jsx.ngettext('question', '{2}This{3} is {0}, right {0}?', settings) }
      ...
    </>
  )
}
// => This is John, right John? (the word 'this' highlighted as strong)
```

#### `i18n.jsx.npgettext`

Given a context, a text in singular, a text in plural and a quantity, return a React component with the arguments replaced by the html tags, defined in the "tags" property of the settings object.
The "replacements" property is optional, only for the cases there are string arguments to replace.

```js
function MyComponent() {
  const settings = {
      wrapper: 'div',
      tags: {
        2: '<strong>',
        3: '</strong>',
      },
      replacements: {
        0: 'John',
        1: '6',
      },
      quantity: 6,
    };
  return (
    <>
      ...
      { i18n.jsx.npgettext('information', '{0}, {2}You{3} have {1} message', '{0}, {2}You{3} have {1} messages', settings) }
      ...
    </>
  )
}
// => John, You have 6 messages (the word 'You' highlighted as strong)
```

#### `i18n.jsx wrapper settings property`
As all the functions exposed by this object are returning a React component, it needs to be wrapped on a single element. By default, the wrapper element will be a DIV , but it can be specified explicitly if needed, by adding a "wrapper" string property in the settings object. Optionally, you can pass a "className" to be assigned to the wrapper.

Example:

```js
function MyComponent() {
  const settings = {
    tags: {
      0: '<strong>',
      1: '</strong>',
    },
    wrapper: 'p',
    className: 'my-wrapper',
  };
  return (
    <>
      ...
      { i18n.jsx.gettext('Welcome to {0}Mercado Libre{1}', settings) }
      ...
    </>
  )
}
// => Welcome to Mercado Libre (In this case, all the sentence will be wrapped with <P>)
```

## CLI

The command-line interface allows to manage keys and values for the translations of an entire application.

Its responsabilities includes:
- Parse keys from templates, views, etc.
- Upload and download keys from [m10e](#m10e) (Crowdin).
- Transform results to JSON, to handle with [I18n](#i18noptions).

### m10e

It's an interface for the traditional Crowdin implementation. It unifies the translation keys and values across the entire company to optimize the messages usage.

When using m10e there is no need for create a new project on Crowdin.

### Usage

There are three main commands to run from terminal:

#### gettext

Scans code from the application resources and generates the `.po` template with messages keys.

Example:
```
// Using default CLI:
$ i18n gettext

// Using npm scripts:
$ npm run i18n:gettext
```

#### download

Downloads translations from [m10e](#m10e) (Crowdin).

Example:
```
// Using default CLI:
$ i18n download

// Using npm scripts:
$ npm run i18n:download
```

##### download specific directory

If you need to downloads translations to specific project directory you can specify a `path`.

Example:
```
// Using default CLI:
$ i18n download --path api/translations
```

##### download output reports:
The download command will automatically return a report that displays the percentage of keys that are being translated (in progress) and the currently untranslated keys.  Example:
```
=================================
Translations in progress report
=================================
 [es-AR] 75% (34/45)
 [pt-BR] 77% (35/45)
=================================
Untranslated report for es-AR
=================================
  Descubre nuestra página principal
  Descubrí nuestra página principal
```

#### upload

Upload translations to [m10e](#m10e) (Crowdin).

If `-f` or `--force` is defined, it also removes source messages that aren't present in the current upload.

Example: Keeps all the messages.
```
// Using default CLI:
$ i18n upload

// Using npm scripts:
$ npm run i18n:upload
```

Example: Removes not present messages.
```
// Using default CLI:
$ i18n upload --force

// Using npm scripts (remember to use `--` before the `--force` argument!):
$ npm run i18n:upload -- --force
```

##### upload output reports:
The upload command will automatically return a report that displays the keys that were succesfully uploaded. Example:
```
=================================
New uploaded messages
=================================
Test message
```

## Server side using node
### I18nBase

This is the same package as [I18n](#i18noptions) without JSX support. You can import and use it as:

```
const { I18nBase } = require('frontend-i18n/lib/I18nBase');

const i18n = new I18nBase(options);
```

or if you already use I18n on your application, you can use an alias to avoid changing the class call:

```
const { I18nBase: I18n } = require('frontend-i18n/lib/I18nBase');

const i18n = new I18n(options);
```

If you have your application on Typescript, you can use the type as follows:

```
import { I18nBase } from 'frontend-i18n/lib/I18nBase';

const someMethod = (i18n: I18nBase) => ({
  label: i18n.gettext('SOME TEXT')
})
```

or with an alias

```
import { I18nBase as I18n } from 'frontend-i18n/lib/I18nBase';

const someMethod = (i18n: I18n) => ({
  label: i18n.gettext('SOME TEXT')
})
```

## License

Copyright © 2017.
