# Vault Client

## Table of Contents

- [Vault Client](#vault-client)
  - [Table of Contents](#table-of-contents)
  - [Description](#description)
  - [Vault v2 Info](#vault-v2-info)
  - [Installation](#installation)
  - [Import for usage](#import-for-usage)
  - [Initialization and config](#initialization-and-config)
    - [Config options](#config-options)
  - [Methods](#methods)
    - [`getPIIUserData`](#getpiiuserdata)
    - [`getPIIUsersData`](#getpiiusersdata)
  - [Examples](#examples)
  - [Contact](#contact)
  - [License](#license)

## Description

The purpose of this client is to easily get PII information from the Vault API which contains all sensitive information from our users.

To use this client, follow these steps:

1. You need an integration token to request PII information. You can get yours through [Shield](https://shield.adminml.com) under the name "Data Vault PII - Pedido de Integración".
2. Install this client in your project (not necessary in Nordic projects).
3. Use `getPIIUserData` to get PII info from a specific user

## Vault v2 Info

To use this client you will need to know the vault's schema to query its properties. Please refer to the [schema documentation](https://sites.google.com/mercadolibre.com/kyc/data-vault/diccionario-de-campos).

For more information concerning the Vault API, please refer to [its documentation](https://sites.google.com/mercadolibre.com/kyc/data-vault).

## Installation

```bash
npm i node-vault-client
```

**IMPORTANT** Installation is only required for non Nordic projects. This client already comes bundled with Nordic.

## Import for usage

```js
// CommonJS
const { VaultClient } = require('node-vault-client');

// Typescript / ESModules
import { VaultClient } from 'node-vault-client';
```

## Initialization and config

To initialize the client, a token is required which is used to identify your request against the PII Vault API.
Along with the token, you can pass some configuration options to set timeouts and retries.

```js
const { VaultClient } = require('node-vault-client');

const client = new VaultClient('some-token', {
  timeout: 80,
  retry: {
    strategy: 'linear',
    maxRetries: 2,
    delay: 10,
  },
});
```

### Config options

| Parameter          | Type                 | Required                     | Default      | Description |
|--------------------|----------------------|:----------------------------:|--------------|-------------|
| `timeout`          | `number`             |                              | `80`         | Rest client timeout |
| `isDirty`          | `boolean`             |                              | `false`         | Flag which adds the header `x-dirty-data` to all requests to vault client |
| `retry`            | `object` or `false`  |                              | Linear retry | Retry config object |
| `retry.strategy`   | `string`             | If `retry` config passed     | `linear`     | Retry strategy to use. Possible values are `linear` or `exponential` |
| `retry.maxRetries` | `number`             | If `retry` config passed     | `1`          | Maximum amount of retries before rejecting promise |
| `retry.delay`      | `number`             | If `retry` config passed     | `20`         | Delay in ms between each retry, or initial delay for exponential backoff |
| `retry.maxDelay`   | `number`             | If using `exponential` retry | -            | Maximum delay allowed when using exponential backoff. |
| `retry.factor`     | `number`             | If using `exponential` retry | -            | Exponential factor to use in exponential backoff. |

Default is **linear** strategy with **80ms timeout, 1 retry** after **20ms delay**.

To know more about these 2 strategies, you can refer to our [Rest Client's documentation about it](https://github.com/mercadolibre/frontend-restclient#retry-strategies-only-for-node).

:warning: You must be sure of what you are doing when adding the `isDirty` flag. This adds the header `x-dirty-data: true` to all requests to vault client. Basically, the header tells the vault that it does not matter that there is inconsistent user data, return the information anyway. For more information, please contact the KYC team by KYC support bot from Workchat to analyze the use case

## Methods

`getPIIUserData` and `getPIIUsersData` receive an object with parameters, among which one is an object with the user properties to be queried. This object is parsed with the library `json-to-graphql-query` so refer to their [documentation](https://github.com/dupski/json-to-graphql-query#json-to-graphql-query) for complex use-cases.

You can also use simple strings to specify the properties you need, as inner properties within a GraphQL query. Please refer to the [examples](#examples) for more information.

### `getPIIUserData`

|    Parameter     |         Type         |            Required           | Description |
| ---------------- | -------------------- |:-----------------------------:|-------------|
| `userProperties` | `string` or `object` | ✅                            | Properties to be retrieved from the user |
| `req`            | `object`             | ✅ (unless passing `userId`)  | Current request. User ID is taken from `req.user.id`. You should always pass the request in Nordic / ExpressJS environments. Use `userId` param to override `req.user.id` value |
| `userId`         | `number`             |    (Only if `req` not passed) | User ID to get properties from |
| `versionId`      | `string`             |                               | Version ID of the data to be retrieved, if you want to get historical data from the user |

Note that either `req` (with `req.user.id` defined) or `userId` properties must be supplied. Else an error is thrown.

### `getPIIUsersData`

|    Parameter     |         Type         | Required | Description |
| ---------------- | -------------------- |:--------:|-------------|
| `userIds`        | `number[]`           | ✅       | Array with user IDs to get properties from |
| `userProperties` | `string` or `object` | ✅       | Properties to be retrieved from the user |
| `req`            | `object`             | ✅       | Current request. You should always pass the request in Nordic / ExpressJS environments to trace request ID. |

## Examples

<details>
<summary>Typescript example</summary>

```ts
// Standalone
import { VaultClient } from 'node-vault-client';

interface UserData {
  names: {
    preferred: string;
  };
  contact: {
    email: {
      address: string;
      verified: boolean;
    }
  };
}

const client = new VaultClient('my-integration-token');

// Await example with query object
const userData = await client.getPIIUserData<UserData>({
  req, // Express request
  userProperties: {
    names: {
      preferred: true,
    },
    contact: {
      email: {
        address: true,
        verified: true
      },
    },
  }
});

// Promise example with string of desired properties
client.getPIIUserData<UserData>({
  req, // Express request
  userProperties: 'names { preferred } contact { email { address verified } }',
})
  .then((userData) => {
    // Do something
  });

// Promise example with string of desired properties
client.getPIIUsersData<UserData>({
  userIds: [123456, 987654, 456789],
  userProperties: 'names { preferred } contact { email { address verified } }',
  req, // Express request
})
  .then((usersData) => {
    console.log(usersData);
    /** {
     *    users: [
     *      { names: { preferred: 'Pepito' }, contact: {...} },
     *      { names: { preferred: 'Juancho' }, contact: {...} },
     *      { names: { preferred: 'Carlos' }, contact: {...} },
     *    ],
     *    errors: [
     *      {
     *        id: 123456 // user_id
     *        code: 404 // Some error code
     *      }
     *    ]
     *  }
     */
  });
```

</details>

<details>
<summary>Javascript example (CommonJS)</summary>

```js
const { VaultClient } = require('node-vault-client');

const client = new VaultClient('my-integration-token');

// Example versionId
const versionId = 'example-version-id';

// With query object
client.getPIIUserData({
  req, // Express request
  userProperties: {
    names: {
      preferred: true,
    },
    contact: {
      email: {
        address: true,
        verified: true
      },
    },
  }
})
  .then((userData) => {
    // Do something
  });;

// With query as string and version Id
client.getPIIUserData({
  req, // Express request
  versionId,
  userProperties: 'names { preferred } contact { email { address verified } }',
})
  .then((userData) => {
    // Do something
  });

// Promise example with string of desired properties
client.getPIIUsersData({
  userIds: [123456, 987654, 456789],
  userProperties: 'names { preferred } contact { email { address verified } }',
  req, // Express request
})
  .then((usersData) => {
    console.log(usersData);
    /** {
     *    users: [
     *      { names: { preferred: 'Pepito' }, contact: {...} },
     *      { names: { preferred: 'Juancho' }, contact: {...} },
     *      { names: { preferred: 'Carlos' }, contact: {...} },
     *    ],
     *    errors: [
     *      {
     *        id: 123456 // user_id
     *        code: 404 // Some error code
     *      }
     *    ]
     *  }
     */
  });
```

</details>

## Contact

- For questions regarding Vault API, contact [Vault Team](mailto:vault.integration@mercadolibre.com)
- For questions regarding this client, contact [Sessions Security](mailto:sessions_security@mercadolibre.com)

## License

© 2021 Mercado Libre - Account Security - [Sessions Security](mailto:sessions_security@mercadolibre.com)
