const deepMerge = require('./deep-merge');

/**
 * Merge config data setting from global to platform to site any property that doesn't exist
 *
 * @param {object} data - Config Data
 * @returns {object} - Merged config data
 */
const mergeConfiguration = (data) => {
  const globalConfigurations = data.configurations || {};
  const platforms = Object
    .keys(data.platforms || {})
    .reduce((platformHash, platformKey) => {
      const platformData = data.platforms[platformKey];
      const platformConfigurations = deepMerge(globalConfigurations, platformData.configurations || {});

      const sites = Object
        .keys(platformData.sites || {})
        .reduce((sitesHash, siteKey) => {
          sitesHash[siteKey] = deepMerge(platformConfigurations, platformData.sites[siteKey]);
          return sitesHash;
        }, {});

      platformHash[platformKey] = {
        configurations: platformConfigurations,
        sites,
      };
      return platformHash;
    }, {});
  return {
    version: data.version,
    configurations: data.configurations,
    platforms,
  };
};

module.exports = mergeConfiguration;
