# FRONTEND-CONFIG-FACTORY
*A module for create config modules*

Please visit [Getting started](README.md) for a resume of this docs.

# Table of Contents

- [Description](#description)
- [How does it works?](#how-does-it-works-)
  - [Example](#example)
  - [Params used](#params-used)
  - [Data structure](#data-structure)
  - [Returned Methods](#returned-methods)
    - [getValue](#getvalue)
    - [get](#get)
    - [getEnvironment](#getenvironment)
    - [generateBuildFiles](#generatebuildfiles)
    - [addUpdateHandler](#addupdatehandler)
    - [removeUpdateHandler](#removeupdatehandler)
- [Changelog](#changelog)

## Description

This module provides the necessary tools to create an auto-updateable configuration module. This configuration will use the provided data as initial data source and will update it on background once a new release is done.

## How does it works?

Frontend-config-factory exports a single method with an object as param and returns a series of [methods](#returned-methods) to be used by the configuration module or its clients.

### Example

```js
const modulePackage = require('../package.json');

const connection = create({
  data: {
    configurations: { uiNavigationVersion: '5.16.0' },
    platforms: {
      ML: {
        configurations: { uiNavigationVersion: '5.16.5' },
        sites: {
          MLA: { uiNavigationVersion: '5.17.1' },
        },
      },
    },
  },
  modulePackage,
  restClientConfig: {
    timeout: 5000,
    eTagCache: true,
  },
  envVariables: {
    update: 'ML_NAVIGATION_CONFIG_UPDATE',
    loadEnvironmentAtStartUp: 'ML_NAVIGATION_CONFIG_ENVIRONMENTS',
    loadDevelopmentDataAtStartUp: 'ML_NAVIGATION_CONFIG_DEVELOPMENT_DATA',
  },
  update: {
    intervalInMs: 5 * 60 * 1000, // Search config updates in remote file each 5 minutes
    updateStaticFilesOnRelease: true, // Update remote file on release
  },
});
```

### Params used

| Key                                   | type    | Required | Default                              | Description                                                                                                                                                                                                                                          |
| ------------------------------------- | ------- | -------- | ------------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| data                                  | object  | Yes      |                                      | An object containing local config data ([see Data structure](#data-structure))                                                                                                                                                                       |
| modulePackage                         | object  | Yes      |                                      | package.json of the config module that is using frontend-config-factory                                                                                                                                                                              |
| restClientConfig                      | object  | No       | `{ timeout: 3000, eTagCache: true }` | See [frontend-restclient](https://github.com/mercadolibre/fury_frontend-restclient#instance-and-request-config)                                                                                                                                      |
| envVariables                          | object  | No       |                                      | ENV variables used for allow specifics functionalities                                                                                                                                                                                               |
| envVariables.update                   | string  | No       | `[MODULE_NAME]_UPDATES`              | Environment variable name to check if it should (`true` value) or not (`false` value) check for updates. The default behaviour when the variable is not set is to update on fury environments and to do not update in local development environments |
| envVariables.loadEnvironmentAtStartUp | string  | No       | `[MODULE_NAME]_ENVIRONMENTS`         | Environment variable that optionally can contain comma-separated environments to load and module startup (eg: `0.0.1-test-config.1, 0.0.2-test-config.2`). This is useful to avoid test environments lazy loading                                    |
| envVariables.loadDevelopmentDataAtStartUp | string  | No       | `[MODULE_NAME]_DEVELOPMENT_DATA`         | Environment variable that contains the path (relative to the working directory) of a `js` or `json` file that contains development data to load |
| update                                | object  | No       |                                      | Update configuration object                                                                                                                                                                                                                          |
| update.intervalInMs                   | number  | No       | `300000`                             | Determines time interval to wait after trying to update the configuration                                                                                                                                                                            |
| update.environmentHeader              | string  | No       | `null`                               | Determines the header name which its value is used as the preferred environment for get operations                                                                                                                                                   |
| update.updateStaticFilesOnRelease     | boolean | No       | `true`                               | If `false` calling `generateBuildFiles` empties the build folder so no configuration is uploaded to Object Storage service                                                                                                                           |

### Data structure

This module will keep in memory the configuration data that needs to be made available. And for its correct use it must have a particular structure that keeps the data separated in sites, platforms and globally.

Example:

```js
const data = {
  configurations: { uiNavigationVersion: '5.16.0' }, // global configurations object
  platforms: {
    // platforms object
    ML: {
      configurations: { uiNavigationVersion: '5.16.5' }, // Platform specific configurations
      sites: {
        // Sites object from current platform
        MLA: { uiNavigationVersion: '5.17.1' }, // MLA site specific config
        MLU: {}, // MLU site specific config
      },
    },
  },
};
```

This structure allows frontend-config-factory to merge global configurations along platforms and sites, keeping the configuration of sites and platforms as a priority in the case of duplication.

> In the previous example, getting the `uiNavigationVersion` configuration for `ML` platform and `MLA` site will return `"5.17.1"` since it has defined its own value for that platform/site. The same get for the `MLU` site will return `"5.16.5"` despite of being empty becouse the platform contains that value. The same get for the `MP` platform will return `"5.16.0"` since there's a global configuration containing that value. This happens because platforms configurations inherits global configurations and site configurations inherits platforms configurations (and global ones by transitive). **This inheritance is made by making a deep merge on configuration objects (arrays are not merged)**.

### Returned Methods

Creating a connection with frontend-config-factory will return the following methods:

```js
const {
  getValue,
  get,
  getEnvironment,
  generateBuildFiles,
  addUpdateHandler,
  removeUpdateHandler,
} = create(params);
```

#### getValue

Used to get some configuration property. It receives an object with the following characteristics:

| Name        | Type   | Required | Description                                                                                                            |
| ----------- | ------ | -------- | ---------------------------------------------------------------------------------------------------------------------- |
| key         | string | Yes      | Name of the configuration to retrieve                                                                                  |
| platform    | object | No       | Object containing id and siteId e.g. {id: "ML", siteId: "MLA"}                                                         |
| req         | object | No       | Request object. This is used to find platform and site id, and to determine environment if it was provided by a header |
| environment | string | No       | Preferred environment to get the configuration                                                                         |

Example:

```js
const uiNavigationVersionConfiguration = connection.getValue({
  key: 'uiNavigationVersion',
  platform: { id: 'ML', siteId: 'MLA' },
});
```

#### get

The `get` method works in the same way as `getValue`, with the difference of receiving separate parameters as [frontend-config](https://github.com/mercadolibre/fury_frontend-config#readme) does

| Param       | Type   | Required | Description                   |
| ----------- | ------ | -------- | ----------------------------- |
| key         | string | Yes      | Name of the property          |
| platformId  | string | No       | Platform Id of asked property |
| siteId      | string | No       | Site Id of asked property     |
| environment | string | No       | Environment of asked property |

Example:

```js
const uiNavigationVersionConfiguration = connection.get('uiNavigationVersion', 'ML', 'MLA'. '0.1.0-beta.1');
```

#### getEnvironment

Gets the environment defined since the connection was created. Receives a req object to detect version or returns `production` if none was passed.

| Param | Type   | Required | Description            |
| ----- | ------ | -------- | ---------------------- |
| req   | object | No       | Express request object |

Example:

```js
const environment = connection.getEnvironment(req); // 'production'
```

#### generateBuildFiles

The execution of this method makes the configuration file. Despite of non parameters needed, wheter if update or not on a release it depends on the `updateStaticFilesOnRelease` key on the `update` object passed on the function exported by this package. (see [How does it works?](#how-does-it-works))

Example:

```js
// index.js
const configFactory = require('frontend-config-factory');

// calling the method exported by this package and with minimum parameters:
module.exports = configFactory({
  data,
  modulePackage,
});
```

```js
// build.js

const { generateBuildFiles } = require('.');

generateBuildFiles();
```

```jsonc
// package.json
{
  // ...
  "scripts": {
    // ...
    "dist": "node build.js"
    // ...
  }
  // ...
}
```

#### addUpdateHandler

Use `addUpdateHandler` method for trigger some function each time a config is updated.

| Param       | Type     | Required | Default    | Description                                                                                               |
| ----------- | -------- | -------- | ---------- | --------------------------------------------------------------------------------------------------------- |
| handler     | function | Yes      |            | Function to get triggered on a config update                                                              |
| environment | string   | No       | `production` | Determines in which environment should trigger the handler when its config updates |

Example:

```js
meliConfig.addUpdateHandler(handleConfigChange, 'test-config');
```

#### removeUpdateHandler

Use `removeUpdateHandler` method for remove some function previously added with `addUpdateHandler`.

| Param       | Type     | Required | Default    | Description                             |
| ----------- | -------- | -------- | ---------- | --------------------------------------- |
| handler     | function | Yes      |            | Function to get removed                 |
| environment | string   | No       | `production` | Environment where the handler was added |

Example:

```js
meliConfig.removeUpdateHandler(handleConfigChange, 'test-config');
```

## Changelog

We keep changes to our codebase [here](https://github.com/mercadolibre/fury_frontend-config-factory/blob/master/CHANGELOG.md)

## How to contribute

If you see something that isn't right or you're in need of a new feature, please follow this steps to help to resolve it.
* **Create an Issue in the corresponding repository describing the issue**
* **Tell us about it with an email indicating its priority** (this is important since maybe the feature you need has a reason not to exist or maybe someone else is already working on it)
* **Create the PR related to it and notify us**

When you send the pull request, please **do so against the develop branch** and **don't forget to attach the related Issue in the description**.

You'll find a CHANGELOG.md in the module directory, please update it following this format:
```
## Next Release
* [Your PR Title](https://github.com/mercadolibre/fury_frontend-config-factory/pull/<PR number>)
```
