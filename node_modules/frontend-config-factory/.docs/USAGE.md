# Collaborating with a configuration

# Table of Contents
- [Description](#description)
- [Usage](#usage)
- [Contributing](#contributing)

## Description
This documentation is a generic guide on auto-updateable configurations usage and collaboration.

### What does auto-updateable means?
That means that each release updates previous releases configurations data so you don't have to update dependencies in order to get up-to-date data.

Eg.: If some-configuration-module@1.0.0 has the `someKey` configuration with value `1` and get the value for `someKey` the module will return `1`, that's not crazy but if a new some-configuration-module@1.0.1 was released with the `someKey` configuration with value `2` both some-configuration-module@1.0.0 and some-configuration-module@1.0.1 will return `2` for the `someKey` configuration (the module 1.0.0 updates its value with the one from 1.0.1).

## Usage
### getValue
```js
const { getValue } = require('some-configuration-module');

const someValue = getValue({
 key: 'some.nested.key',
});
```

#### `key` parameter
When the key contains words separated by a dot, it will lookup over objects until reach the last word.

Eg:
```
some: {
  nested: {
    key: {
      configuration: 1,
    },
  },
},
```

Getting `some.nested.key` will return the `{ configuration: 1 }` object.

#### `req` parameter
The `req` object is optional but you should pass it if the `getValue` execution is triggered by an incoming request as it is used to generate a rest client context.

#### Specificity
There are three levels of specificity: global, platform, and site configurations.

Platforms configurations inherits global configurations and site configurations inherits platforms configurations (and global ones by transitive). **This inheritance is made by making a deep merge on configuration objects (arrays are not merged)**.

Eg:
Global configuration
```
someKey: {
  someAValue: 'global-value',
  someBValue: 'global-value',
  someCValue: 'global-value',
  someAArray: [
    'global-value-1',
    'global-value-2',
  ],
  someBArray: [
    'global-value-1',
    'global-value-2',
  ],
  someCArray: [
    'global-value-1',
    'global-value-2',
  ],
}
```

ML platform configuration
```
someKey: {
  someBValue: 'platform-value',
  someCValue: 'platform-value',
  someDValue: 'platform-value',
  someBArray: [
    'platform-value',
  ],
  someCArray: [
    'platform-value-1',
    'platform-value-2',
  ],
}
```

ML platform MCO site configuration
```
someKey: {
  someCValue: 'site-value',
  someEValue: 'site-value',
  someCArray: [
    'site-value'
  ],
}
```

```js
const { getValue } = require('some-configuration-module');

const someKeyValue = getValue({
 key: 'someKey',
 platform: {
   id: 'ML',
   siteId: 'MCO',
 },
});
/*
{
  someAValue: 'global-value', // new value from global configuration

  someBValue: 'platform-value', // value overriden by platform configuration

  someCValue: 'site-value', // value overriden by site configuration

  someDValue: 'platform-value', // new value from platform configuration

  someEValue: 'site-value', // new value from site configuration

  someAArray: [ // new value from global configuration
    'global-value-1',
    'global-value-2',
  ],

  someBArray: [ // value overriden by platform configuration
    'platform-value',
  ],

  someCArray: [ // value overriden by site configuration
    'site-value',
  ],
}
*/
```

The platform and site id are taken either from the `req.platform` object or the `platform` parameter. The `id` and `siteId` `platform` parameter properties has priority over the `req.platform` ones.

Eg:

##### Without req and platform
```js
const { getValue } = require('some-configuration-module');

const someKeyValue = getValue({
 key: 'someKey',
});
```
Returns the global configuration.

##### With platform id
```js
const { getValue } = require('some-configuration-module');

const someKeyValue = getValue({
 key: 'someKey',
 platform: {
   id: 'ML',
 },
});
```
Takes the platform from the `platform` parameter, returning the platform configuration.

##### With platform and site ids
```js
const { getValue } = require('some-configuration-module');

const someKeyValue = getValue({
 key: 'someKey',
 platform: {
   id: 'ML',
   siteId: 'MCO',
 },
});
```
Takes the platform and site id from the `platform` parameter, returning the site configuration.

##### With req
```js
const { getValue } = require('some-configuration-module');

const someKeyValue = getValue({
 key: 'someKey',
 req,
});
```
Takes the platform and site id from `req.platform`, returning the site configuration.

##### With req and platform id
```js
const { getValue } = require('some-configuration-module');

const someKeyValue = getValue({
 key: 'someKey',
 platform: {
   id: 'ML',
 },
 req,
});
```
Takes the platform id from the `platform` parameter and site id from `req.platform`, returning the site configuration.

##### With req, platform id, and null site id
```js
const { getValue } = require('some-configuration-module');

const someKeyValue = getValue({
 key: 'someKey',
 platform: {
   id: 'ML',
   siteId: null,
 },
 req,
});
```
Takes the platform id from the `platform` parameter and leaves site id `null`, returning the platform configuration.

##### With req, and null platform and site ids
```js
const { getValue } = require('some-configuration-module');

const someKeyValue = getValue({
 key: 'someKey',
 platform: {
   id: null,
   siteId: null,
 },
 req,
});
```
Leaves platform and site id `null`, returning the global configuration.

#### Environments

##### Test
These configurations support multiple testing environments.

###### Publishing a test environment configuration
The environment is determined on release process by the version number. Productive version numbers with the form `{major}.{minor}.{patch}` ends up in the `production` environment while pre-release version numbers with the form `{major}.{minor}.{patch}-{pre-release}` ends up in the `{major}.{minor}.{patch}-{pre-release}` test environment.

In order to publish a test environment configuration you have create a release following [Fury's Libflow](https://furydocs.io/release-process/4.16.0/guide/#/lang-es/workflows/04_libflow).

###### Getting a test environment configuration
Test environments are lazy, so when getting a configuration from a test environment the module will return a productive configuration first, and when the test environment configuration is get by the instance a few seconds later it will return the test environment configuration. Taken this into account you probably will target a the test scope instead of a productive one as productive scopes has many instances and it's hard to to reach twice the same instance.

The default environment is `production`, there are two ways to get a configuration from a test environment: `req` parameter and explicit `environment` parameter.

Passing the `req` object to the `getValue` function allows you to get a test environment configuration the request contains a `meliLab` cookie with some value and the `x-{name-of-your-configuration}-environment` (eg: `x-ml-navigation-config-environment`) header with the test environment version (eg: `0.0.1-test.1`).

```js
const { getValue } = require('some-configuration-module');

const someKeyValue = getValue({
 key: 'someKey',
 req,
});
```

###### Environment parameter
The `environment` parameter is intended to be used when you have no access to the original incoming request (eg: an API handling request from an application).

```js
const { getValue } = require('some-configuration-module');

const someKeyValue = getValue({
 key: 'someKey',
 environment: '0.0.1-test.1'
});
```

#### get
This function is syntactic sugar over `getValue` in order to be compatible with [`frontend-config`'s `get` method](https://github.com/mercadolibre/fury_frontend-config#configgetkey--platform--site).

Eg:
```js
const { get } = require('some-configuration-module');

const someValue = get('someKey', req.platform.id, req.platform.siteId);
```

#### getEnvironment
This function receives a request object and returns an enviroment key following the [Request header and `meliLab` cookie section](#request-header-and-meliLab-cookie) logic. This method is compatible with `frontend-config`'s `getEnvironment` method.

Eg:
```js
const {
 get,
 getEnvironment,
} = require('some-configuration-module');

const someValue = get('someKey', req.platform.id, req.platform.siteId, getEnvironment(req));
```

#### addUpdateHandler and removeUpdateHandler
This functions allow to attach and remove handlers for environment configuration updates and is compatible with `frontend-config`'s `addUpdateHandler` and `removeUpdateHandler` methods.

Eg:
```js
const {
 addUpdateHandler,
 removeUpdateHandler,
} = require('some-configuration-module');

const handler = () => {
  // do something with new configuration values
  // ...

  removeUpdateHandler(handler, '0.0.1-test.1');
};

addUpdateHandler(handler, '0.0.1-test.1');
```

The second parameter is the environment id, if not passed the `production` environment is used.

#### update
This function resolves when the environment configuration was updated or if the current configuration is already up-to-date.

Eg:
```js
const { update } = require('some-configuration-module');

const someValue = update({
 req, // optional
 environment: '0.0.1-test.1' // optional
}).then(() => {
  // do something with the configuration
});
```

The `req` parameter is optional but you should pass it if the `update` execution was triggered by an incoming request as it is used to generate a rest client context.

The `environment` parameter is optional, if not passed it will try to get it from the `req` object (see the [Request header and `meliLab` cookie section](#request-header-and-meliLab-cookie)) and if it was not found it will default to `production`.

## Contributing
In order to contribute to this library, you should read [this guide](CONTRIBUTING.md) first.