# frontend-mocks

> Simple but flexible mock library that requires zero manual work

## Installation

Install it with npm:

```bash
npm install frontend-mocks
```

## How does it work?

`frontend-mocks` overrides the Node's `http.request` and `https.request`
 functions by adding an interceptor. It should intercept the requests for the
 provided domains and replace the responses with mocked data. If mocked
 data is not present then the request will be proxied to an original domain and
 mock data will be created with content from the proxied response.

- Testing - All tests should run offline, real network requests are not only
 slower but are also prone to fail. Therefore the result of the tests can be 
 wrong due to reasons that are not related to the test rules. Also, remote response
 could be modified in such a way which provokes failures in the tests.
- Development - The required API may not be ready at the moment of 
 development. By changing the local file we can work as if the real API
 exists and avoid slowing down the process of development.


## Usage

Create an instance of mocks and register an interceptor for a required
 domain:

```js
const { Mock } = require('frontend-mocks');
// Or the legacy way
const Mock = require('frontend-mocks');

const mock = Mock(options);
mock.intercept('api.mercadolibre.com');
```

That's all. Most common HTTP clients such as [Axios](https://github.com/mzabriskie/axios)
 or [Superagent](https://github.com/visionmedia/superagent) are using Node's
 http module under the hood. By changing its behaviour we can perform
 mocked requests independently of the HTTP client library.

## Options

- `dir` - A relative or an absolute path to the mocks directory. Default:
 `mocks/${process.env.NODE_ENV}`
- `unsafe` - By default, the module throws an error when it used in a production
 environment. To prevent this to happen set unsafe option with `true`.
 Use this property only if you're really sure of its effect (try to avoid
 it in production), but it can be useful for demos.
- `hashDirname` - Use `false` to avoid the mock's file path hashing for a long values that exceeds 255 symbols. Default: `true`

## Mock files

The name and path of mocked files are **generating automatically** on base of an URL
 and the data. The complete path is constructed by using the next scheme:

```js
`${options.dir}/${method}/${proto}/${host}/${filename}.json`
```

URI path is included in the filename maintaining the structure, e.g. the GET request to
 `https://api.mercadolibre.com/countries/AR` will be saved to
 `mocks/development/get/https/api.mercadolibre.com/countries/AR.json`. Query string
 parameters will be sorted and will be added as part of the filename too, e.g. 
 `/countries/AR?z=1&a=2` will be saved as `/countries/AR?a=2&z=1.json`.

While performing requests that can contain body (like a POST, PUT or PATCH)
 such data will be also concatenated to the file name as a sorted query string.

When the resulting file name exceeds the 250 characters limit, it will
 be shortened to its MD5 checksum. This makes the file harder to search, 
 but enables the storage of greater quantities of data.

The mock files are **always** generated including if there are HTTP or 
 network errors. If you are performing a request to a non-existent domain, it will
 fail without response. But, if there's a registered interceptor for that URL, 
 the mock file will be created containing a generic server error (500).

The mock file has the following structure:
```json
{
  "status": 200,
  "statusText": "OK",
  "headers": {},
  "data": {}
}
```

The entire mock file can be modified. By changing the `status`, you can mock 
 a request with another status code. Headers can be changed
 or added by modifying the `headers` section. To change the response body modify the
 `data` section.

### Multiple responses for repeated requests

Mock files may contain data for multiple responses: on every repeated request at the same url the responses
 will be returned as an array. When the quantity of the requests exceeds the size of the mocked array, 
 there will be a restart from the element at index 0 in the responses.

So for the next mocked file:
```json
[
  {
    "status": 200,
    "statusText": "OK",
    "headers": {},
    "data": "first"
  },
  {
    "status": 200,
    "statusText": "OK",
    "headers": {},
    "data": "second"
  }
]
```

A few repeated requests to the same url will iterate over the array in this manner:
```
GET / -> 200 first
GET / -> 200 second
GET / -> 200 first
```

It may be useful when testing complete flows. For example, on the first request to `/dashboard` the user has no items;
  after publishing some item and returning to `/dashboard` the user should see the published one - this is, same url but
  different result.

## Public API

### `mock.intercept(host[, rules[, transformers]])` - Intercept requests to a specific host by criteria.

It accepts the host parameter, the list of rules and transformers.

#### Intercepting by hostname

When `mock.intercept` is called with no additional rules it will intercept all requests to the indicated host.

```js
// Intercept all requests to https://api.mercadolibre.com 
mock.intercept('https://api.mercadolibre.com');
```

If provided hostname has no `proto` interceptor will be registered for both protocols: `http` and `https`.

```js
// Intercept the requests to https://api.mercadolibre.com  and http://api.mercadolibre.com 
mock.intercept('api.mercadolibre.com');
```

#### Intercepting by path

Normally `path` is a part of `rules` parameter, but when `rules` parameter is a string or an array of strings it will be
 interpreted as `path` o list of `path`s.

```js
// Intercept the requests to https://api.mercadolibre.com/sites/:site
// Matches only requests to /sites/:site and no affects the other requests
// to api.mercadolibre.com
mock.intercept('https://api.mercadolibre.com', '/sites/:site');

// Intercept the requests to api.mercadolibre.com for by matching a a bunch of paths
mock.intercept('api.mercadolibre.com', [
  '/countries/:country',
  '/currency/:currency',
  '/users/*',
]);
```

Please note that `path` has the same format as the express.js router. This means that `'/sites/:site'` will match
 URI `/sites/mla` but not `/sites/mla/alt` o `/sites/alt/mla`. To match entire URI with prefix please use `*` symbol:

```js
// Matches all requests to /sites/mla but not match /sites
// on domain api.mercadolibre.com
mock.intercept('https://api.mercadolibre.com', '/sites/*');

// Matches all requests to /sites/mla including /sites
// on domain api.mercadolibre.com
mock.intercept('https://api.mercadolibre.com', '/sites*');
```

#### Intercepting by query string

Instead of intercepting the entire URL, you can specify the query as an object as a part of the `rules`:

```js
// Intercept the requests to /sites/* URI but only if request contain a query parameter `env` with `dev` as value
mock.intercept('api.mercadolibre.com', {
  path: '/sites/*',
  query: {
    env: 'dev',
  }
});
```

It supports passing a regular expression to query:

```js
// Intercept the requests to /sites/* URI but only if a query parameter `env` contain `dev` or `test`
mock.intercept('api.mercadolibre.com', {
  path: '/sites/*',
  query: {
    env: /(dev|test)/,
  }
});
```

#### Intercepting by headers

Intercepting by headers is very similar to query, just pass an object with headers to `rules` parameter:

```js
// Intercept the requests to /sites/* URI but only if request contain an `Accept-Encoding` header with `gzip` as value
mock.intercept('api.mercadolibre.com', {
  path: '/sites/*',
  headers: {
    'Accept-Encoding': 'gzip',
  },
});
```

`headers` parameter also supports regular expressions:

```js
// Intercept the requests to /sites/* URI but only if request contain an `Accept-Encoding` header that equals to `gzip` or `br`
mock.intercept('api.mercadolibre.com', {
  path: '/sites/*',
  headers: {
    'Accept-Encoding': /^(gzip|br)$/,
  },
});
```

#### Transformers

Every interceptor may contain `transformers` to manipulate the response data and the headers.

The list of available transformers are:

- `transformers.transformResponse` - A function that receives the original response and returns the transformed response.
- `transformers.transformHeaders` - A function that receives the original headers and returns the transformed headers.
- `transformers.ignoreParams` - An array of query string parameters that should be omitted while constructing a mock file name,
  which are useful when some params are dynamic e.g. a timestamp
- `transformers.ignoreData` - An array of body data keys that should be omitted while constructing a mock file name, applicable
  only for `POST`, `PUT` and `PATCH` requests that have a body
- `transformers.includeHeaders` - An array of headers that should be included while constructing a mock file name, which are
  useful to retrieve specific mocks given a unique value (like an `x-caller-id` header)

Examples:

```js
// Intercept the requests to api.mercadolibre.com for both protocols: https and http
// Do not include `uid` param in a mock filename
mock.intercept('api.mercadolibre.com', null, {
  ignoreParams: ['uid'],
});

// Intercept the requests to https://api.mercadolibre.com/countries/*
// And transform the response by adding an additional dynamic data
mock.intercept('https://api.mercadolibre.com', '/countries/*', {
  transformResponse: function(data, req) {
    // Generate an unique id for every mocked request
    data.uuid = uuidv4();
    // Depending on the current request change the user's state
    data.isLoggedIn = !!req.user;

    return data;
  },
});
```

### `mock.restore(host[, routes])` - Remove the interceptors from the provided host
 or selected routes of this host.

Example:

```js
// Restore the requests to https://api.mercadolibre.com, remove all the routes
// but only for https protocol
mock.restore('https://api.mercadolibre.com');

// Restore the requests to api.mercadolibre.com for both protocols https and http
// but only for /users/* route
mock.restore('api.mercadolibre.com', '/users/*');

// Restore the requests to api.mercadolibre.com for https protocol only
// and a specific list of routes
mock.restore('https://api.mercadolibre.com', [
  '/countries/:country',
  '/currency/:currency',
]);
```

## License

© 2016 Mercado Libre
