# Contributing

## Contribution process
Communicate your needs to this module's team as soon as possible in order to align expectatives, coordinate beta and productive releases, and give you some guidance about the contribution process.

## Technical aspects
Navigations are basically a React component with an `id` property and a `prepareToRender` method. In essence, they look something like this:

```jsx
const { getUserName } = require('./pii-service');

const navigation = ({ userName }) => (
  <header>
    ...
    <div>{userName}</div>
    ...
  </header>
  {children}
  <footer>
    ...
  </footer>
);

navigation.prepareToRender = async (props, req, res) => ({
  // ...
  userName: await getUserName(req),
});

navigation.id = 'ML';

module.exports = navigation;
```

### Id
This id can be used by [`frontend-layout`'s `navigationId` configuration](https://nordic.adminml.com/docs/api/Nordic%20Modules/frontend-layout#navigationid).

### Prepare to render method
This method consumes services that brings data needed to render the navigation (eg: `getUserName` that gets the user name from an API), and returns a resolved promise with a hash of data that will be injected as props to the React component.

**IMPORTANT NOTE: The promise should always resolve, otherwise client request will fail**. Try to add as many fallbacks you can to your code so the application continues rendering and user experience does not degrades too much. An example of that could be adding a try/catch block around `getUserName` API call and fallbacking to the user nickname obtained from `req`.

### React component
The exported React component contains header components, the children property that will be fullfilled with the application markup, and footer components. This component receives as props the following data:
 - The prepare to render method result.
 - [The `frontend-layout`'s `navigationOptions` configuration](https://nordic.adminml.com/docs/api/Nordic%20Modules/frontend-layout#navigationoptions).

In order to avoid changing the example application to test different `navigationOptions`, you can pass `navigationOptions` data through development query string params. Regarding `navigationOptions` values, boolean values (eg: `true` and `false` strings on `turnOnKycMessages` configuration) are converted into boolean, object values (eg: `%7B"title"%3A"someTitle"%7D` string on `internal` configuration) are converted into objects, everything else is treated as a string.

#### Configuration
The [`ml-navigation-config`](https://github.com/mercadolibre/fury_ml-navigation-config) module provides configurations for this navigation. The advantage of using this module is that these configurations are updated on each running application with a release of the module. It does not need to update dependencies, create a version, and deploying on each application.

Please read the [Frontend Config Factory documentation](https://furydocs.io/frontend-config-factory/guide/#) in order to know more about maintaining a configuration.

#### CSS
CSS files are placed in the [CSS folder](https://github.com/mercadolibre/fury_ml-web-navigation/tree/master/src/css/entry-points). This folder contains two types of folders:
 - Site-specific CSS folder: This folders contains CSS files for a specific site. Useful when a site needs specific CSS instead of generic one.
 - Default CSS folder: This folder contains CSS files for generic sites. If the request is from a site that not contains a site-specific CSS folder, then these default CSS folder files will be used instead.

The CSS file to render is determined by the [CSS component](https://github.com/mercadolibre/fury_ml-web-navigation/blob/master/src/navigation/css/index.js) depending on request data (eg: mobile or desktop).

**IMPORTANT NOTE:** The development environment will use a local version of the CSS so your changes will be reflected with a browser refresh but creating a productive version of this module does not mean the released CSS will be on production. Please read the [`Release process`](#release-process) section in order to know how to make productive CSS changes.

##### Font icons
This module generates a `navigation` font icon based on SVG files placed in `/src/font-icons`.
Please make sure to follow the `{character}-{class modifier}.svg` naming convention and add the class with the specified modifier and content with the specified character.

Eg:
The `uEA63-live-mobile.svg` file should be used by this CSS:
```css
.nav-icon-live-mobile:before {
  content: '\EA63';
}
```

#### Scripts
##### Inline
Scripts on the [src/navigation/client](https://github.com/mercadolibre/fury_ml-web-navigation/tree/master/src/navigation/client) folder will be transpiled by the dist npm script. In order to get the transpiled content the [`src/utils/read-client-file.js`](https://github.com/mercadolibre/fury_ml-web-navigation/blob/master/src/navigation/utils/read-client-file.js) should be used.

##### Linked
For now, linked scripts code lives in other repositories. A navigation configuration value is used to determine which version of the script will be loaded. Eg: The [`searchBoxVersion`](https://github.com/mercadolibre/fury_ml-navigation-config/blob/1.1.16/config/config.json#L16) configuration value determines the `https://http2.mlstatic.com/ui/searchbox/{searchBoxVersion}/index.js` url.

###### Scripts list
 - [frontend-searchbox](https://github.com/mercadolibre/fury_frontend-searchbox)
 - [messages-plus](https://github.com/mercadolibre/fury_ui-navigation/blob/master/scripts/messages-plus.js)
 - [nav-widget-ml-categories](https://github.com/mercadolibre/fury_nav-widget-ml-categories)
 - [nav-widget-ml-modal-iframe](https://github.com/mercadolibre/fury_nav-widget-ml-modal-iframe)
 - [nav-widget-ml-modeless-box](https://github.com/mercadolibre/fury_nav-widget-ml-modeless-box)
 - [nav-widget-ml-onboarding-cp](https://github.com/mercadolibre/fury_nav-widget-ml-onboarding-cp)
 - [nav-widget-ml-snackbar](https://github.com/mercadolibre/fury_nav-widget-ml-snackbar)
 - [nav-widget-ml-user-menu](https://github.com/mercadolibre/fury_nav-widget-ml-user-menu)

### Environments
#### Local
 - Add `dev.mercadolibre.com.ar` and any other site you want to test to your hosts file pointing to 127.0.0.1
 - Execute `npm run dev` to run the example app
 - Go to https://dev.mercadolibre.com.ar:8443 (or the domain/site you want to test)

#### Fury
If you are pretty sure about your changes, you can create a beta release of this navigation. Once released, in order to test your changes you can pass the navigation to [the `navigation` `frontend-layout` middleware configuration](https://nordic.adminml.com/docs/api/Nordic%20Modules/frontend-layout#middleware-options) in your application.

Example:

```js
const router = require('nordic/ragnar');
const { layoutMiddleware } = require('nordic/layout');

// This module should point to the beta relase so add it to your app package.json file
const myTestNavigation = require('ml-web-navigation');
const myController = require('../some-controller-path');

const routerInstance = router();

router.get(
  '/some-route',
  layoutMiddleware({ navigation: myTestNavigation }, myController)
);

module.exports = router;
```

## Release process
### Markup, services, and inline scripts
Please read the [Libflow](https://furydocs.io/release-process/guide/#/lang-es/workflows/04_libflow) branching model in order to know how is this module's development cycle. `frontend-navigations` uses `^` on this module dependency but even that sometimes npm installs older dependencies with a clean install (eg: navigation releases without the tag `latest`, application dependencies with a navigation, npm registry out-of-date cache, etc), so please notify the Frontend Core team once the navigation is released so they can update the dependency number on `frontend-navigations` in order to ensure the latest version is installed.

### Configurations
Please read the [Frontend Config Factory documentation](https://furydocs.io/frontend-config-factory/guide/#) in order to know more about maintaining a configuration.

If you want to test a configuration change in the example app, you can add values to `/development-server/navigation-configurations/mercado-libre.js`. Please note that this local configuration does not merge global configurations to platform configurations and platform configurations to sites, so make sure to be specific (eg: sites configurations) when adding your data in this file.

If you already released a beta version of the configuration, you can test it running `npm run dev:update-config` and following [this steps](https://furydocs.io/frontend-config-factory/guide/#/?id=remote-on-fury)

### CSS
Navigation CSS can be changed without the need of updating the dependencies on each application. This is done via [the `uiNavigationVersion` configuration](https://github.com/mercadolibre/fury_ml-navigation-config/blob/1.1.16/config/config.json#L5). This value indicates which version of this module contains the navigation CSS that the applications should render.

Please read the [Configurations](#configurations) section in order to know how configurations work.

**IMPORTANT NOTES ON CSS DEPLOYLESS APPROACH**
 - As previous versions of this module can use newer versions of CSS, all **changes on CSS files should be retrocompatible**. Please don't delete code that is needed on previous versions of this module, otherwise applications that use a previous version of this navigation will not receive that CSS and probably will look not as intended.
 - As these changes applies to many frontends, this process should made at night hours (to impact the less possible if something goes wrong) and be previously communicated to NOC creating an event in their calendar.

#### Process
 - Create a release of this module only with CSS changes (not markup).
 - Create a release of the navigation configuration updating the `uiNavigationVersion` value with the released version of this module.
 - Create a release of this module only with markup changes (if needed).

##### Why do we need two releases of this module?
This 3-steps process ensures the applications will never use an updated version of this module with an out-of-date version of the configuration. Let's imagine we create a release of this module with CSS and markup changes and then create a release of the navigation configuration, if someone regenerates the `package-lock.json` file in between these two steps the application will end up with a navigation that contains new markup and a configuration that does not contain CSS changes. You may asking you "but the configuration updates itself right?", right, but there's a time period in between the application bootstraped and the configuration gets updated that the configuration will respond with local data (not updated, without your CSS changes).