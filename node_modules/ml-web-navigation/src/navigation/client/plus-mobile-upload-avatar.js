(function (bus) {
  const pictureUploadInput = document.querySelector('#nav-header-mobile-avatar-upload');
  if (!pictureUploadInput) return;
  const endpoint = document.querySelector('#nav-header-mobile-avatar-form').getAttribute('action');

  const emit = function (event, params) {
    if (!bus || !bus.emit) return;
    bus.emit(event, params);
  };

  // eslint-disable-next-line no-unused-vars
  const hideLoading = function (show) {
    // TODO
  };

  // eslint-disable-next-line no-unused-vars
  const showLoading = function (show) {
    // TODO
  };

  const renderNewImg = function (pictureUrl) {
    const imgElementId = 'nav-header-mobile-user-avatar';
    const currentImg = document.querySelector(`#${imgElementId}`);
    const newImg = document.createElement('img');
    newImg.src = pictureUrl;
    newImg.setAttribute('id', imgElementId);
    currentImg.parentNode.replaceChild(newImg, currentImg);
  };

  const createRequest = function () {
    const xhr = new XMLHttpRequest();
    xhr.open('POST', endpoint, true);
    xhr.onload = function () {
      const res = JSON.parse(xhr.response || xhr.responseText);
      hideLoading();
      if (xhr.status === 200) {
        renderNewImg(res.picture_url);
        emit('snackbar:show', {
          message: res.message,
          type: 'success',
        });
      } else {
        emit('snackbar:show', {
          message: res.message,
          type: 'error',
        });
      }
    };
    xhr.onerror = hideLoading;
    xhr.ontimeout = hideLoading;
    xhr.timeout = 30000; // timeout in milliseconds
    xhr.withCredentials = true;
    xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
    return xhr;
  };

  const postPicture = function () {
    const xhr = createRequest();
    const formData = new FormData();
    const file = pictureUploadInput.files[0];
    formData.append('file', file, file.name);
    xhr.send(formData);
  };

  pictureUploadInput.addEventListener('change', () => {
    if (pictureUploadInput.files.length > 0) {
      showLoading();
      postPicture();
    }
  });
}(window.freya || window.meli));
