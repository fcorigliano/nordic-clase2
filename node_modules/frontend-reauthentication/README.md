# Frontend Reauthentication

## Table of Contents

- [Frontend Reauthentication](#frontend-reauthentication)
  - [Table of Contents](#table-of-contents)
  - [Installation](#installation)
  - [Usage](#usage)
    - [Reauthentication Middleware](#reauthentication-middleware)
      - [Parameters](#parameters)
        - [Middleware Parameters](#middleware-parameters)
        - [Request Parameters](#request-parameters)
        - [Example](#example)
      - [Description](#description)
        - [Usual behaviour](#usual-behaviour)
        - [AJAX behaviour](#ajax-behaviour)
          - [For IFPE regulation with AJAX](#for-ifpe-regulation-with-ajax)
          - [App example handling reauth](#app-example-handling-reauth)
        - [Payment Information](#payment-information)
          - [Payment Reauth Example](#payment-reauth-example)
        - [Regulations](#regulations)
        - [Reauth Validation](#reauth-validation)
        - [Skip reauth for test users](#skip-reauth-for-test-users)
        - [Using Reauthentication API test scope](#using-reauthentication-api-test-scope)
    - [Reauthentication Service](#reauthentication-service)
      - [Service Parameters](#service-parameters)
      - [Service Returned Info](#service-returned-info)
      - [Service Example](#service-example)
  - [Tests](#tests)
  - [Contributing](#contributing)
  - [Changelog](#changelog)
  - [License](#license)

## Installation

```sh
npm install --save frontend-reauthentication
```

## Usage

### Reauthentication Middleware

#### Parameters

##### Middleware Parameters

Parameters accepted when initializing the reauthentication middleware

| Parameter             | Type      | Required | Default     | Description |
|-----------------------|-----------|:--------:|-------------|-------------|
| `operationId`         | `string`  | ✅       |             | A string / key to identify this specific reauthentication. |
| `redirectUrl`         | `string`  |          | `undefined` | Modifies the URL at which the user will be redirected after passing through the reauthentication. The URL used must be a valid ML URI and CANNOT be on the global domain (mercadolibre.com), it must always be a regional domain. |
| ~~`ignoreErrorRedirect`~~ | `boolean` |          | `false`     | Prevent being redirected to error page when reauth fails. If reauth fails, error will be exposed in req.userSession.reauthFailed. *This is deprecated and will be removed in a future release.* |
| `flowType`            | `string`  |          | `'default'` | This value is used only during regulated reauthentications. It is used to specify the type of flow / view this reauth is protecting. Checkouts should use payment value, else there's no need to set anything. |
| `regulatedOnly` | `boolean` |          | `false`     | Call reauth module only when user is regulated and in a regulated site.<br/>Please refer to the [regulations section](#regulations) for more information. |

##### Request Parameters

This parameters are dynamic and should be set for each request. All of them will be used when making the request to the Reauthentication API.

Set this parameters inside the `req.reauthParams` property, as shown in [this example](#payment-reauth-example).

| Parameter     | Type        | Required | Default     | Description |
|---------------|-------------|:--------:|-------------|-------------|
| `regulations` | `string[]`  |          | `undefined` | ⚠️ We recommend using [frontend-regulations](https://furydocs.io/frontend-regulations/guide) plugin to autocomplete this field.<br/>If you MUST override the value, or you are not using that plugin and want to set a regulated reauth manually, use this param. Possible values to pass in the array are `'MLM_IFPE'`, `'MLC_OPERADOR'` and / or `'MLC_EMISOR'`. |
| `payment`     | `object`    | Only in money flows | `undefined` | Payment information for this reauth. More info and examples [here](#payment-information). |

You could also add more parameters not listed here and they will be sent and used by Reauthentication API if necessary.

##### Example

```js
const { reauthMiddleware } = require('frontend-reauthentication');

router.use(reauthMiddleware({
  operationId: 'value',
  // This value can be any string defined by you,
  // it just needs to identify where we are asking the user to reauthenticate.
  // Please contact sessions_security@mercadolibre.com if you have any questions about it,
  // or chat with us at Slack #team-sec360-sessions
});
```

> By default, the user will be asked to reauthenticate with a 2nd Factor Authentication. If you wish to ask only for the password, or password + 2FA, please contact sessions_security@mercadolibre.com to change this behaviour.
>
> Also, by default the user will be asked the reauthenticate if he hasn't reauthenticated in the last 20min. Contact us if you need to change this.

#### Description

> A middleware function to require the user to re-authenticate when necessary.

If the view / flow you are developing is deemed as important in terms of security (change password, money withdraw, etc), chances are you should use reauthentication to verify that the user is really who he claims to be, and not someone that found that account open.

To do this, we must use this reauthentication middleware. This can be done both in the `/server` router which will redirect the user automatically or in the `/api` router which will provide the info needed for you to redirect the user.

##### Usual behaviour

When reauthentication is enabled, **if the user has not proven his identity recently**, there are 2 behaviours:

- If it's an AJAX request you'll receive a JSON with the info needed so you can handle it yourself in the app and do the redirect, read [Ajax Behaviour for detailed information](#ajax-behaviour)
- If the request isn't an AJAX (commonly user accessing a page), the middleware will automatically redirect the user to the login

Once he completes the challenge, he will go back the page he was trying to access, or to the URL specified by the `redirectUrl` parameter.

##### AJAX behaviour

Reauthentication also works with AJAX requests, usually setting up the middleware in your `/api` router. If an AJAX endpoint is protected with reauthentication and the user has to go through the reauth process, then the user will receive a `401` code as a response, along the following JSON response as body:

```json
{
  "require_reauth": true,
  "url": "url_to_send_the_user_to"
}
```

The `url` property will include a redirect to the URL who first made the AJAX request.

###### For IFPE regulation with AJAX

If it's an AJAX request with IFPE regulation, instead of being redirected, you might receive a `403` code as a response if the user has another active session, along the following JSON response as body:

```json
{
  "require_reauth": true,
  "url": "url_to_send_the_user_to"
} 
```

###### App example handling reauth

```js
  const RestClient = require('nordic/restclient');

  const restClient = RestClient({
    baseURL: 'protected/desired/path',
    headers: {
      'X-Requested-With': 'XMLHttpRequest' // IMPORTANT
    }
  });

  restClient.post('more/path', {...})
    .then(() => {...})
    .catch((error) => {
      if (error.response) {

        // Check if error was caused because the user needs to reauthenticate
        if (error.response.data?.require_reauth) {
          const { url } = error.response.data;
          location.assign(url);
        }
      }
    });
```

##### Payment Information

Reauth may be required according to the risk associated with a certain payment transaction, so you can pass that payment info to the reauthentication module and ask the user to reauthenticate accordingly.

Since payment info is dynamic and it changes for each request, that info must be set in `req.reauthParams`.

###### Payment Reauth Example

```js
const Ragnar = require('nordic/ragnar');
const { reauthMiddleware } = require('frontend-reauthentication');

const router = Ragnar.router();

router.use((req, res, next) => {
  // Your code generating or retrieving payment info

  req.reauthParams = {
    payment: {
      // Payment info here
      total_paid_amount: 499.99,
      installments: 1,
      payment_type: 'payment-type',
    },
  };
  next();
});

// Then reauth module will read req.reauthParams with payment info
// to determine if reauthentication is needed for this payment.
router.use(reauthMiddleware({
  operationId: 'some-operation-id',
}));
```

##### Regulations

If you have a regulated page / flow, then we recommend you to use the middleware [frontend-regulations](https://furydocs.io/frontend-regulations/guide). This way frontend-reauthentication will use that data to automatically setup the regulated session.

```js
const regulationsMiddleware = require('frontend-regulations').default;
const { reauthMiddleware } = require('frontend-reauthentication');

const regulations = regulationsMiddleware({
  regulations: ['MLM_IFPE'],
  clientId: 123456789,
});
const reauth = reauthMiddleware({
  operationId: 'some-operation-id',
  flowType: 'other' // Could also be 'payment' for checkouts
  regulatedOnly: true, // Use this if you need reauth only for regulations
});

router.use(regulations); // Fetch user's regulatory information
router.use(reauth); // Read user's regulatory info and send him to regulated reauth
```

For more information we recommend following [this guide](https://meli.workplace.com/notes/it-product-team/regulaci%C3%B3n-ifpe-adecuaci%C3%B3n-para-front-ends/349996512849046/) to implement regulated sessions.

If you need to manually setup frontend-reauthentication to comply with the regulation without using frontend-regulations, use the following example.

```js
const { reauthMiddleware } = require('frontend-reauthentication');

const reauth = reauthMiddleware({
  operationId: 'some-operation-id',
  flowType: 'other' // Could also be 'payment' for checkouts
});

router.use((req, res, next) => {
  if (/* This user is regulated */) {
    req.reauthParams = {
      regulations: ['MLM_IFPE'], 
    };
  }

  reauth(req, res, next);
})
```

This way your frontend will be complying with the rules enforced by the regulator.

##### Reauth Validation

When the user has passed through reauthentication immediately before making this request, then this reauthentication is validated and exposed through the object `req.userSession.reauthChecked`.

- `reauthChecked` (`object`)
  - `transaction_id` (`string`): Reauth transaction ID. Exposed for log and audit purposes

If the user can make this request because he had previously passed through reauthentication and it is deemed unneeded, then `req.userSession.reauthChecked` **is NOT set**.

##### Skip reauth for test users

If you are using a test user and want to skip reauthentication, you can do so by setting the cookie `reauth_dev` with the value `off`.

This will **ONLY** work with test users.

##### Using Reauthentication API test scope

If you wish to make requests against Reauth API's test scope, then set the cookie `reauth_dev` with the `test` value.

### Reauthentication Service

Reauthentication Service is intended to be used when the behaviour of the reauthentication middleware conflicts with out app's behaviour.

This could happen if, for example, our app can't follow a redirect to redirect the user to the reauthentication flow. This is the case for COW which uses iframes when inserted into external webpages.

#### Service Parameters

| Parameter            | Type       | Required | Default     | Description |
|----------------------|------------|:--------:|-------------|-------------|
| `req`                | `Request`  | ✅       |             | Request object with user and traceability info. |
| `params`             | `Object`   | ✅       |             | Reauth parameters object. |
| `params.operationId` | `string`   | ✅       |             | A string / key to identify this specific reauthentication. |
| `params.redirectUrl` | `string`   |          | `undefined` | Modifies the URL at which the user will be redirected after passing through the reauthentication. The URL used must be a valid ML URI and CANNOT be on the global domain (mercadolibre.com), it must always be a regional domain. |
| `params.regulations` | `string[]` |          | `undefined` | If this reauth is requested due to regulations' requirements, you should specify which regulations require this. Possible values to pass in the array are `'MLM_IFPE'`, `'MLC_OPERADOR'` and / or `'MLC_EMISOR'`. |
| `params.flowType`    | `string`   |          | `'default'` | This value is used to specify the type of flow / view this reauth is protecting. Checkouts should use payment value, else there's no need to set anything. |
| `params.payment`     | `object`   | Only in money flows | `undefined` | Payment information for this reauth. More info and examples [here](#payment-information). |

#### Service Returned Info

The service returns a Promise which indicates if user needs to reauthenticate when it resolves, and the URL at which the reauth flow will start.

Promise resolves with no need to reauth:

```js
{
  requireReauth: false // User doesn't need to reauth
}
```

Promise resolves with no need to reauth:

```js
{
  requireReauth: true, // User should reauth
  transactionId: 'example-transaction-id', // Internal reauth ID, useful for audits
  reauthUrl: 'https://www.mercadolibre.com/jms/mla/lgz/authentication/example-transaction-id?go=https%3A%2F%2Fwww.mercadolibre.com.ar%2FredirectUrl&platform_id=ML', // URL users needs to access to start reauth flow
}
```

If there is an error when making the internal request, the promise reject with an [Axios Error](https://github.com/axios/axios#handling-errors).

#### Service Example

```js
const { checkReauthService } = require('frontend-reauthentication');

// req param is the request object.
checkReauthService(req, {
  operationId: 'my-operation-id',
  redirectUrl: 'https://www.mercadolibre.com.ar/custom-url', // Optional param
  flowType: 'payment', // Only for money flows
  payment: { /* payment info */ }, // // Only for money flows
})
  .then((reauthResponse) => {
    if (reauthResponse.requireReauth) {
      // Your code to handle reauth
    } else {
      // There's no need to reauth
    }
  })
  .catch((error) => {
    if (error.response && error.response.status) {
      // Reauth API error
    } else {
      // Probably timeout error
    }
  });
```

## Tests

```sh
npm test
```

## Contributing

In order to contribute to this library, you must read [this guide](CONTRIBUTING.md) first.

## Changelog

We keep changes to our codebase [here](CHANGELOG.md)

## License

© 2021 Mercado Libre - Account Security - [Sessions Security](mailto:sessions_security@mercadolibre.com)
