(function (bus) {
  var pictureUploadInput = document.querySelector('#nav-header-mobile-avatar-upload');
  if (!pictureUploadInput) return;
  var endpoint = document.querySelector('#nav-header-mobile-avatar-form').getAttribute('action');

  var emit = function (event, params) {
    if (!bus || !bus.emit) return;
    bus.emit(event, params);
  };

  // eslint-disable-next-line no-unused-vars
  var hideLoading = function (show) {
    // TODO
  };

  // eslint-disable-next-line no-unused-vars
  var showLoading = function (show) {
    // TODO
  };

  var renderNewImg = function (pictureUrl) {
    var imgElementId = 'nav-header-mobile-user-avatar';
    var currentImg = document.querySelector('#' + imgElementId);
    var newImg = document.createElement('img');
    newImg.src = pictureUrl;
    newImg.setAttribute('id', imgElementId);
    currentImg.parentNode.replaceChild(newImg, currentImg);
  };

  var createRequest = function () {
    var xhr = new XMLHttpRequest();
    xhr.open('POST', endpoint, true);
    xhr.onload = function () {
      var res = JSON.parse(xhr.response || xhr.responseText);
      hideLoading();
      if (xhr.status === 200) {
        renderNewImg(res.picture_url);
        emit('snackbar:show', {
          message: res.message,
          type: 'success'
        });
      } else {
        emit('snackbar:show', {
          message: res.message,
          type: 'error'
        });
      }
    };
    xhr.onerror = hideLoading;
    xhr.ontimeout = hideLoading;
    xhr.timeout = 30000; // timeout in milliseconds
    xhr.withCredentials = true;
    xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
    return xhr;
  };

  var postPicture = function () {
    var xhr = createRequest();
    var formData = new FormData();
    var file = pictureUploadInput.files[0];
    formData.append('file', file, file.name);
    xhr.send(formData);
  };

  pictureUploadInput.addEventListener('change', function () {
    if (pictureUploadInput.files.length > 0) {
      showLoading();
      postPicture();
    }
  });
}(window.freya || window.meli));
