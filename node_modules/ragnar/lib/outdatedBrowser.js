/**
 * Module dependencies
 */
const url = require('url');
const config = require('frontend-config');
const knownPlatform = require('frontend-platform_detection/src/platform'); // eslint-disable-line

/**
 * Redirect to landing if a browser is outdated for MELI
 */
module.exports = function outdatedBrowser(req, res, next) {
  const referer = req.get('Referrer');
  const urlParsed = referer ? url.parse(referer) : {};
  const isKnownReferer = urlParsed.host ? knownPlatform(urlParsed.host) : false;
  const host = req.get('host');

  // Early failure
  if (!req.device || !req.platform || !req.browser || !req.originalUrl || !isKnownReferer || !host) {
    return next();
  }

  const updateBrowserEnabled = config.get('updateBrowser', req.platform.id, req.platform.siteId);

  if (!req.device.pciCompliant && !req.cookies.pciMsgShown) {
    return next();
  }

  if (req.browser.outdated && !req.cookies.ub_skip && updateBrowserEnabled) {
    const path = '/sentry/update-browser?returnUrl=';
    const returnUrl = `https://${host}${req.originalUrl}`;
    const baseUrl = `https:${config.get('url.baseDomain.link', req.platform.id, req.platform.siteId)}`;

    return res.redirect(`${baseUrl}${path}${returnUrl}`);
  }

  return next();
};
