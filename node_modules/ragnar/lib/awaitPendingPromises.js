/* eslint-disable prefer-rest-params */
/** @type {import('express').RequestHandler} */
exports.awaitPendingPromisesHandler = (req, res, next) => {
  // Set req.pendingPromises array as non-writable
  Object.defineProperty(req, 'pendingPromises', { value: [] });

  const { end } = res;
  res.end = function wrappedEnd() {
    if (req.pendingPromises.length > 0) {
      Promise.allSettled(req.pendingPromises).finally(() => {
        end.apply(this, arguments);
      });
    } else {
      end.apply(this, arguments);
    }
  };

  next();
};
