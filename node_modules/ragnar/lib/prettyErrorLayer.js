/**
 * Module dependencies
 */
const { TEST } = require('frontend-env');
const Layer = require('express/lib/router/layer');
const Youch = require('youch');
const log = require('./logger');

/**
 * prettyErrorMiddleware
 */
function prettyErrorMiddleware(err, req, res, next) { // eslint-disable-line
  log.error(err.stack);
  const youch = new Youch(err, req);
  return youch
    .addLink(({ frames }) => {
      const frame = frames[0];
      const url = `/__open-in-editor?file=${encodeURI(frame.filePath)}:${frame.line}:${frame.column}`;
      return `<a href="${url}" target="_blank">Open file in editor</a>`;
    })
    .toHTML()
    .then((html) => {
      const response = html.replace(
        '<div class="error-title">',
        `<div class="error-title">
          <h1 style="font-size: 24px;margin-bottom: 10px;">Nordic Server Error ðŸ’©</h1>`,
      );
      res.status(500).set('Content-Type', 'text/html').send(response);
    });
}

/**
 * prettyErrorLayer
 */
const prettyErrorLayer = new Layer('/', {
  sensitive: false,
  strict: false,
  end: false,
}, prettyErrorMiddleware);

/**
 * Expose prettyErrorLayer
 */
module.exports = prettyErrorLayer;

/**
 * Expose for testing
 */
if (TEST) {
  exports = module.exports; // eslint-disable-line prefer-destructuring
  exports.prettyErrorMiddleware = prettyErrorMiddleware;
}
