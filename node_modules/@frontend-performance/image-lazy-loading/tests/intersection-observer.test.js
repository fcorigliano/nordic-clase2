/**
 * @jest-environment jsdom
 */

const { appendImage, defaults } = require('./utils');
const { IntersectionObserver, IntersectionObserverEntry } = require('./Observers.mock');

describe('InteresctionObserver', () => {
  afterEach(() => {
    const images = document.getElementsByTagName('IMG');

    for (let i = 0; i < images.length; i += 1) {
      const image = images[i];
      image.remove();
    }
  });

  beforeAll(() => {
    Object.assign(window, {
      IntersectionObserver,
      IntersectionObserverEntry,
    });

    require('../src');
  });

  test('single image should change data-src and delete class since there is only one', () => {
    const url = 'http:/url/to/image';

    appendImage({
      classes: [defaults.lazyLoadClassName],
      dataSrc: url,
    });

    window.imageLazyLoading();
    window.lazyImageObserver.triggerIntersection();

    const images = document.getElementsByTagName('IMG');

    for (let i = 0; i < images.length; i += 1) {
      const image = images[i];
      const urlInImage = image.getAttribute(defaults.src);
      const dataSrc = image.getAttribute(defaults.dataSrc);

      expect(urlInImage).toBe(url);
      expect(dataSrc).toBe(null);
      expect(image.classList).toHaveLength(0);
    }
  });

  test('single image should change data-src and delete only the lazyLoadable class since there are more classes', () => {
    const url = 'http:/url/to/image';
    const additionalClass = 'another-class';

    appendImage({
      classes: [defaults.lazyLoadClassName, additionalClass],
      dataSrc: url,
    });

    window.imageLazyLoading();
    window.lazyImageObserver.triggerIntersection();

    const images = document.getElementsByTagName('IMG');

    for (let i = 0; i < images.length; i += 1) {
      const image = images[i];
      const urlInImage = image.getAttribute(defaults.src);
      const dataSrc = image.getAttribute(defaults.dataSrc);

      expect(urlInImage).toBe(url);
      expect(dataSrc).toBe(null);
      expect(image.classList).toHaveLength(1);
      expect(image.classList.item(0)).toBe(additionalClass);
    }
  });

  test('single image should change data-srcset and delete class since there is only one', () => {
    const url = 'http:/url/to/image';

    appendImage({
      classes: [defaults.lazyLoadClassName],
      dataSrcSet: url,
    });

    window.imageLazyLoading();
    window.lazyImageObserver.triggerIntersection();

    const images = document.getElementsByTagName('IMG');

    for (let i = 0; i < images.length; i += 1) {
      const image = images[i];
      const urlInImage = image.getAttribute(defaults.srcSet);
      const dataSrcSet = image.getAttribute(defaults.dataSrcSet);

      expect(urlInImage).toBe(url);
      expect(dataSrcSet).toBe(null);
      expect(image.classList).toHaveLength(0);
    }
  });

  test('multiple images should change data-src and delete class since there is only one', () => {
    const url = 'http:/url/to/image';

    appendImage({
      classes: [defaults.lazyLoadClassName],
      dataSrc: url,
    });

    appendImage({
      classes: [defaults.lazyLoadClassName],
      dataSrc: url,
    });

    window.imageLazyLoading();
    window.lazyImageObserver.triggerIntersection();

    const images = document.getElementsByTagName('IMG');

    for (let i = 0; i < images.length; i += 1) {
      const image = images[i];
      const urlInImage = image.getAttribute(defaults.src);
      const dataSrc = image.getAttribute(defaults.dataSrc);

      if (i % 2 === 0) {
        expect(urlInImage).toBe(url);
        expect(dataSrc).toBe(null);
        expect(image.classList).toHaveLength(0);
      } else {
        expect(urlInImage).toBe(null);
        expect(dataSrc).toBe(url);
        expect(image.classList).toHaveLength(1);
      }
    }
  });
});

