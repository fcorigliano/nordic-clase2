jest.doMock('frontend-env', () => ({
  PRODUCTION: true,
  SCOPE: 'testdevelop-nordic',
}));

const getModule = () => require('.');

const baseRequest = {
  platform: {
    id: 'ML',
    siteId: 'MLA',
  },
  headers: {},
  cookies: {},
};
const baseResponse = {};
const baseParams = {
  type: 'plus',
};

const restClientResult = 'some-user-menu-data';

const timeoutConfig = 1234;

const mockTimeoutConfig = () => {
  const restClientTimeout = jest.fn().mockReturnValue(timeoutConfig);
  jest.doMock('./config', () => ({
    restClientTimeout,
  }));

  const assertTimeoutConfig = () => expect(restClientTimeout).toHaveBeenCalledWith(true);

  return {
    assertTimeoutConfig,
  };
};

const restClientError = {
  stack: 'some-stack',
};

const mockRestClient = ({
  fail,
} = {}) => {
  const get = jest.fn();

  if (fail) {
    get.mockRejectedValue(restClientError);
  } else {
    get.mockResolvedValue({
      data: restClientResult,
    });
  }

  const context = 'some-context';
  const buildRestClientContext = jest.fn().mockReturnValue(context);
  jest.doMock('frontend-restclient/src/build-context', () => buildRestClientContext);

  const restClientMock = jest.fn().mockReturnValue(({ get }));
  jest.doMock('frontend-restclient', () => restClientMock);

  const assertRestClient = ({
    request,
  }) => {
    expect(restClientMock).toHaveBeenCalledWith({
      timeout: timeoutConfig,
      retry: {
        maxRetries: 0,
      },
      logErrors: false,
    });
    expect(get).toHaveBeenCalledWith(`/frontend/sites/${request.platform.siteId}/menu/user`, {
      context,
      params: {
        user_id: request.user.id,
        ...(request.cookies.meliLab
          ? {
            env: 'testdevelop-nordic',
          }
          : {}
        ),
      },
    });
    expect(buildRestClientContext).toHaveBeenCalledWith(request);
  };

  return {
    assertRestClient,
  };
};

const userId = 'some-user-id';

describe('Classifieds - Prepare to Render', () => {
  describe('User Menu Service', () => {
    beforeEach(() => jest.resetModules());

    it('returns the empty information for user menu since there is no user', (done) => {
      const UserMenuService = getModule();

      UserMenuService(baseRequest, baseResponse, baseParams).then((result) => {
        expect(result).toEqual({});
        done();
      });
    });

    it('returns the empty information for user menu since it is not lite or plus', (done) => {
      const UserMenuService = getModule();

      UserMenuService(baseRequest, baseResponse, { type: 'hidden' }).then((result) => {
        expect(result).toEqual({});
        done();
      });
    });

    it('returns the user menu for user', (done) => {
      const request = { ...baseRequest,
        user: {
          id: userId,
        } };

      const { assertTimeoutConfig } = mockTimeoutConfig();
      const { assertRestClient } = mockRestClient();
      const UserMenuService = getModule();

      UserMenuService(request, baseResponse, baseParams).then((result) => {
        expect(result).toBe(restClientResult);
        assertRestClient({ request });
        assertTimeoutConfig();
        done();
      });
    });

    it('returns the empty user menu information since cart api call failed', (done) => {
      const request = { ...baseRequest,
        user: {
          id: userId,
        } };

      const { assertTimeoutConfig } = mockTimeoutConfig();
      const { assertRestClient } = mockRestClient({ fail: true });
      const UserMenuService = getModule();

      UserMenuService(request, baseResponse, baseParams).then((result) => {
        expect(result).toEqual({});
        assertRestClient({ request });
        assertTimeoutConfig();
        done();
      });
    });
    it('returns the empty user menu information from test environment because with melilab and production', (done) => {
      const request = { ...baseRequest,
        user: {
          id: userId,
        },
        cookies: {
          meliLab: 'develop-nordic',
        } };

      const { assertTimeoutConfig } = mockTimeoutConfig();
      const { assertRestClient } = mockRestClient();
      const UserMenuService = getModule();

      UserMenuService(request, baseResponse, baseParams).then((result) => {
        expect(result).toBe(restClientResult);
        assertRestClient({ request });
        assertTimeoutConfig();
        done();
      });
    });
  });
});
