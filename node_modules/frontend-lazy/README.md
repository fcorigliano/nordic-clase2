# frontend-lazy

> Improve your nordic app performance with code-splitting

# Table of Contents
- [Description](#description)
- [Installation](#installation)
- [Usage](#usage)
- [Example](#example)
- [Tests](#tests)
- [Contributing](#contributing)
- [Changelog](#changelog)

## Description

This library contains all the necessary pieces you'd need to do [code-splitting](https://developer.mozilla.org/en-US/docs/Glossary/Code_splitting) within the context of a Nordic app. Please **read [this doc as a guidance](http://nordic.ml.com/docs/code-splitting-1)** on how to analyze the different parts of your app and how to split your app.

Using this will improve the responsiveness of your app, currently measured by metrics [FID (First Input Delay)](https://web.dev/fid/) and [TBT (Total Blocking Time)](https://web.dev/tbt/). [It's not intended to change the UI](#About-advanced-use-cases) of your app.

## API

This module exposes third party modules unwrapped, please read [Usage](#Usage) to learn how to use them within a Nordic app context and then refer back to this API if you need more in-depth knowledge.

The module exposes an object with the following properties: 

  - loadable
    - See [@loadable/component](https://loadable-components.com/docs/api-loadable-component/#loadablecomponent) for more details about its API
  - lazy
    - See [Loadable.lazy](https://loadable-components.com/docs/api-loadable-component/#lazy) for more details about its API
  - loadableReady
    - See [Loadable.loadableReady](https://loadable-components.com/docs/api-loadable-component/#loadableready) for more details about its API
  - [LazyHydrate](https://github.com/hadeeb/react-lazy-hydration#react-lfazy-hydration) 
    - See [LazyHydrate](#lazyhydrate) for more details about its API

### `LazyHydrate`
The module documentation isn't the best so we'll complement it with some more details about the component. Note that you need to use one property. 

| Property | Description | Type | Default | Required specific browser functionality |
| -------- | ----------- | ---- | ------- | -------- |
| `ssrOnly`       | Avoids hydrating on client, use it for static content | boolean | false | none |
| `whenVisible`   | Hydrate when component first enters the viewport, 150px offset | boolean | false | [IntersectionObserver](https://developer.mozilla.org/en-US/docs/Web/API/IntersectionObserver)  |
| `whenIdle`    | Hydrate only when browser is iddle | boolean | false | [requestIdleCallback](https://developer.mozilla.org/en-US/docs/Web/API/Window/requestIdleCallback), otherwise it'll render after 2s |
| `on` | Hydrate on custom events happening in the server rendered area of the component. E.g: `click` | `String|Array.\<String\>` | null | none |

Note: When in doubt, use `whenIdle`

### Internal API

The solution consists of the following pieces:
  - **`/server`** - This is used within Nordic modules and **you shouldn't need to ever use them in your app**
    - **`extractor.js`**: Loadable adapter that allows you to collect used chunks by the app. It integrates Loadable between `frontend-script/bundler` and `frontend-layout`

### Strategies

#### Granular
This is an agressive splitting strategy:
- It creates a `framework` chunk containing react, react-dom, scheduler, prop-types & use-subscription
- It creates a `commons` chunk for modules used across all entry points
- It creates a new chunk for any library greater than 150KB 
- It creates a shared chunk for each library used at least in two components.


## Installation
```
npm install --save frontend-lazy
```

## Usage
Using frontend-lazy is fairly simple.

### Setup 
This steps must only be done only the first time you'll use frontend-lazy

1- **webpack config**: \
If you're using classicPreset then you can skip this step since it's already implemented for you.\
If you weren't then just add the `lazy` block from `frontend-building_blocks` to your webpack config, you can use it [just as any other block](https://github.com/mercadolibre/frontend-building_blocks#group-presets).

2- **babel plugin** \
Add to your babel configuration file (usually `.babelrc`), the new plugin `@loadable/babel-plugin`

```json
{
  "plugins": [
    "@loadable/babel-plugin"
  ],
}
```

### Measure
Before starting, since this is a performance improvement, you must know the current state of your app:
- Check the bundles your app creates and their sizes, you can use WebpackBundleAnalyzer which [is already included in classicPreset](https://github.com/mercadolibre/frontend-building_blocks#params).
- Run tests with [webpagetest.org](https://www.webpagetest.org/) (recommended) and/or lighthouse. Pay close attention to all the metrics.

### Splitting
These are the steps you'll do when splitting a new page

1. **loadable res.render prop**: \
In the `controller` of the page add a new prop to your `res.render()` called `loadable`.Its value is a string of the name of the bundle/entrypoint that that page uses (read below for further info). It'll look like this:

```js
// ./app/pages/my-page/controller.js
exports.render = function render(req, res) {
  const imagesPrefix = config.assets.prefix;
  /**
   * Render View
   */
  res.render(
    View, 
    {
      // ...all your component props...
    },
    {
      layoutOptions: {
        loadable: 'your-bundle-name' // Your page entrypoint
      }
    }
  );
}
```
In case you're not sure what the bundles/entrypoints of the page are:
  - They'll be the bundles generated locally which are used in that component "View" via `<Script src="bundlename.js" />` tags, in this case the entrypoint would be `bundlename`. Check the "View" component to be sure.
  - If you're using the `<Page name={bundlename} />` component in your `View` then one of the values will be the [`Page Name`](https://github.com/mercadolibre/frontend-page#page-name), in this case, `bundlename`.


2. **use loadableReady in the page entrypoint**
Now in those entrypoints add `loadableReady(callback)` and move your `ReactDOM.hydrate` to its callback:
```js
// app/client/my-page.js
const { loadableReady } = require('frontend-lazy');

// ... a lot of code of your app ...

loadableReady(() => {
    ReactDOM.hydrate(...) // Move only your ReactDOM.hydrate here
});
```
This ensures React renders when all components have been fetched.

3. **splitting components and lazy hidration**: \
This is what you'll most commonly use; it allows you to specify which component you want to be splitted from your main bundle. 
Note that knowing which components you should split needs a deep analysis from your team, we recommend you to **read [this doc as a guidance](http://nordic.ml.com/docs/code-splitting-1)** to help you choose what sections to split.

    1. **replace component require** \
Once you want to split a component then just change your classic `require(Component)` to the following:

```js
// ./app/pages/my-page/View.js
const { loadable } = require('frontend-lazy');
const Component = loadable(() => import('../components/Component));
```

  2. **add LazyHydrate** \
In the same file, wrap your component with `LazyHydrate`. Check the [`LazyHydrate`](#lazyhydrate) API to choose its props. 
It'll look like this:
```js
// ./app/pages/my-page/View.js
const { loadable, LazyHydrate } = require('frontend-lazy');
const Component = loadable(() => import('../components/Component));

class View {
  render() {
    return (
      <>
        <LazyHydrate whenIdle>
          <Component />
        </LazyHydrate>
      </>
    )
  }
}
```

### Making sure it works
- Using your browser devtools (cmd + I), check that:
  - New bundle is being downloaded
    Under the Network tab, that your app is fetching new assets with the names of the components that you splitted. Following the example we were using we'd see the following assets being downloaded:
      - `vendor.js`
      - `your-bundle-name.js`
      - `Component.js`   <----- The newly splitted bundle
  - App bundle size decreased: Unless `Component` was too small to make a difference (please **read [this doc as a guidance](http://nordic.ml.com/docs/code-splitting-1)** to learn what to split); you should see a decrease in size in `your-bundle-name`
  - Check the first response, the `html`, that it renders as usual, no pieces of the site should be missing.
- Check there are no weird behaviours on first render and scrolling; you shouldn't see any flickering and everything should work as usual
- Run tests with WPT (WebPageTest.org) and Lighthouse and compare to previous values; FID should have improved

### Compare against previous measurements
Run new tests and check against the measurements you took on [Measurement](#measure) to see how your app improved.

## Notes

Currently we're using Loadable to achieve this; although this could change in the near future (when React "concurrent mode" is available); we recommend you to follow this docs to learn how to implement it instead of Loadable ones, since when this breaking change comes, we can update your project smoothly.

### About advanced use cases
We're currently not intending to change UI behaviour like loading as you scroll or on hover but feel free to try these if your team (including UX) are up for it

## Tests
```npm
npm test
```

## Contributing

In order to contribute to this library, you must read [this guide](https://github.com/mercadolibre/frontend-nordic/blob/master/docs/contributing.md#contributing-guidelines) first.

## Changelog

We keep changes to our codebase [here](CHANGELOG.md)
