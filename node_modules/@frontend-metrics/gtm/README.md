# Frontend GTM

> Mercado Libre Node.js adapter for [Google Tag Manager](https://developers.google.com/tag-manager/quickstart)

The main goal of this module is to build a GTM loader code optimized for performance.

## Installation

```bash
npm install @frontend-metrics/gtm
```

## Usage

To use it within Nordic simply require the component and use it in your view with the [options](#options) you need:

```jsx
const GTM = require('@frontend-metrics/gtm');

const DemoView = (props) => (
  <div>
    <GTM
      id='GTM-XXXXXX'
      dataLayer={[{ foo: 'bar' }]}
    />
  </div>
);
```

You can also specify those [options](#options) in your config file under a siteId (MLA, MLB, etc.) or platformId (ML, MP, etc.):

```js
// ./config/default.json
{
  ML: {
    gtm: { /* use this config if no siteId has GTM specified */
      id: 'GTM-YYYYYY'
    }
    MLA: {
      gtm: { /* use this config only for the MLA  site */
        id: 'GTM-ZZZZZZ'
      }
    }
  }
}
```

_Note:_ The Component props take higher precedence than that of the configuration file. E.g: In the previous example, the `id` would be `GTM-XXXXXX`.

## Options

You can specify them through props or in your config file.

- `id`: `required` - The GTM account ID.
- `dataLayer`: `optional` - An array of key-value pairs that should be passed to the Tag Manager.
- `disabled`: `optional` - A boolean indicating if the GTM should be conditionally disabled.

- This plugin will automagically add the following data to dataLayer when it is available:
  - `user_consent_cookies_advertising` - Possible values are: `true`|`false`. Example: `{ user_consent_cookies_advertising: false }`.

_Note:_ The list of available user's consent categories is dynamic and can be extended at any moment, any new category will be added silently to dataLayer. New categories can be only added, any existing category name never changes.

## Migration Guide

Before creating this component there are at least two ways to include GTM in applications, with its own component or through the deprecated version of frontend-google-tag-manager

### With its own component

1. Identify the views where you are importing it.
2. Import the new component following the steps detailed in the [Usage](#Usage) section.
3. Do a search for the word `googleTagManager` in the configuration files located in the `./config` folder of the application.
4. If you find occurrences:

- make sure that the properties set respect the signature defined in [Options](#options).
- Make sure the `googleTagManager` config isn't inside the `metrics` key, your config should look something like what was shown in [Usage](#Usage)

5. If everything works fine, you can delete the old component itself and import it into the views that used it.

### With the deprecated version of [frontend-google-tag-manager](https://github.com/mercadolibre/frontend-metrics/tree/master/packages/google-tag-manager)

1. Update the old implementation by following the same steps as the previous section: [With its own component](#with-its-own-component).
2. Replace the `const GTM = require('frontend-google-tag-manager/google-tag-manager');` by `const GTM = require('@frontend-metrics/gtm');`
3. Remove the `frontend-google-tag-manager` dependency.
4. If it exists, also remove the `frontend-metrics` dependency.

### Via configuration with the deprecated version of [frontend-metrics](https://github.com/mercadolibre/frontend-metrics/tree/master/packages/metrics)

1. This option was turned on through the application settings, meaning, even when applications did not require the component, GTM would be turned on if the setting was found. Such functionality was removed on this new plugin. Look in the json files located in `./config` if you have the `metrics` property. You should see something like the following:

   ```json
   {
     metrics: {
       googleTagManager: {
         id: 'GTM-123456',
         dataLayer: [{ 'event': 'MY_CUSTOM_EVENT' }]
       },
     },
   },
   ```

2. Delete all the occurrences you find of this property.

## Internal Development

For more information about how this module works please read `@frontend-metrics/core` README.
